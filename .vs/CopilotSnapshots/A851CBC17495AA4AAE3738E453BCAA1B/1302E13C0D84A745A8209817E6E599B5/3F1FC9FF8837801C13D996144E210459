using System.Collections.Generic;
using System.Linq;
using System.Web.Mvc;
using MZDNETWORK.Models;
using MZDNETWORK.Attributes;
using MZDNETWORK.Data; // ApplicationDbContext için ekleniyor
using MZDNETWORK.Data;

namespace MZDNETWORK.Controllers
{
    [DynamicAuthorize(Permission = "Operational.Chat", Action = "Manage")]
    public class ChatGroupController : Controller
    {
        private readonly MZDNETWORKContext _db = new MZDNETWORKContext();

        // Grup listesi
        public ActionResult Index()
        {
            var groups = _db.ChatGroups.Where(g => g.IsActive).ToList();
            return View(groups);
        }

        // Grup oluşturma
        [HttpGet]
        public ActionResult Create()
        {
            ViewBag.Roles = _db.Roles.Where(r => r.IsActive).ToList();
            ViewBag.Users = _db.Users.ToList();
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Create(ChatGroup model, int[] allowedRoleIds, int[] managerIds, int[] memberIds)
        {
            allowedRoleIds = allowedRoleIds ?? new int[0];
            managerIds = managerIds ?? new int[0];
            memberIds = memberIds ?? new int[0];
            if (ModelState.IsValid)
            {
                // Giriş yapan kullanıcıyı bul
                var username = User.Identity.Name;
                var currentUser = _db.Users.FirstOrDefault(u => u.Username == username);
                if (currentUser != null)
                    model.CreatedBy = currentUser.Id;
                else
                    model.CreatedBy = 1; // fallback, sistem kullanıcısı veya hata
                model.CreatedAt = System.DateTime.Now;
                model.IsActive = true;
                model.AllowedRoles = new List<Role>();
                model.Managers = new List<User>();
                model.Members = new List<User>();
                foreach (var role in _db.Roles.Where(r => allowedRoleIds.Contains(r.Id)))
                    model.AllowedRoles.Add(role);
                foreach (var user in _db.Users.Where(u => managerIds.Contains(u.Id)))
                    model.Managers.Add(user);
                foreach (var user in _db.Users.Where(u => memberIds.Contains(u.Id)))
                    model.Members.Add(user);
                _db.ChatGroups.Add(model);
                _db.SaveChanges();
                // ChatGroupMember kayıtları oluştur
                foreach (var userId in memberIds)
                {
                    var canWrite = Request.Form[$"canWrite_{userId}"] == "true";
                    var groupMember = new ChatGroupMember
                    {
                        ChatGroupId = model.Id,
                        UserId = userId,
                        CanWrite = canWrite
                    };
                    _db.ChatGroupMembers.Add(groupMember);
                }
                _db.SaveChanges();
                return RedirectToAction("Index");
            }
            ViewBag.Roles = _db.Roles.Where(r => r.IsActive).ToList();
            ViewBag.Users = _db.Users.ToList();
            return View(model);
        }

        // Grup düzenleme
        [HttpGet]
        public ActionResult Edit(int id)
        {
            var group = _db.ChatGroups.Find(id);
            if (group == null) return HttpNotFound();
            ViewBag.Roles = _db.Roles.Where(r => r.IsActive).ToList();
            ViewBag.Users = _db.Users.ToList();
            // Üyelerin yazma yetkisi
            var memberCanWrite = _db.ChatGroupMembers.Where(m => m.ChatGroupId == id)
                .ToDictionary(m => m.UserId, m => m.CanWrite);
            ViewBag.MemberCanWrite = memberCanWrite;
            return View(group);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Edit(ChatGroup model, int[] allowedRoleIds, int[] managerIds, int[] memberIds)
        {
            allowedRoleIds = allowedRoleIds ?? new int[0];
            managerIds = managerIds ?? new int[0];
            memberIds = memberIds ?? new int[0];
            var group = _db.ChatGroups.Find(model.Id);
            if (group == null) return HttpNotFound();
            if (ModelState.IsValid)
            {
                group.Name = model.Name;
                group.Description = model.Description;
                // Koleksiyonları önce temizle
                group.AllowedRoles.Clear();
                group.Managers.Clear();
                group.Members.Clear();
                // Sonra ekle
                foreach (var role in _db.Roles.Where(r => allowedRoleIds.Contains(r.Id)))
                    group.AllowedRoles.Add(role);
                foreach (var user in _db.Users.Where(u => managerIds.Contains(u.Id)))
                    group.Managers.Add(user);
                foreach (var user in _db.Users.Where(u => memberIds.Contains(u.Id)))
                    group.Members.Add(user);
                // ChatGroupMember güncelle
                var existingMembers = _db.ChatGroupMembers.Where(m => m.ChatGroupId == group.Id).ToList();
                // Silinen üyeleri kaldır
                foreach (var ex in existingMembers)
                {
                    if (!memberIds.Contains(ex.UserId))
                        _db.ChatGroupMembers.Remove(ex);
                }
                // Eklenen veya güncellenen üyeleri işle
                foreach (var userId in memberIds)
                {
                    var canWrite = Request.Form[$"canWrite_{userId}"] == "true";
                    var member = existingMembers.FirstOrDefault(m => m.UserId == userId);
                    if (member == null)
                    {
                        _db.ChatGroupMembers.Add(new ChatGroupMember
                        {
                            ChatGroupId = group.Id,
                            UserId = userId,
                            CanWrite = canWrite
                        });
                    }
                    else
                    {
                        member.CanWrite = canWrite;
                    }
                }
                _db.SaveChanges();
                return RedirectToAction("Index");
            }
            ViewBag.Roles = _db.Roles.Where(r => r.IsActive).ToList();
            ViewBag.Users = _db.Users.ToList();
            // Üyelerin yazma yetkisi
            var memberCanWrite2 = _db.ChatGroupMembers.Where(m => m.ChatGroupId == model.Id)
                .ToDictionary(m => m.UserId, m => m.CanWrite);
            ViewBag.MemberCanWrite = memberCanWrite2;
            return View(model);
        }

        // Grup silme
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Delete(int id)
        {
            var group = _db.ChatGroups.Find(id);
            if (group == null) return HttpNotFound();
            group.IsActive = false;
            _db.SaveChanges();
            return RedirectToAction("Index");
        }
    }
}
