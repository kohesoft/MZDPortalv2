@model IEnumerable<MZDNETWORK.Models.ServiceRoute>
@using System.Linq;
@{
    ViewBag.Title = "Servis Güzergâhları";
    var routeList = Model.ToList();
}
<head>
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
    <link rel="stylesheet" href="~/Content/leaflet.css" />
    <style>
        .map-box{width:100%;height:480px}
    </style>
</head>
<section class="min-h-screen bg-gray-50 p-8 space-y-10">
    <h1 class="text-3xl font-bold mb-6 text-center">Servis Güzergâhları</h1>

    <div class="flex flex-wrap gap-3 mb-6 justify-center">
        @for(int i=0;i<routeList.Count;i++){
            var r = routeList[i];
            <button class="route-btn px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 focus:outline-none"
                    data-kml="@Url.Content(r.KmlPath)" data-title="@r.Title">
                @r.Title
            </button>
        }
    </div>
    <div id="mainMap" class="map-box mx-auto"></div>
</section>

@section scripts{
    <script src="~/Scripts/leaflet.js"></script>
    <script src="~/Scripts/togeojson.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataBounds = L.latLngBounds([[39.728, 32.481], [40.095, 33.008]]);
            const map = L.map('mainMap', {
                maxBounds: dataBounds,
                maxBoundsViscosity: 1.0
            }).fitBounds(dataBounds);

            L.tileLayer('/tile/{z}/{x}/{y}.png', {
                bounds: dataBounds,
                noWrap: true,
                minZoom: 13,
                maxZoom: 16,
                reuseTiles: true,
                attribution: ''
            }).addTo(map);

            let currentLayer = null;

            function loadRoute(kmlUrl){
                if(!kmlUrl) return;
                fetch(kmlUrl)
                    .then(r=>r.text())
                    .then(txt=>{
                        const kmlDom = new DOMParser().parseFromString(txt,'text/xml');
                        const geojson = toGeoJSON.kml(kmlDom);
                        if(currentLayer){
                            map.removeLayer(currentLayer);
                        }
                        currentLayer = L.geoJSON(geojson).addTo(map);
                        map.fitBounds(currentLayer.getBounds());
                    });
            }

            // button click
            document.querySelectorAll('.route-btn').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    loadRoute(btn.dataset.kml);
                });
            });

            // load first route by default
            const firstBtn = document.querySelector('.route-btn');
            if(firstBtn){
                loadRoute(firstBtn.dataset.kml);
            }
        });
    </script>
} 