@model IEnumerable<MZDNETWORK.Models.ServiceRoute>
@using System.Linq;
@{
    ViewBag.Title = "Servis Güzergâhları";
    var routeList = Model.ToList();
}
<head>
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
    <link rel="stylesheet" href="~/Content/leaflet.css" />
    <link rel="stylesheet" href="~/Content/serviceperson.css" />
    <link rel="stylesheet" href="~/Content/serviceroute.css" />
    <style>
        .map-box{width:100%;height:480px}
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<section class="min-h-screen bg-gray-50 p-8 space-y-10">
    <!-- Service Routes Section -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Servis Güzergâhları</h1>

        <div class="flex flex-wrap gap-3 mb-6 justify-center">
            @for(int i=0;i<routeList.Count;i++){
                var r = routeList[i];
                <button class="route-btn px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 focus:outline-none transition-colors duration-200"
                        data-kml="@Url.Content(r.KmlPath)" data-title="@r.Title">
                    @r.Title
                </button>
            }
        </div>
        <div id="mainMap" class="map-box mx-auto rounded-lg shadow-inner"></div>
    </div>

    <!-- Service Personnel Section -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Servis Personeli</h2>
                <p class="text-gray-600 mt-1">Güncel servis personeli bilgileri</p>
            </div>
            <div class="flex gap-3">
                <div class="flex bg-gray-100 rounded-lg p-1">
                    <button id="workHoursBtn" onclick="switchShift('Mesai İçi')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 bg-green-600 text-white">
                        Mesai İçi
                    </button>
                    <button id="afterHoursBtn" onclick="switchShift('Mesai Sonrası')" class="px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 text-gray-600 hover:text-gray-900">
                        Mesai Sonrası
                    </button>
                </div>
                <a href="@Url.Action("Index", "ServicePersonnel")" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 shadow-md hover:shadow-lg text-sm">
                    <span class="mr-1">⚙️</span>Yönetim Paneli
                </a>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-2 rounded-full">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-600">Toplam Personel</p>
                        <p class="text-xl font-bold text-gray-900" id="totalPersonel">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-green-50 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="bg-green-100 p-2 rounded-full">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-600">Aktif Servisler</p>
                        <p class="text-xl font-bold text-gray-900" id="activeServices">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="bg-yellow-100 p-2 rounded-full">
                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-600">Mesai İçi</p>
                        <p class="text-xl font-bold text-gray-900" id="pendingCount">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-purple-50 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="bg-purple-100 p-2 rounded-full">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-600">Mesai Sonrası</p>
                        <p class="text-xl font-bold text-gray-900" id="activeCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Ad, soyad, kullanıcı adı veya servis ara..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                </div>
                <div class="md:w-48">
                    <select id="serviceFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        <option value="">Tüm Servisler</option>
                        <!-- Dynamic options will be loaded here -->
                    </select>
                </div>
                <div class="md:w-48">
                    <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        <option value="">Tüm Durumlar</option>
                        <option value="Aktif">Aktif</option>
                        <option value="Pasif">Pasif</option>
                        <option value="Beklemede">Beklemede</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Service Personnel Cards -->
        <div id="personnelCardsView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Dynamic service personnel cards will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="personnelEmptyState" class="text-center py-12 hidden">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            <h3 class="mt-2 text-lg font-medium text-gray-900">Personel bulunamadı</h3>
            <p class="mt-1 text-sm text-gray-500">Seçilen kriterlere uygun personel kaydı bulunmuyor.</p>
        </div>
    </div>
</section>

@section scripts{
    <script src="~/Scripts/leaflet.js"></script>
    <script src="~/Scripts/togeojson.min.js"></script>
    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
    <script>
        // Service Route Map functionality
        document.addEventListener('DOMContentLoaded', () => {
            const dataBounds = L.latLngBounds([[39.728, 32.481], [40.095, 33.008]]);
            const map = L.map('mainMap', {
                maxBounds: dataBounds,
                maxBoundsViscosity: 1.0
            }).fitBounds(dataBounds);

            L.tileLayer('/tile/{z}/{x}/{y}.png', {
                bounds: dataBounds,
                noWrap: true,
                minZoom: 13,
                maxZoom: 16,
                reuseTiles: true,
                attribution: ''
            }).addTo(map);

            let currentLayer = null;

            function loadRoute(kmlUrl){
                if(!kmlUrl) return;
                fetch(kmlUrl)
                    .then(r=>r.text())
                    .then(txt=>{
                        const kmlDom = new DOMParser().parseFromString(txt,'text/xml');
                        const geojson = toGeoJSON.kml(kmlDom);
                        if(currentLayer){
                            map.removeLayer(currentLayer);
                        }
                        currentLayer = L.geoJSON(geojson).addTo(map);
                        map.fitBounds(currentLayer.getBounds());
                    });
            }

            // button click
            document.querySelectorAll('.route-btn').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    // Remove active class from all buttons
                    document.querySelectorAll('.route-btn').forEach(b => {
                        b.classList.remove('bg-blue-800');
                        b.classList.add('bg-blue-600');
                    });
                    // Add active class to clicked button
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-blue-800');
                    
                    loadRoute(btn.dataset.kml);
                });
            });

            // load first route by default
            const firstBtn = document.querySelector('.route-btn');
            if(firstBtn){
                firstBtn.classList.remove('bg-blue-600');
                firstBtn.classList.add('bg-blue-800');
                loadRoute(firstBtn.dataset.kml);
            }
        });

        // Service Personnel functionality
        let personelData = [];
        let availableServices = [];
        let currentShift = 'Mesai İçi';

        // Initialize personnel section
        $(document).ready(function() {
            loadPersonnelData();
            loadAvailableServices();
            loadStats();
            setupEventListeners();
        });

        function setupEventListeners() {
            $('#searchInput').on('input', performSearch);
            $('#serviceFilter').on('change', performSearch);
            $('#statusFilter').on('change', performSearch);
        }

        // Load personnel data from server
        function loadPersonnelData() {
            $.get('@Url.Action("GetPublicData", "ServicePersonnel")')
                .done(function(response) {
                    if (response.success) {
                        personelData = response.data;
                        renderPersonnelCards();
                    } else {
                        console.error('Error loading personnel data:', response.message);
                        showEmptyState();
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    showEmptyState();
                });
        }

        // Load available services for filter dropdown
        function loadAvailableServices() {
            $.get('@Url.Action("GetPublicServices", "ServicePersonnel")')
                .done(function(response) {
                    if (response.success) {
                        availableServices = response.data;
                        updateServiceFilter();
                    }
                });
        }

        function updateServiceFilter() {
            const filterSelect = $('#serviceFilter');
            filterSelect.find('option:not(:first)').remove();
            
            availableServices.forEach(service => {
                filterSelect.append(`<option value="${service.ServiceCode}">${service.ServiceName}</option>`);
            });
        }

        // Load statistics
        function loadStats() {
            $.get('@Url.Action("GetPublicStats", "ServicePersonnel")')
                .done(function(response) {
                    if (response.success) {
                        updateStatsDisplay(response.data);
                    }
                });
        }

        function updateStatsDisplay(stats) {
            $('#totalPersonel').text(stats.totalPersonnel);
            $('#activeServices').text(stats.activeServices);
            $('#pendingCount').text(stats.workHoursCount); // Mesai İçi count
            $('#activeCount').text(stats.afterHoursCount); // Mesai Sonrası count
        }

        function renderPersonnelCards() {
            const cardsContainer = $('#personnelCardsView');
            const emptyState = $('#personnelEmptyState');
            
            // Filter by current shift and group personnel by service
            const filteredData = personelData.filter(person => person.ShiftType === currentShift);
            
            if (filteredData.length === 0) {
                showEmptyState();
                return;
            }
            
            emptyState.addClass('hidden');
            
            const serviceGroups = {};
            filteredData.forEach(person => {
                const serviceKey = person.Service || person.ServiceCode;
                if (!serviceGroups[serviceKey]) {
                    serviceGroups[serviceKey] = [];
                }
                serviceGroups[serviceKey].push(person);
            });

            // Generate service cards
            const cardsHTML = Object.keys(serviceGroups).map(serviceCode => {
                const personnel = serviceGroups[serviceCode];
                const activeCount = personnel.filter(p => p.Status === 'Aktif').length;
                const serviceConfig = availableServices.find(s => s.ServiceCode === serviceCode);
                const serviceName = serviceConfig ? serviceConfig.ServiceName : (personnel[0].ServiceName || serviceCode);
                
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden fade-in border border-gray-200">
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="p-2 rounded-full ${getServiceIconBg(serviceCode, serviceConfig)}">
                                        ${getServiceIcon(serviceCode, serviceConfig)}
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-lg font-semibold text-gray-900">${serviceName}</h3>
                                        <p class="text-sm text-gray-500">${personnel.length} personel • ${activeCount} aktif</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${personnel.map(person => `
                                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md hover:bg-gray-100 transition-colors duration-150">
                                        <div class="flex items-center">
                                            <div class="h-7 w-7 rounded-full bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-medium">
                                                ${person.FirstName.charAt(0)}${person.LastName.charAt(0)}
                                            </div>
                                            <div class="ml-2">
                                                <p class="text-sm font-medium text-gray-900">${person.FirstName} ${person.LastName}</p>
                                                <p class="text-xs text-gray-500">${person.Username}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(person.Status)}">
                                                ${person.Status}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            cardsContainer.html(cardsHTML);
        }

        function showEmptyState() {
            $('#personnelCardsView').empty();
            $('#personnelEmptyState').removeClass('hidden');
        }

        // Helper functions for styling
        function getServiceIcon(serviceCode, serviceConfig) {
            const icons = {
                'IT': '<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>',
                'HR': '<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>',
                'Finance': '<svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                'Marketing': '<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>',
                'Operations': '<svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>',
                'default': '<svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>'
            };
            return icons[serviceCode] || icons['default'];
        }

        function getServiceIconBg(serviceCode, serviceConfig) {
            const backgrounds = {
                'IT': 'bg-blue-100',
                'HR': 'bg-green-100',
                'Finance': 'bg-yellow-100',
                'Marketing': 'bg-purple-100',
                'Operations': 'bg-gray-100'
            };
            return backgrounds[serviceCode] || 'bg-gray-100';
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'Aktif': 'bg-green-100 text-green-800',
                'Pasif': 'bg-red-100 text-red-800',
                'Beklemede': 'bg-yellow-100 text-yellow-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        // Shift switching function
        function switchShift(shift) {
            currentShift = shift;
            const workBtn = $('#workHoursBtn');
            const afterBtn = $('#afterHoursBtn');

            if (shift === 'Mesai İçi') {
                workBtn.addClass('bg-green-600 text-white').removeClass('text-gray-600 hover:text-gray-900');
                afterBtn.removeClass('bg-green-600 text-white').addClass('text-gray-600 hover:text-gray-900');
            } else {
                afterBtn.addClass('bg-green-600 text-white').removeClass('text-gray-600 hover:text-gray-900');
                workBtn.removeClass('bg-green-600 text-white').addClass('text-gray-600 hover:text-gray-900');
            }

            renderPersonnelCards();
            loadStats();
        }

        // Search functionality
        function performSearch() {
            const searchTerm = $('#searchInput').val();
            const serviceFilter = $('#serviceFilter').val();
            const statusFilter = $('#statusFilter').val();

            $.get('@Url.Action("SearchPublic", "ServicePersonnel")', {
                term: searchTerm,
                service: serviceFilter,
                shiftType: currentShift
            })
            .done(function(response) {
                if (response.success) {
                    personelData = response.data;
                    renderPersonnelCards();
                }
            });
        }
    </script>
}}