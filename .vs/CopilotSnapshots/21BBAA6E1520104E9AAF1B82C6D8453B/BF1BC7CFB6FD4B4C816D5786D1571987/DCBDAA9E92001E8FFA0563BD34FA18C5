// SignalR Connection Manager - Single instance management
(function () {
    'use strict';

    // Check if jQuery and SignalR are available
    if (typeof $ === 'undefined' || typeof $.connection === 'undefined') {
        console.error('jQuery or SignalR not available');
        return;
    }

    window.SignalRManager = window.SignalRManager || {
        connection: null,
        isConnecting: false,
        connectionPromise: null,
        initialized: false,
        
        // Initialize connection if not already done
        init: function() {
            if (this.initialized && this.connection && this.connection.state === $.signalR.connectionState.connected) {
                return Promise.resolve(this.connection);
            }
            
            if (this.isConnecting && this.connectionPromise) {
                return this.connectionPromise;
            }
            
            this.isConnecting = true;
            
            try {
                // Configure connection with optimized settings
                $.connection.hub.connectionSlow(function () {
                    console.log('SignalR connection is slow');
                });
                
                $.connection.hub.reconnecting(function () {
                    console.log('SignalR reconnecting...');
                });
                
                $.connection.hub.reconnected(function () {
                    console.log('SignalR reconnected');
                });
                
                $.connection.hub.disconnected(function () {
                    console.log('SignalR disconnected');
                    SignalRManager.initialized = false;
                    // Auto-reconnect after 5 seconds
                    setTimeout(function() {
                        if ($.connection.hub.state === $.signalR.connectionState.disconnected) {
                            SignalRManager.init();
                        }
                    }, 5000);
                });
                
                // Start connection with optimized transport
                this.connectionPromise = $.connection.hub.start({
                    transport: ['webSockets', 'serverSentEvents', 'longPolling'], // Prefer WebSockets
                    waitForPageLoad: false
                }).done(function () {
                    console.log('SignalR connection established successfully');
                    SignalRManager.connection = $.connection.hub;
                    SignalRManager.isConnecting = false;
                    SignalRManager.initialized = true;
                }).fail(function (error) {
                    console.error('SignalR connection failed:', error);
                    SignalRManager.isConnecting = false;
                    SignalRManager.initialized = false;
                });
                
                return this.connectionPromise;
            } catch (error) {
                console.error('Error initializing SignalR:', error);
                this.isConnecting = false;
                return Promise.reject(error);
            }
        },
        
        // Get current connection state
        getState: function() {
            return this.connection ? this.connection.state : 'disconnected';
        },
        
        // Check if connection is ready
        isReady: function() {
            return this.initialized && this.connection && this.connection.state === $.signalR.connectionState.connected;
        },
        
        // Disconnect and cleanup
        disconnect: function() {
            if (this.connection) {
                this.connection.stop();
                this.connection = null;
                this.isConnecting = false;
                this.connectionPromise = null;
                this.initialized = false;
            }
        }
    };

    // Initialize on page load if jQuery is ready
    if (typeof $ !== 'undefined') {
        $(document).ready(function() {
            // Small delay to ensure all scripts are loaded
            setTimeout(function() {
                if (typeof $.connection !== 'undefined') {
                    SignalRManager.init();
                }
            }, 500);
        });
    }

    // Cleanup on page unload
    $(window).on('beforeunload', function() {
        // Don't disconnect on navigation - reuse connection
        // SignalRManager.disconnect();
    });

})();