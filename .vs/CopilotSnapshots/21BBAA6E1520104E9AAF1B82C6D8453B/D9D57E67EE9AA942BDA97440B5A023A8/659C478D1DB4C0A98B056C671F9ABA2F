using System.Web;
using System;
using System.Web.Mvc;
using System.Web.Optimization;
using System.Web.Routing;
using System.Web.Security;
using NLog;
using Microsoft.Owin;
using Owin;
using WebSocketSharp.Server;
using System.Web.Http;
using MZDNETWORK.Helpers;
using MZDNETWORK.Data;
using OfficeOpenXml;
using Hangfire;
using Hangfire.SqlServer;
using System.Configuration;


[assembly: OwinStartup(typeof(MZDNETWORK.Startup))]

namespace MZDNETWORK
{
    public class MvcApplication : System.Web.HttpApplication
    {
        private static readonly Logger Logger = LogManager.GetCurrentClassLogger();

        protected void Application_Start()
        {
            try
            {
                Logger.Info("Application starting...");
                AreaRegistration.RegisterAllAreas();
                FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);
                RouteConfig.RegisterRoutes(RouteTable.Routes);
                BundleConfig.RegisterBundles(BundleTable.Bundles);

                // EPPlus 5+ gereği lisans bağlamını belirle
                ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

                // **YENİ: Dynamic Permission System Seeding**
                try
                {
                    Logger.Info("Starting database seeding...");
                    MZDNETWORKContext.SeedDatabase();
                    Logger.Info("Database seeding completed successfully");
                }
                catch (Exception ex)
                {
                    Logger.Error(ex, "Database seeding failed");
                    // Production'da bu hata nedeniyle uygulama çökmemeli
                    // Sadece log'a kaydedip devam ediyoruz
                }

                // **YENİ: Overtime Service Scheduler**
                try
                {
                    Logger.Info("Starting recurring job setup with Hangfire...");
                    RecurringJob.AddOrUpdate("daily-overtime-cleanup", () => OvertimeServiceScheduler.ResetOvertimeData(null), Cron.Daily);
                    
                    // **YENİ: Connection Pool Cleanup**
                    RecurringJob.AddOrUpdate("hourly-connection-cleanup", () => ConnectionPoolManager.ClearConnectionPools(), Cron.Hourly);
                    
                    Logger.Info("Recurring job setup with Hangfire completed successfully");
                }
                catch (Exception ex)
                {
                    Logger.Error(ex, "Failed to set up recurring job with Hangfire");
                }
                Logger.Info("Application started successfully.");
            }
            catch (Exception ex)
            {
                Logger.Fatal(ex, "A fatal error occurred during Application_Start, causing the application to shut down.");
                // Uygulamanın çökmesini önlemek için hatayı yutabiliriz,
                // ancak bu genellikle altta yatan ciddi bir sorunu gizler.
                // En azından loglayarak sorunu görünür kılıyoruz.
                throw; // Hatayı yeniden fırlatarak IIS'in durumu bilmesini sağlayın,
                       // bu da olay günlüğüne kaydedilmesine yardımcı olabilir.
            }
        }
      
        protected void Application_AuthenticateRequest(object sender, EventArgs e)
        {
            Logger.Info("Application_AuthenticateRequest called");
            if (HttpContext.Current.User != null && HttpContext.Current.User.Identity.IsAuthenticated)
            {
                var formsIdentity = HttpContext.Current.User.Identity as FormsIdentity;
                if (formsIdentity != null)
                {
                    try
                    {
                        var ticket = formsIdentity.Ticket;
                        var userData = ticket.UserData.Split('|');
                        if (userData.Length >= 2)
                        {
                            var username = userData[0];
                            var userId = userData[1];
                            
                            // Multiple roles desteği için RoleHelper kullan
                            string[] roles;
                            if (int.TryParse(userId, out int userIdInt))
                            {
                                roles = MZDNETWORK.Helpers.RoleHelper.GetUserRoles(userIdInt);
                                if (roles.Length == 0)
                                {
                                    // Backward compatibility - eski userData formatı kontrol et
                                    if (userData.Length >= 3)
                                    {
                                        roles = new[] { userData[2] }; // Eski role format
                                    }
                                    else
                                    {
                                        roles = new[] { "Default" }; // Fallback
                                    }
                                }
                            }
                            else
                            {
                                // Eski format: username|role
                                var role = userData[1];
                                roles = new[] { role };
                            }

                            HttpContext.Current.User = new System.Security.Principal.GenericPrincipal(formsIdentity, roles);
                            Logger.Info($"User authenticated: {username}, Roles: {string.Join(", ", roles)}, IP: {HttpContext.Current.Request.UserHostAddress}, URL: {HttpContext.Current.Request.Url}");
                        }
                        else
                        {
                            Logger.Warn($"Invalid userData format: {ticket.UserData}");
                        }
                    }
                    catch (Exception ex)
                    {
                        Logger.Error(ex, "Error processing authentication ticket");
                    }
                }
                else
                {
                    Logger.Warn("FormsIdentity is null");
                }
            }
            else
            {
                Logger.Warn("User is not authenticated or HttpContext.Current.User is null");
            }
        }

        protected void Application_Error(object sender, EventArgs e)
        {
            Exception exception = Server.GetLastError();
            if (exception != null)
            {
                // Check if it's a SignalR related exception that we can ignore
                if (IsIgnorableException(exception))
                {
                    Logger.Debug(exception, $"Ignorable exception, URL: {HttpContext.Current?.Request?.Url}, User: {HttpContext.Current?.User?.Identity?.Name ?? "Anonymous"}");
                    Server.ClearError(); // Clear the error so it doesn't get logged as unhandled
                    return;
                }

                Logger.Error(exception, $"Unhandled exception, URL: {HttpContext.Current?.Request?.Url}, User: {HttpContext.Current?.User?.Identity?.Name ?? "Anonymous"}");
            }
            else
            {
                Logger.Warn("Exception is null in Application_Error");
            }
        }

        private bool IsIgnorableException(Exception exception)
        {
            if (exception is HttpException httpEx)
            {
                // Ignore client disconnect errors (0x800704CD is ERROR_CONNECTION_ABORTED)
                if (httpEx.ErrorCode == -2147023667) // 0x800704CD
                {
                    return true;
                }
                
                // Ignore other common client-side errors
                if (httpEx.GetHttpCode() == 404 || httpEx.GetHttpCode() == 400)
                {
                    return true;
                }
            }

            // Check if it's a SignalR ping timeout or similar
            if (exception.Message.Contains("ping") || 
                exception.Message.Contains("Connection aborted") ||
                exception.Message.Contains("Uzak ana bilgisayar bağlantıyı kapattı"))
            {
                return true;
            }

            return false;
        }

        protected void Session_Start(object sender, EventArgs e)
        {
            //SessionTracker.Increment();
        }

        protected void Session_End(object sender, EventArgs e)
        {
            //SessionTracker.Decrement();
        }

        protected void Application_BeginRequest(object sender, EventArgs e)
        {
            //MZDNETWORK.Helpers.HourlyRequestCounter.Increment();
        }

        protected void Application_End()
        {
            try
            {
                Logger.Info("Application ending...");
                // OvertimeServiceScheduler.Stop() was here. Hangfire manages its own lifecycle.
            }
            catch (Exception ex)
            {
                Logger.Error(ex, "Error during Application_End");
            }
        }
    }

    public class Startup
    {
        public void Configuration(IAppBuilder app)
        {
            // SignalR configuration with better connection management
            app.MapSignalR("/signalr", new Microsoft.AspNet.SignalR.HubConfiguration()
            {
                EnableDetailedErrors = true,
                EnableJavaScriptProxies = true,
                // Optimize connection settings
                DisconnectTimeout = TimeSpan.FromSeconds(30),
                ConnectionTimeout = TimeSpan.FromSeconds(60),
                KeepAlive = TimeSpan.FromSeconds(20)
            });

            // Configure Hangfire
            var connectionString = ConfigurationManager.ConnectionStrings["MZDNETWORKContext"].ConnectionString;
            Hangfire.GlobalConfiguration.Configuration.UseSqlServerStorage(connectionString, new SqlServerStorageOptions
            {
                CommandBatchMaxTimeout = TimeSpan.FromMinutes(5),
                SlidingInvisibilityTimeout = TimeSpan.FromMinutes(5),
                QueuePollInterval = TimeSpan.Zero,
                UseRecommendedIsolationLevel = true,
                DisableGlobalLocks = true // For SQL Server 2012 or higher
            });

            // Enable Hangfire Dashboard (optional, based on web.config)
            if (ConfigurationManager.AppSettings["Hangfire_Dashboard_Enabled"] == "true")
            {
                app.UseHangfireDashboard("/hangfire");
            }

            // Start Hangfire server
            app.UseHangfireServer();
        }
    }
}
