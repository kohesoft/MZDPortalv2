const Carousel = (() => {
    const getActiveSlide = () =>
        document.querySelector(".carousel__slide.active");
    const getFirstSlide = () =>
        document.querySelector(".carousel__slider")?.firstElementChild || null;
    const getLastSlide = () =>
        document.querySelector(".carousel__slider")?.lastElementChild || null;

    const getSiblingSlide = (slide, direction) => {
        if (!slide) return null;
        return direction === "prev"
            ? slide.previousElementSibling
            : slide.nextElementSibling;
    };

    const getNewActiveSlide = (key, activeSlide) => {
        const actions = {
            Home: getFirstSlide,
            End: getLastSlide,
            ArrowLeft: () => getSiblingSlide(activeSlide, "prev"),
            ArrowRight: () => getSiblingSlide(activeSlide, "next")
        };
        return actions[key]?.() || null;
    };

    const updateScreen = (activeSlide) => {
        if (!activeSlide) return;
        const carouselScreen = document.querySelector(".image-display .screen");
        if (!carouselScreen) return;
        const img = activeSlide.querySelector("img");
        if (img) {
            const clonedImg = img.cloneNode(true);
            carouselScreen.innerHTML = "";
            carouselScreen.appendChild(clonedImg);
        }
    };

    const scrollToActiveSlide = (activeSlide) => {
        if (!activeSlide) return;
        const carouselSlider = document.querySelector(".carousel__slider");
        if (!carouselSlider) return;
        const { offsetLeft, offsetWidth } = activeSlide;
        const { clientWidth } = carouselSlider;

        carouselSlider.scrollTo({
            left: offsetLeft - clientWidth / 2 + offsetWidth / 2,
            behavior: "smooth"
        });
    };

    const updateActiveSlideClass = (activeSlide) => {
        if (!activeSlide) return;
        document
            .querySelectorAll(".carousel__slide.active")
            .forEach((slide) => slide.classList.remove("active"));
        activeSlide.classList.add("active");
    };

    const updateButtonStates = (activeSlide) => {
        const prevButton = document.querySelector(".carousel__btn.prev");
        const nextButton = document.querySelector(".carousel__btn.next");
        if (!prevButton || !nextButton) return;
        const hasPrev = !!getSiblingSlide(activeSlide, "prev");
        const hasNext = !!getSiblingSlide(activeSlide, "next");
        prevButton.disabled = !hasPrev;
        nextButton.disabled = !hasNext;
    };

    const updateCarousel = (activeSlide) => {
        if (!activeSlide) return;
        updateActiveSlideClass(activeSlide);
        updateScreen(activeSlide);
        scrollToActiveSlide(activeSlide);
        updateButtonStates(activeSlide);
    };

    const handleKeydown = (e) => {
        const slider = document.querySelector(".carousel__slider");
        if (!slider || !e.target.closest(".carousel__slider")) return;
        let activeSlide = getActiveSlide() || getFirstSlide();
        if (!activeSlide) return;
        const newActiveSlide = getNewActiveSlide(e.key, activeSlide);
        if (newActiveSlide) {
            e.preventDefault();
            updateCarousel(newActiveSlide);
        }
    };

    const handleButtonClick = (e) => {
        let activeSlide = getActiveSlide() || getFirstSlide();
        if (!activeSlide) return;
        const newActiveSlide = getSiblingSlide(
            activeSlide,
            e.currentTarget.classList.contains("prev") ? "prev" : "next"
        );
        if (newActiveSlide) {
            updateCarousel(newActiveSlide);
        }
    };

    const handleCarouselClick = (e) => {
        const clickedSlide = e.target.closest(".carousel__slide");
        if (clickedSlide) {
            updateCarousel(clickedSlide);
        }
    };

    const initCarousel = () => {
        const carouselSlider = document.querySelector(".carousel__slider");
        const prevButton = document.querySelector(".carousel__btn.prev");
        const nextButton = document.querySelector(".carousel__btn.next");

        if (!carouselSlider) {
            // Carousel yoksa hiçbir şey yapma
            return;
        }

        const firstSlide = getFirstSlide();
        if (firstSlide) {
            updateCarousel(firstSlide);
        }

        document.addEventListener("keydown", handleKeydown);
        carouselSlider.addEventListener("click", handleCarouselClick);

        if (prevButton) prevButton.addEventListener("click", handleButtonClick);
        if (nextButton) nextButton.addEventListener("click", handleButtonClick);

        const slideInterval = 30000; // 30 saniye
        setInterval(() => {
            let activeSlide = getActiveSlide() || getFirstSlide();
            if (!activeSlide) return;
            const nextSlide = getSiblingSlide(activeSlide, "next") || getFirstSlide();
            if (nextSlide) updateCarousel(nextSlide);
        }, slideInterval);
    };

    initCarousel();
})();