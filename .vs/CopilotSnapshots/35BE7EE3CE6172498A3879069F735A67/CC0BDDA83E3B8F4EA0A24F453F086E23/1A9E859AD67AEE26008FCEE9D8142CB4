using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using MZDNETWORK.Models;
using MZDNETWORK.Data;
using MZDNETWORK.Attributes;


namespace MZDNETWORK.Controllers
{
    // Dinamik yetki kontrolü – İnsan Kaynakları Duyuruları
    // Görüntüleme için class seviyesinde View izni yeterli
    [DynamicAuthorize(Permission = "HumanResources.Announcements")]
    public class GonderiController : Controller
    {
        private MZDNETWORKContext db = new MZDNETWORKContext(); // Veritabanı context'i

        // Yeni duyuru oluşturma formu
        [DynamicAuthorize(Permission = "HumanResources.Announcements")]
        public ActionResult GonderiOlustur()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        [ValidateInput(false)]
        [DynamicAuthorize(Permission = "HumanResources.Announcements", Action = "Create")]
        public ActionResult GonderiOlustur(Gonderi model, IEnumerable<HttpPostedFileBase> attachments)
        {
            try
            {
                if (ModelState.IsValid)
                {
                    model.CreatedAt = DateTime.Now; // Kayıt zamanını ayarlayın
                    db.Gonderiler.Add(model); // Gonderiler, veritabanı context'inde Gonderi tablosuna karşılık gelir
                    db.SaveChanges();

                    // Dosya eklerini işle
                    if (attachments != null && attachments.Any(a => a != null && a.ContentLength > 0))
                    {
                        ProcessAttachments(model.Id, attachments);
                    }

                    TempData["Message"] = "Duyuru başarıyla oluşturuldu.";
                    return RedirectToAction("GonderiListele"); // Kayıt başarılı olursa yönlendirilecek sayfa
                }
            }
            catch (Exception ex)
            {
                // Hata mesajını loglayabilir veya kullanıcıya gösterebilirsiniz
                ModelState.AddModelError("", "Bir hata oluştu: " + ex.Message);
            }

            return View(model);
        }

        // Dosya eklerini işleme metodu
        private void ProcessAttachments(int gonderiId, IEnumerable<HttpPostedFileBase> attachments)
        {
            var uploadsPath = Server.MapPath("~/Uploads/Announcements");
            if (!Directory.Exists(uploadsPath))
                Directory.CreateDirectory(uploadsPath);

            foreach (var file in attachments.Where(f => f != null && f.ContentLength > 0))
            {
                // Güvenli dosya adı oluştur
                var originalFileName = Path.GetFileName(file.FileName);
                var fileExtension = Path.GetExtension(originalFileName);
                var safeFileName = $"{Guid.NewGuid()}{fileExtension}";
                var filePath = Path.Combine(uploadsPath, safeFileName);

                // Dosyayı kaydet
                file.SaveAs(filePath);

                // Veritabanına kaydet
                var gonderiEk = new GonderiEk
                {
                    GonderiId = gonderiId,
                    FileName = safeFileName,
                    OriginalFileName = originalFileName,
                    FilePath = $"~/Uploads/Announcements/{safeFileName}",
                    FileType = file.ContentType,
                    FileSize = file.ContentLength,
                    UploadedAt = DateTime.Now,
                    IsActive = true
                };

                db.GonderiEkler.Add(gonderiEk);
            }
            db.SaveChanges();
        }

        // Dosya indirme
        [DynamicAuthorize(Permission = "HumanResources.Announcements")]
        public ActionResult DownloadFile(int id)
        {
            var attachment = db.GonderiEkler.Find(id);
            if (attachment == null || !attachment.IsActive)
            {
                return HttpNotFound("Dosya bulunamadı.");
            }

            var filePath = Server.MapPath(attachment.FilePath);
            if (!System.IO.File.Exists(filePath))
            {
                return HttpNotFound("Fiziksel dosya bulunamadı.");
            }

            // İndirme sayısını artır
            attachment.DownloadCount++;
            db.SaveChanges();

            return File(filePath, "application/octet-stream", attachment.OriginalFileName);
        }

        // Dosyayı görüntüleme (resimler için)
        [DynamicAuthorize(Permission = "HumanResources.Announcements")]
        public ActionResult ViewFile(int id)
        {
            var attachment = db.GonderiEkler.Find(id);
            if (attachment == null || !attachment.IsActive)
            {
                return HttpNotFound("Dosya bulunamadı.");
            }

            var filePath = Server.MapPath(attachment.FilePath);
            if (!System.IO.File.Exists(filePath))
            {
                return HttpNotFound("Fiziksel dosya bulunamadı.");
            }

            return File(filePath, attachment.FileType, attachment.OriginalFileName);
        }

        // Duyuru listeleme
        [DynamicAuthorize(Permission = "HumanResources.Announcements")]
        public ActionResult GonderiListele()
        {
            var gonderiler = db.Gonderiler.Include("Ekler").OrderByDescending(g => g.CreatedAt).ToList();
            return View(gonderiler);
        }

        // Duyuru detayı
        [DynamicAuthorize(Permission = "HumanResources.Announcements")]
        public ActionResult GonderiDetay(int id)
        {
            var gonderi = db.Gonderiler.Include("Ekler").FirstOrDefault(g => g.Id == id);
            if (gonderi == null)
            {
                return HttpNotFound();
            }
            return View(gonderi);
        }

        // Duyuru silme – onay sayfası
        [DynamicAuthorize(Permission = "HumanResources.Announcements", Action = "Delete")]
        [HttpGet]
        public ActionResult GonderiSil(int id)
        {
            var gonderi = db.Gonderiler.Find(id);
            if (gonderi == null)
            {
                return HttpNotFound();
            }
            return View(gonderi);
        }

        [HttpPost, ActionName("GonderiSil")]
        [ValidateAntiForgeryToken]
        [DynamicAuthorize(Permission = "HumanResources.Announcements", Action = "Delete")]
        public ActionResult GonderiSilConfirmed(int id)
        {
            var gonderi = db.Gonderiler.Include("Ekler").FirstOrDefault(g => g.Id == id);
            if (gonderi != null)
            {
                // Fiziksel dosyaları sil
                foreach (var ek in gonderi.Ekler)
                {
                    var filePath = Server.MapPath(ek.FilePath);
                    if (System.IO.File.Exists(filePath))
                    {
                        System.IO.File.Delete(filePath);
                    }
                }

                db.Gonderiler.Remove(gonderi);
                db.SaveChanges();
                TempData["Message"] = "Duyuru ve ekleri başarıyla silindi.";
            }
            return RedirectToAction("GonderiListele");
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                db.Dispose();
            }
            base.Dispose(disposing);
        }
    }
}
