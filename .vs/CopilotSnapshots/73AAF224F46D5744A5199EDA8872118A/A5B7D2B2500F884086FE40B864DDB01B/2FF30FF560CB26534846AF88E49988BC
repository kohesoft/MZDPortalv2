@model MZDNETWORK.Controllers.RoleOrganizationViewModel
@{
    ViewBag.Title = "Kullanıcı Rol Yönetimi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid p-6">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-slate-800"><i class="bx bx-user-check mr-2"></i>Kullanıcı Rol Yönetimi</h1>
    </div>

    <!-- Debug Console -->
    <div id="debugConsole" class="bg-gray-900 text-green-400 text-xs p-2 rounded mb-4 max-h-32 overflow-y-auto" style="display: none;">
        <div class="font-bold">Debug Console:</div>
        <div id="debugMessages"></div>
    </div>

    <!-- Cache Status Panel -->
    <div id="cacheStatus" class="bg-blue-50 border border-blue-200 text-blue-800 text-xs p-3 rounded mb-4" style="display: none;">
        <div class="font-bold mb-2">Cache Status:</div>
        <div id="cacheInfo">Cache bilgileri yükleniyor...</div>
        <button id="clearCacheBtn" class="mt-2 px-2 py-1 bg-red-500 text-white text-xs rounded">Clear All Cache</button>
        <button id="refreshCacheBtn" class="mt-2 px-2 py-1 bg-blue-500 text-white text-xs rounded">Refresh Cache Info</button>
    </div>

    <!-- Toggle Buttons -->
    <div class="mb-4 space-x-2">
        <button id="toggleDebug" class="px-3 py-1 bg-gray-600 text-white text-xs rounded">Toggle Debug</button>
        <button id="toggleCache" class="px-3 py-1 bg-blue-600 text-white text-xs rounded">Toggle Cache Info</button>
    </div>

    <div class="mb-6" id="roleStatsBox">
        <h2 class="text-xl font-semibold text-slate-800 mb-4">Rol İstatistikleri</h2>
        <span id="statsLoading" class="ml-3 text-gray-600">İstatistikler yükleniyor... <span id="statsPercent">0%</span></span>
        <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>

    <div class="bg-white rounded-xl shadow border border-slate-200 p-6">
        <h2 class="text-xl font-semibold text-slate-800 mb-4">Kullanıcılar</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-sm font-medium text-slate-600">Kullanıcı</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-slate-600">Roller</th>
                        <th class="px-4 py-2"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    @foreach (var user in Model.Users)
                    {
                        var userRoleNames = user.UserRoles?.Select(ur => ur.Role.Name).ToList() ?? new List<string>();
                        <tr>
                            <td class="px-4 py-3 whitespace-nowrap">@user.Name @user.Surname<br><span class="text-xs text-slate-500">@user.Username</span></td>
                            <td class="px-4 py-3">
                                @if (userRoleNames.Any())
                                {
                                    <span>@string.Join(", ", userRoleNames)</span>
                                }
                                else
                                {
                                    <span class="italic text-slate-400">Rol atanmadı</span>
                                }
                            </td>
                            <td class="px-4 py-3 text-right">
                                <button class="open-role-btn"
                                        data-userid="@user.Id"
                                        data-fullname="@Html.AttributeEncode(user.Name + " " + user.Surname)"
                                        data-roles='@Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(userRoleNames))'>
                                    <i class="bx bx-edit"></i> Düzenle
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Role Modal -->
<div id="roleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-lg max-w-lg w-full">
            <div class="p-6 border-b border-slate-200 flex items-center justify-between">
                <h3 id="modalTitle" class="text-xl font-bold text-slate-800">Rolleri Düzenle</h3>
                <button onclick="closeRoleModal()" class="text-slate-400 hover:text-slate-600"><i class='bx bx-x text-2xl'></i></button>
            </div>
            <div class="p-6" style="max-height:80vh; overflow:auto;">
                <form id="roleAssignForm" class="space-y-4">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="modalUserId" />
                    <div id="rolesCheckboxes" class="grid grid-cols-2 gap-3">
                        @foreach (var role in Model.Roles)
                        {
                            <label class="flex items-center space-x-2 border border-slate-200 rounded-lg p-3 hover:bg-slate-50 cursor-pointer">
                                <input type="checkbox" class="role-checkbox h-4 w-4" value="@role.Name" />
                                <span class="text-sm">@role.Name</span>
                            </label>
                        }
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeRoleModal()" class="flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">İptal</button>
                        <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Debug functions
function debugLog(message) {
    console.log('[DEBUG] ' + message);
    const debugMessages = document.getElementById('debugMessages');
    if (debugMessages) {
        debugMessages.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        debugMessages.scrollTop = debugMessages.scrollHeight;
    }
}

function openRoleModal(userId, userName, existingRoles) {
    debugLog(`Opening modal for user ${userId} (${userName}) with roles: ${JSON.stringify(existingRoles)}`);
    
    $('#modalTitle').text(userName + ' - Rolleri Düzenle');
    $('#modalUserId').val(userId);

    // Tüm checkleri temizle
    $('.role-checkbox').prop('checked', false);

    // Var olan rolleri işaretle
    if (existingRoles && Array.isArray(existingRoles)) {
        existingRoles.forEach(function(r) {
            debugLog(`Marking role as checked: ${r}`);
            $('.role-checkbox[value="' + r + '"]').prop('checked', true);
        });
    }

    $('#roleModal').removeClass('hidden');
}

function closeRoleModal() {
    debugLog('Closing role modal');
    $('#roleModal').addClass('hidden');
}

$('#roleAssignForm').on('submit', function(e) {
    e.preventDefault();

    var userId = $('#modalUserId').val();
    var selected = $('.role-checkbox:checked').map(function() { return $(this).val(); }).get();
    var token = $('input[name="__RequestVerificationToken"]').val();

    debugLog(`Submitting role update: UserId=${userId}, SelectedRoles=[${selected.join(', ')}]`);

    // Loading state
    const submitBtn = $(this).find('button[type="submit"]');
    const originalText = submitBtn.text();
    submitBtn.text('Kaydediliyor...').prop('disabled', true);

    $.ajax({
        url: '@Url.Action("BulkUpdateUserRoles", "RoleOrganization")',
        type: 'POST',
        traditional: true,
        data: { 
            __RequestVerificationToken: token, 
            userId: userId, 
            selectedRoles: selected 
        },
        success: function(response, textStatus, xhr) {
            debugLog(`Role update successful: ${textStatus}, Status: ${xhr.status}`);
            
            // Check if the response contains error messages in TempData
            if (xhr.responseText && xhr.responseText.includes('ErrorMessage')) {
                debugLog('Warning: Response might contain error messages');
            }
            
            location.reload();
        },
        error: function(xhr, textStatus, errorThrown) {
            debugLog(`Role update failed: ${textStatus}, Error: ${errorThrown}, Status: ${xhr.status}`);
            debugLog(`Response text: ${xhr.responseText}`);
            
            alert('Rol güncellemesi başarısız: ' + textStatus + ' - ' + errorThrown);
            
            // Reset button
            submitBtn.text(originalText).prop('disabled', false);
        },
        complete: function() {
            debugLog('Role update request completed');
        }
    });
});

// Debug toggle
$('#toggleDebug').click(function() {
    $('#debugConsole').toggle();
});

// Cache toggle
$('#toggleCache').click(function() {
    $('#cacheStatus').toggle();
    if ($('#cacheStatus').is(':visible')) {
        loadCacheInfo();
    }
});

// Clear cache
$('#clearCacheBtn').click(function() {
    debugLog('Clearing all permission cache...');
    $.post('/TestPermission/ClearAllCache')
        .done(function(response) {
            debugLog('Cache cleared successfully');
            $('#cacheInfo').html('<span class="text-green-600">Cache cleared successfully at ' + new Date().toLocaleTimeString() + '</span>');
            setTimeout(loadCacheInfo, 1000);
        })
        .fail(function() {
            debugLog('Failed to clear cache');
            $('#cacheInfo').html('<span class="text-red-600">Failed to clear cache</span>');
        });
});

// Refresh cache info
$('#refreshCacheBtn').click(function() {
    loadCacheInfo();
});

// Load cache information
function loadCacheInfo() {
    debugLog('Loading cache information...');
    $.get('/TestPermission/GetCacheInfo')
        .done(function(data) {
            var html = '<div class="grid grid-cols-2 gap-2 text-xs">';
            if (data.error) {
                html += '<div class="col-span-2 text-red-600">Error: ' + data.error + '</div>';
            } else {
                html += '<div><strong>Valid Caches:</strong> ' + (data.TotalValidCaches || 0) + '</div>';
                html += '<div><strong>Total Size:</strong> ' + (data.TotalSizeKB || 0).toFixed(2) + ' KB</div>';
                html += '<div><strong>Avg Hit Count:</strong> ' + (data.AverageHitCount || 0).toFixed(1) + '</div>';
                html += '<div><strong>Most Accessed User:</strong> ' + (data.MostAccessedUser || 'N/A') + '</div>';
                if (data.OldestCache) {
                    html += '<div><strong>Oldest Cache:</strong> ' + new Date(data.OldestCache).toLocaleString() + '</div>';
                }
                if (data.NewestCache) {
                    html += '<div><strong>Newest Cache:</strong> ' + new Date(data.NewestCache).toLocaleString() + '</div>';
                }
            }
            html += '</div>';
            $('#cacheInfo').html(html);
        })
        .fail(function() {
            $('#cacheInfo').html('<span class="text-red-600">Failed to load cache info</span>');
        });
}

// -------- Kullanıcı Arama/Filtre ---------
$(document).ready(function () {
    debugLog('Document ready, initializing...');
    
    // Arama kutusu ekle
    var searchBox = $('<input/>', {
        id: 'userSearchBox',
        type: 'text',
        placeholder: 'Kullanıcı Ara...',
        'class': 'mb-4 p-2 border border-slate-300 rounded-lg w-full md:w-1/3'
    });
    $(searchBox).insertBefore($('.bg-white.rounded-xl.shadow'));

    // Filtre logic
    $('#userSearchBox').on('input', function () {
        var term = $(this).val().toLowerCase();
        $('tbody tr').each(function () {
            var haystack = $(this).text().toLowerCase();
            $(this).toggle(haystack.indexOf(term) > -1);
        });
    });
});

$(document).on('click', '.open-role-btn', function () {
    const $btn   = $(this);
    const id     = $btn.data('userid');
    const name   = $btn.data('fullname');
    const roles  = $btn.data('roles');   // JSON.parse gerekmez, Razor zaten dizi yazdı
    debugLog(`Role button clicked: ID=${id}, Name=${name}, Roles=${JSON.stringify(roles)}`);
    openRoleModal(id, name, roles);
});

// ---------- İstatistikler ----------
var percent=0;
var pctTimer=setInterval(function(){percent=Math.min(percent+5,90);$('#statsPercent').text(percent+'%');},500);

$.get('@Url.Action("GetRoleStatistics", "RoleOrganization")')
    .done(function(data){
        debugLog(`Statistics loaded: ${JSON.stringify(data)}`);
        clearInterval(pctTimer);
        $('#statsLoading').remove();
        var $box = $('#statsContainer');
        if(!data || Object.keys(data).length===0){
            $box.append('<p class="text-slate-500">İstatistik bulunamadı</p>');
            return;
        }
        $.each(data,function(role,count){
            var card = '<div class="p-4 bg-white shadow border border-slate-200 rounded-lg flex items-center justify-between">'
                + '<span class="font-medium text-slate-700">'+role+'</span>'
                + '<span class="text-xl font-bold text-blue-600">'+count+'</span>'
                + '</div>';
            $box.append(card);
        });
    })
    .fail(function(xhr, textStatus, errorThrown){
        debugLog(`Statistics loading failed: ${textStatus} - ${errorThrown}`);
        clearInterval(pctTimer);
        $('#statsLoading').text('İstatistikler yüklenemedi');
    });

// Page load debug
debugLog('RoleOrganization page loaded successfully');
</script>