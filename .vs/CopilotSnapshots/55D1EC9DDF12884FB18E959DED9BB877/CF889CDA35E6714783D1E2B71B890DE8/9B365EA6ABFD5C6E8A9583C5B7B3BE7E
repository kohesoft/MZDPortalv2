@model IEnumerable<MZDNETWORK.Models.ChatGroup>
@{
    ViewBag.Title = "Sohbet";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section styles {
    <style>
        body.sohbet-page {
            background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 100%) !important;
        }
        .modern-chat-container {
            margin-left: 260px;
            min-width: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }
        .modern-chat-box {
            display: flex;
            width: 90vw;
            max-width: 1200px;
            height: 80vh;
            min-height: 600px;
            background: #fff;
            border-radius: 2rem;
            box-shadow: 0 8px 32px rgba(60,72,100,0.18);
            overflow: hidden;
        }
        .modern-chat-sidebar {
            width: 320px;
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            padding: 2rem 1.2rem 1.2rem 1.2rem;
            gap: 1.5rem;
        }
        .modern-chat-sidebar h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            letter-spacing: 0.02em;
        }
        .modern-chat-group-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .modern-chat-group-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255,255,255,0.08);
            border-radius: 1rem;
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s;
            border: 2px solid transparent;
        }
        .modern-chat-group-item.selected, .modern-chat-group-item:hover {
            background: #fff;
            color: #6366f1;
            border-color: #6366f1;
            box-shadow: 0 2px 8px rgba(99,102,241,0.08);
        }
        .modern-chat-group-avatar {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            box-shadow: 0 2px 8px rgba(99,102,241,0.12);
        }
        .modern-chat-group-info {
            flex: 1;
            min-width: 0;
        }
        .modern-chat-group-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            color: inherit;
        }
        .modern-chat-group-info p {
            font-size: 0.9rem;
            color: #e0e7ff;
            margin: 0.2rem 0 0 0;
        }
        .modern-chat-sidebar-footer {
            font-size: 0.95rem;
            color: #e0e7ff;
            margin-top: 1rem;
            text-align: center;
        }
        .modern-chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8fafc;
        }
        .modern-chat-header {
            padding: 1.5rem 2rem 1rem 2rem;
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-height: 80px;
        }
        .modern-chat-header-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
        }
        .modern-chat-header-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #3730a3;
        }
        .modern-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 2rem 1rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.1rem;
        }
        .modern-chat-message-row {
            display: flex;
            align-items: flex-end;
        }
        .modern-chat-message-row.me {
            justify-content: flex-end;
        }
        .modern-chat-message-bubble {
            max-width: 60%;
            padding: 1rem 1.3rem;
            border-radius: 1.5rem;
            background: #fff;
            color: #3730a3;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(60,72,100,0.08);
            position: relative;
        }
        .modern-chat-message-row.me .modern-chat-message-bubble {
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            color: #fff;
        }
        .modern-chat-message-meta {
            font-size: 0.85rem;
            color: #a5b4fc;
            margin-top: 0.3rem;
            text-align: right;
        }
        .modern-chat-message-row.me .modern-chat-message-meta {
            color: #e0e7ff;
        }
        .modern-chat-input-bar {
            background: #fff;
            padding: 1.2rem 2rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .modern-chat-input {
            flex: 1;
            border: none;
            background: #f3f4f6;
            border-radius: 2rem;
            padding: 0.9rem 1.3rem;
            font-size: 1rem;
            outline: none;
            transition: box-shadow 0.18s;
        }
        .modern-chat-input:focus {
            box-shadow: 0 0 0 2px #6366f1;
        }
        .modern-chat-send-btn {
            background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
            color: #fff;
            border: none;
            border-radius: 2rem;
            padding: 0.9rem 2.2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s;
            box-shadow: 0 2px 8px rgba(99,102,241,0.08);
        }
        .modern-chat-send-btn:hover {
            background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
        }
        @media (max-width: 900px) {
            .modern-chat-container {
                margin-left: 0;
                width: 100vw;
            }
            .modern-chat-box {
                flex-direction: column;
                width: 100vw;
                height: 100vh;
                min-height: 0;
                border-radius: 0;
            }
            .modern-chat-sidebar {
                width: 100vw;
                min-height: 120px;
                flex-direction: row;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem 0.5rem;
                overflow-x: auto;
            }
            .modern-chat-group-list {
                flex-direction: row;
                gap: 0.5rem;
                overflow-x: auto;
                overflow-y: hidden;
            }
            .modern-chat-group-item {
                min-width: 120px;
                padding: 0.7rem 0.7rem;
            }
            .modern-chat-main {
                min-height: 0;
            }
            .modern-chat-header, .modern-chat-input-bar {
                padding: 1rem 1vw;
            }
            .modern-chat-messages {
                padding: 1rem 1vw 0.5rem 1vw;
            }
        }
    </style>
}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('sohbet-page');
    });
</script>

<div class="modern-chat-container">
    <div class="modern-chat-box">
        <!-- Sidebar -->
        <div class="modern-chat-sidebar">
            <h1>Sohbet Grupları</h1>
            <div class="modern-chat-group-list">
                @foreach (var group in Model)
                {
                    <div class="modern-chat-group-item" data-group-id="@group.Id" data-group-name="@group.Name">
                        <div class="modern-chat-group-avatar">@group.Name.Substring(0, 1).ToUpper()</div>
                        <div class="modern-chat-group-info">
                            <h3>@group.Name</h3>
                            <p>Gruba tıkla</p>
                        </div>
                    </div>
                }
            </div>
            <div class="modern-chat-sidebar-footer">
                <div class="flex items-center gap-2">
                    <span style="display:inline-block;width:10px;height:10px;background:#22c55e;border-radius:50%;"></span>
                    <span>@User.Identity.Name</span>
                </div>
            </div>
        </div>
        <!-- Main Chat Area -->
        <div class="modern-chat-main">
            <div id="chatHeader" class="modern-chat-header" style="display:none;">
                <div class="modern-chat-header-avatar" id="groupAvatar"></div>
                <div class="modern-chat-header-title" id="selectedGroupName"></div>
                <button id="leaveGroup" class="ml-auto px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors" style="background:transparent;">Çık</button>
            </div>
            <div id="emptyState" class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.959 8.959 0 01-4.906-1.478l-3.077.82a.84.84 0 01-1.041-.816l.17-3.024A8 8 0 1121 12z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Sohbet Seçin</h3>
                    <p class="text-gray-500 text-sm">Sol taraftan bir grup seçin</p>
                </div>
            </div>
            <div id="chatArea" class="modern-chat-messages" style="display:none;"></div>
            <div id="chatInputBar" class="modern-chat-input-bar" style="display:none;">
                <input type="text" id="messageInputPage" class="modern-chat-input" placeholder="Mesaj yazın..." autocomplete="off" />
                <button id="sendButtonPage" class="modern-chat-send-btn">Gönder</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
<script>
document.body.classList.add('sohbet-page');
$(function(){
    var selectedGroupId = '';
    var selectedGroupName = '';
    // Grup seçimi
    $('.modern-chat-group-item').on('click', function(){
        $('.modern-chat-group-item').removeClass('selected');
        $(this).addClass('selected');
        selectedGroupId = $(this).data('group-id');
        selectedGroupName = $(this).data('group-name');
        $('#emptyState').hide();
        $('#chatHeader').show();
        $('#chatArea').show();
        $('#chatInputBar').show();
        $('#selectedGroupName').text(selectedGroupName);
        $('#groupAvatar').text(selectedGroupName.substring(0, 1).toUpperCase());
        loadGroupMessages(selectedGroupId);
        $('#messageInputPage').focus();
    });
    // Gruptan ayrılma
    $('#leaveGroup').on('click', function(){
        $('.modern-chat-group-item').removeClass('selected');
        selectedGroupId = '';
        selectedGroupName = '';
        $('#chatHeader').hide();
        $('#chatArea').hide();
        $('#chatInputBar').hide();
        $('#emptyState').show();
        $('#chatArea').empty();
    });
    // Mesaj gönderme
    $('#sendButtonPage').on('click', sendMessage);
    $('#messageInputPage').on('keypress', function(e){
        if(e.which === 13) sendMessage();
    });
    function sendMessage(){
        var message = $('#messageInputPage').val().trim();
        if(!message || !selectedGroupId) return;
        $.post('@Url.Action("SendMessage", "Chat")', { 
            user: '@User.Identity.Name', 
            message: message, 
            groupId: selectedGroupId 
        }, function(){
            $('#messageInputPage').val('').focus();
            loadGroupMessages(selectedGroupId);
        });
    }
    function loadGroupMessages(groupId){
        $.get('@Url.Action("GetGroupMessages", "Chat")', { groupId: groupId }, function(data){
            $('#chatArea').empty();
            if(data && data.length){
                data.forEach(function(msg){
                    var isMe = msg.UserName === '@User.Identity.Name';
                    var time = msg.SentAt ? new Date(msg.SentAt).toLocaleTimeString('tr-TR', {
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';
                    var html = `
                    <div class="modern-chat-message-row${isMe ? ' me' : ''}">
                        <div class="modern-chat-message-bubble">
                            <div>${msg.Content}</div>
                            <div class="modern-chat-message-meta">${msg.UserName} • ${time}</div>
                        </div>
                    </div>`;
                    $('#chatArea').append(html);
                });
                $('#chatArea').scrollTop($('#chatArea')[0].scrollHeight);
            }
        });
    }
    setInterval(function(){
        if(selectedGroupId){
            loadGroupMessages(selectedGroupId);
        }
    }, 5000);
});
</script>