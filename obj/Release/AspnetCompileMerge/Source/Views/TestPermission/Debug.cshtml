@model MZDNETWORK.Controllers.PermissionDebugModel
@{
    ViewBag.Title = "Permission System Debug";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-900">Permission System Debug & Troubleshooting</h1>

        @* Success/Error Messages *@
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4">
                @TempData["SuccessMessage"]
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
                @TempData["ErrorMessage"]
            </div>
        }

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Kullanıcı Bilgileri -->
            <div class="bg-white rounded-lg shadow border p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Kullanıcı Bilgileri</h2>
                <div class="space-y-3">
                    <div><strong>Authenticated:</strong> <span class="@(Model.IsAuthenticated ? "text-green-600" : "text-red-600")">@(Model.IsAuthenticated ? "✓ Evet" : "✗ Hayır")</span></div>
                    <div><strong>Username:</strong> @(Model.Username ?? "Bilinmiyor")</div>
                    <div><strong>User ID:</strong> @Model.UserId</div>
                    <div><strong>System Roles (Helper):</strong> @(Model.UserRoles.Any() ? string.Join(", ", Model.UserRoles) : "Rol yok")</div>
                    <div><strong>Database Roles (Direct):</strong> @(Model.DatabaseRoles.Any() ? string.Join(", ", Model.DatabaseRoles) : "Rol yok")</div>
                </div>
            </div>

            <!-- Cache Management -->
            <div class="bg-white rounded-lg shadow border p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Cache Management</h2>
                <div id="cacheInfo" class="mb-4 text-sm">
                    <div>Cache bilgileri yükleniyor...</div>
                </div>
                <div class="space-x-2">
                    <button id="clearCacheBtn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Clear All Cache</button>
                    <button id="refreshCacheBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Refresh Info</button>
                    <button id="clearUserCacheBtn" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">Clear My Cache</button>
                </div>
            </div>

            <!-- Sistem İstatistikleri -->
            <div class="bg-white rounded-lg shadow border p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Sistem İstatistikleri</h2>
                <div class="space-y-2">
                    <div><strong>Permission Nodes:</strong> @Model.PermissionNodesCount</div>
                    <div><strong>Role Permissions:</strong> @Model.RolePermissionsCount</div>
                    <div><strong>Cache Status:</strong> <span id="cacheStatus">Kontrol ediliyor...</span></div>
                </div>
            </div>

            <!-- Hızlı İşlemler -->
            <div class="bg-white rounded-lg shadow border p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Hızlı İşlemler</h2>
                <div class="space-y-3">
                    <a href="@Url.Action("ClearCache")" class="block w-full px-4 py-2 bg-orange-500 text-white text-center rounded hover:bg-orange-600">Cache Temizle</a>
                    <a href="@Url.Action("RunSeeder")" class="block w-full px-4 py-2 bg-green-500 text-white text-center rounded hover:bg-green-600">Permission Seeder Çalıştır</a>
                    <a href="@Url.Action("AssignAdminRole")" class="block w-full px-4 py-2 bg-purple-500 text-white text-center rounded hover:bg-purple-600">Admin Rolü Ata</a>
                </div>
            </div>
        </div>

        <!-- Permission Tests -->
        <div class="mt-8">
            <div class="bg-white rounded-lg shadow border p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Permission Testleri</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    @foreach (var test in Model.PermissionTests)
                    {
                        <div class="p-3 border rounded">
                            <div class="font-medium mb-2">@test.Permission.@test.Action</div>
                            <div class="@(test.HasPermission ? "text-green-600" : "text-red-600")">
                                @(test.HasPermission ? "✓ İzin Var" : "✗ İzin Yok")
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Real-time Permission Tests -->
        <div class="mt-8">
            <div class="bg-white rounded-lg shadow border p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Real-time Permission Testleri</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="p-3 border rounded">
                        <div class="font-medium mb-2">UserManagement.View</div>
                        <div class="@(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("UserManagement", "View") ? "text-green-600" : "text-red-600")">
                            @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("UserManagement", "View") ? "✓ Göster" : "✗ Gizle")
                        </div>
                    </div>
                    
                    <div class="p-3 border rounded">
                        <div class="font-medium mb-2">SystemManagement.RoleManagement</div>
                        <div class="@(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("SystemManagement.RoleManagement", "View") ? "text-green-600" : "text-red-600")">
                            @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("SystemManagement.RoleManagement", "View") ? "✓ Göster" : "✗ Gizle")
                        </div>
                    </div>
                    
                    <div class="p-3 border rounded">
                        <div class="font-medium mb-2">HumanResources.View</div>
                        <div class="@(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("HumanResources", "View") ? "text-green-600" : "text-red-600")">
                            @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("HumanResources", "View") ? "✓ Göster" : "✗ Gizle")
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Error Information *@
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="mt-6">
                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-red-900 mb-4">Hata Detayları</h3>
                    <pre class="text-sm text-red-700 whitespace-pre-wrap">@Model.ErrorMessage</pre>
                </div>
            </div>
        }

        <!-- Troubleshooting Guide -->
        <div class="mt-8">
            <div class="bg-gray-50 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Troubleshooting</h3>
                <div class="text-sm text-gray-600 space-y-2">
                    <p><strong>1.</strong> Eğer tüm testler "Yok" çıkıyorsa: PermissionSeeder çalışmamış olabilir</p>
                    <p><strong>2.</strong> Roller boşsa: UserRoles tablosunda kayıt yok demektir</p>
                    <p><strong>3.</strong> Permission testleri farklı sonuç veriyorsa: Cache problemi olabilir</p>
                    <p><strong>4.</strong> Roller atadıktan sonra etkili olmuyorsa: Cache temizleme eksik olabilir</p>
                    <p><strong>5.</strong> UI'da menüler gözükmüyorsa: Layout'taki permission string'leri yanlış olabilir</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Load cache info on page load
    loadCacheInfo();
    
    // Cache management buttons
    $('#clearCacheBtn').click(function() {
        clearAllCache();
    });
    
    $('#refreshCacheBtn').click(function() {
        loadCacheInfo();
    });
    
    $('#clearUserCacheBtn').click(function() {
        clearUserCache(@Model.UserId);
    });
    
    function loadCacheInfo() {
        $('#cacheStatus').text('Kontrol ediliyor...');
        $.get('/TestPermission/GetCacheInfo')
            .done(function(data) {
                var html = '<div class="grid grid-cols-2 gap-2 text-xs">';
                if (data.error) {
                    html += '<div class="col-span-2 text-red-600">Error: ' + data.error + '</div>';
                    $('#cacheStatus').html('<span class="text-red-600">Error</span>');
                } else {
                    html += '<div><strong>Valid Caches:</strong> ' + (data.TotalValidCaches || 0) + '</div>';
                    html += '<div><strong>Total Size:</strong> ' + (data.TotalSizeKB || 0).toFixed(2) + ' KB</div>';
                    html += '<div><strong>Avg Hit Count:</strong> ' + (data.AverageHitCount || 0).toFixed(1) + '</div>';
                    html += '<div><strong>Most Accessed User:</strong> ' + (data.MostAccessedUser || 'N/A') + '</div>';
                    if (data.OldestCache) {
                        html += '<div><strong>Oldest:</strong> ' + new Date(data.OldestCache).toLocaleString() + '</div>';
                    }
                    if (data.NewestCache) {
                        html += '<div><strong>Newest:</strong> ' + new Date(data.NewestCache).toLocaleString() + '</div>';
                    }
                    $('#cacheStatus').html('<span class="text-green-600">Active (' + (data.TotalValidCaches || 0) + ')</span>');
                }
                html += '</div>';
                $('#cacheInfo').html(html);
            })
            .fail(function() {
                $('#cacheInfo').html('<span class="text-red-600">Failed to load cache info</span>');
                $('#cacheStatus').html('<span class="text-red-600">Error</span>');
            });
    }
    
    function clearAllCache() {
        $('#cacheStatus').text('Temizleniyor...');
        $.post('/TestPermission/ClearAllCache')
            .done(function(response) {
                if (response.success) {
                    $('#cacheInfo').html('<span class="text-green-600">Cache cleared successfully at ' + new Date().toLocaleTimeString() + '</span>');
                    setTimeout(loadCacheInfo, 1000);
                } else {
                    $('#cacheInfo').html('<span class="text-red-600">Failed: ' + response.message + '</span>');
                }
            })
            .fail(function() {
                $('#cacheInfo').html('<span class="text-red-600">Failed to clear cache</span>');
                $('#cacheStatus').html('<span class="text-red-600">Error</span>');
            });
    }
    
    function clearUserCache(userId) {
        $.post('/TestPermission/ClearUserCache', { userId: userId })
            .done(function(response) {
                if (response.success) {
                    $('#cacheInfo').html('<span class="text-green-600">User cache cleared: ' + response.message + '</span>');
                    setTimeout(loadCacheInfo, 1000);
                } else {
                    $('#cacheInfo').html('<span class="text-red-600">Failed: ' + response.message + '</span>');
                }
            })
            .fail(function() {
                $('#cacheInfo').html('<span class="text-red-600">Failed to clear user cache</span>');
            });
    }
});
</script>