@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>TV – Öneri Tablosu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="~/Content/TV.css" />
</head>
<body>
    <div class="fixed-header-bar">
        <div class="fixed-clock" id="fixed-clock"></div>
        <div class="fixed-date" id="fixed-date"></div>
        <div class="fixed-day" id="fixed-day"></div>
    </div>
    <div class="container">
        <h1 id="tv-title">🔔 Öneriler (En Yeni En Üstte)</h1>

        <table>
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Öneri Veren</th>
                    <th>Problem</th>
                    <th>Öneri</th>
                </tr>
            </thead>
            <tbody id="tv-body">
                <tr>
                    <td colspan="4" class="loading">Yükleniyor</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // Sol üst saat ve sağ üst tarih için
        function updateClockAndDate() {
            var now = new Date();
            var saat = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            var tarih = now.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            var gun = now.toLocaleDateString('tr-TR', { weekday: 'long' });
            $('#fixed-clock').html('<span>' + saat + '</span>');
            $('#fixed-date').html('<span>' + tarih + '</span>');
            $('#fixed-day').html('<span>' + gun.charAt(0).toUpperCase() + gun.slice(1) + '</span>');
        }

        setInterval(updateClockAndDate, 1000);
        updateClockAndDate();

        // Sunucudan TV başlığını alır ve günceller
        function refreshHeader() {
            $.getJSON('@Url.Action("GetHeader","BeyazTahta")', function(res) {
                $('#tv-title').text(res.title);
            });
        }

        // .NET Date("/Date(...)") formatını JS Date objesine çevirir
        function toDate(dotNetDate) {
            const ms = parseInt(dotNetDate.replace(/\/Date\((-?\d+)\)\//,'$1'), 10);
            return new Date(ms).toLocaleString('tr-TR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Önceki verileri saklamak için
        let previousData = [];

        // Sunucudan öneri listesini alır ve tabloya basar
        function refreshTable() {
            $.getJSON('@Url.Action("GetEntries","BeyazTahta")', function(data) {
                // Yeni gelen verileri kontrol et
                const newEntries = data.filter(entry =>
                    !previousData.some(prevEntry =>
                        prevEntry.CreatedAt === entry.CreatedAt &&
                        prevEntry.OneriVeren === entry.OneriVeren &&
                        prevEntry.Problem === entry.Problem
                    )
                );

                previousData = [...data];

                const rows = data.map(function(e) {
                    // Yeni gelen satırlar için animasyon sınıfı ekle
                    const isNew = newEntries.some(newEntry =>
                        newEntry.CreatedAt === e.CreatedAt &&
                        newEntry.OneriVeren === e.OneriVeren &&
                        newEntry.Problem === e.Problem
                    );

                    const animClass = isNew ? 'new-row' : '';

                    return `
                        <tr class="${animClass}">
                            <td class="date-cell">${toDate(e.CreatedAt)}</td>
                            <td class="author-cell">${e.OneriVeren}</td>
                            <td class="problem-cell">${e.Problem}</td>
                            <td class="suggestion-cell">${e.Oneri}</td>
                        </tr>`;
                }).join('');

                $('#tv-body').html(rows || '<tr><td colspan="4" class="loading">Henüz öneri bulunmuyor</td></tr>');
            }).fail(function() {
                $('#tv-body').html('<tr><td colspan="4" class="loading">Veri yüklenirken bir hata oluştu</td></tr>');
            });
        }

        // Sayfa açıldığında ve her 10 saniyede bir çağır
        $(function(){
            refreshHeader();
            refreshTable();
            setInterval(function(){
                refreshHeader();
                refreshTable();
            }, 10000);
        });

        let shift = 0;
        setInterval(function () {
            shift = (shift + 1) % 10; // 0-9 arası döngü
            $('.container').css('transform', `translate(${shift}px, ${shift}px)`);
            $('.fixed-clock').css('transform', `translate(${shift}px, ${shift}px)`);
            $('.fixed-date').css('transform', `translate(${shift}px, ${shift}px)`);
        }, 30000); // 30 saniyede bir kaydır
    </script>
</body>
</html>
