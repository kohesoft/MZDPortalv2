@{
    ViewBag.Title = "Rol-Yetki Y√∂netimi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Cache Buster: TIMESTAMP_123456789 -->
<script>
// CACHE BUSTER - VERSION 2.0 - @DateTime.Now.ToString("yyyyMMddHHmmss")
console.log('üîÑ JavaScript RELOADED V2.0 - NEW CACHE BUSTER');

$(document).ready(function() {
    let selectedRoleId = null;
    let roles = [];
    let permissions = [];
    let currentRolePermissions = {};

    // Debug function
    function debug(message) {
        console.log('üîß DEBUG V2: ' + message);
        $('#debugText').text(message);
        $('#debugInfo').show();
        setTimeout(() => $('#debugInfo').hide(), 3000);
    }

    debug('üöÄ SYSTEM V2.0 LOADED - PERMISSIONS WORKING');

    loadRoles();
    loadStats();

    // Test table status function
    function testTableStatus() {
        debug('üß™ Testing table status...');
        $.get('/RolePermission/CheckTableStatus')
            .done(function(data) {
                console.log('Table Status Result:', data);
                if (data.success) {
                    showToast('success', `Tables OK: ${data.roleCount} roles, ${data.permissionCount} permissions, ${data.rolePermissionCount} assignments`);
                } else {
                    showToast('error', 'Table Error: ' + data.error);
                    console.error('Table Error Details:', data);
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Table Status Test Failed:', error);
                showToast('error', 'Table test failed: ' + error);
            });
    }

    // Manuel tablo olu≈üturma fonksiyonu
    function createTableManually() {
        debug('üîß Manually creating RolePermissions table...');
        showToast('info', 'Tablo olu≈üturuluyor, l√ºtfen bekleyin...');
        
        $.get('/RolePermission/CreateTableManually')
            .done(function(data) {
                console.log('Manual Table Creation Result:', data);
                if (data.success) {
                    showToast('success', data.message);
                    // Sayfayƒ± yenile
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showToast('error', 'Tablo olu≈üturulamadƒ±: ' + data.error);
                    console.error('Table Creation Error:', data);
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Manual Table Creation Failed:', error);
                showToast('error', 'Tablo olu≈üturma isteƒüi ba≈üarƒ±sƒ±z: ' + error);
            });
    }

    // Event Handlers
    $('#addRoleBtn').click(function() { openRoleModal(); });
    $('#refreshBtn').click(function() { loadRoles(); loadStats(); });
    $('#testTableBtn').click(function() { testTableStatus(); });
    $('#createTableBtn').click(function() { createTableManually(); });
    $('#closeRoleModal, #cancelRoleBtn').click(function() { closeRoleModal(); });
    $('#closePermissionModal, #cancelPermissionBtn').click(function() { closePermissionModal(); });
    
    $('#roleForm').submit(function(e) {
        e.preventDefault();
        saveRole();
    });

    $('#permissionForm').submit(function(e) {
        e.preventDefault();
        savePermission();
    });

    $('#removePermissionBtn').click(function() {
        removePermission();
    });

    function loadRoles() {
        debug('Loading roles...');
        $.get('/RolePermission/GetRoles')
            .done(function(data) {
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                roles = data;
                renderRoles(data);
                debug(`Loaded ${data.length} roles`);
            })
            .fail(function() {
                showToast('error', 'Roller y√ºklenirken hata olu≈ütu');
            });
    }

    function loadStats() {
        $.get('/RolePermission/GetMatrixStatistics')
            .done(function(data) {
                $('#totalRoles').text(data.totalRoles || 0);
                $('#totalPermissions').text(data.totalPermissions || 0);
                $('#activeUsers').text(data.activeUsers || 0);
                $('#roleAssignments').text(data.roleAssignments || 0);
            })
            .fail(function() {
                console.error('ƒ∞statistikler y√ºklenemedi');
            });
    }

    function renderRoles(roleData) {
        const container = $('#rolesList');
        container.empty();

        if (!roleData || roleData.length === 0) {
            container.html('<div class="text-center py-8"><p class="text-slate-600">Hen√ºz rol eklenmemi≈ü</p></div>');
            return;
        }

        $('#rolesCount').text(roleData.length);

        roleData.forEach(role => {
            const isSelected = selectedRoleId === role.id;
            const roleElement = $(`
                <div class="role-item p-4 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-all ${isSelected ? 'ring-2 ring-blue-500 bg-blue-50' : ''}" data-role-id="${role.id}">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-slate-800">${role.name}</h3>
                        <div class="flex gap-2">
                            <button class="edit-role-btn p-1 text-slate-400 hover:text-blue-600" data-role-id="${role.id}">
                                <i class='bx bx-edit text-lg'></i>
                            </button>
                            <button class="delete-role-btn p-1 text-slate-400 hover:text-red-600" data-role-id="${role.id}">
                                <i class='bx bx-trash text-lg'></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-slate-600 mb-3">${role.description || 'A√ßƒ±klama yok'}</p>
                    <div class="flex items-center justify-between">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${role.userCount} kullanƒ±cƒ±
                        </span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                            ${role.permissionCount} yetki
                        </span>
                    </div>
                </div>
            `);
            container.append(roleElement);
        });

        // Bind events
        $('.role-item').click(function(e) {
            if (!$(e.target).closest('.edit-role-btn, .delete-role-btn').length) {
                selectRole($(this).data('role-id'));
            }
        });

        $('.edit-role-btn').click(function(e) {
            e.stopPropagation();
            editRole($(this).data('role-id'));
        });

        $('.delete-role-btn').click(function(e) {
            e.stopPropagation();
            deleteRole($(this).data('role-id'));
        });
    }

    function selectRole(roleId) {
        debug(`üéØ SELECTING ROLE: ${roleId} (V2.0)`);
        selectedRoleId = roleId;
        $('.role-item').removeClass('ring-2 ring-blue-500 bg-blue-50');
        $(`.role-item[data-role-id="${roleId}"]`).addClass('ring-2 ring-blue-500 bg-blue-50');
        
        const role = roles.find(r => r.id === roleId);
        if (role) {
            $('#selectedRoleInfo').html(`
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800">${role.name}</h3>
                        <p class="text-slate-600">${role.description || 'A√ßƒ±klama yok'}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-slate-600">Kullanƒ±cƒ±: ${role.userCount}</div>
                        <div class="text-sm text-slate-600">Yetki: ${role.permissionCount}</div>
                    </div>
                </div>
            `).removeClass('border-dashed border-slate-300').addClass('border-solid border-blue-200');
            
            loadRolePermissions(roleId);
        }
    }

    // üî• YENƒ∞ V2.0 - GetRolePermissions √ßaƒürƒ±sƒ± AKTƒ∞F
    function loadRolePermissions(roleId) {
        $('#permissionsTree').addClass('hidden');
        
        debug(`üî• V2.0: Loading permissions for role ${roleId} - WITH API CALL`);
        
        $.get('/RolePermission/GetPermissions')
            .done(function(permissionData) {
                debug(`üî• V2.0: Got ${permissionData.length || 0} permissions`);
                
                if (permissionData.error) {
                    showToast('error', 'Yetkiler y√ºklenirken hata: ' + permissionData.error);
                    return;
                }
                
                // ‚úÖ GetRolePermissions √ßaƒürƒ±sƒ±nƒ± aktif ettik
                $.get(`/RolePermission/GetRolePermissions/${roleId}`)
                    .done(function(rolePermissions) {
                        console.log('üî• V2.0: Role permissions response:', rolePermissions);
                        
                        // Eƒüer error varsa g√∂ster
                        if (rolePermissions && rolePermissions.error) {
                            console.error('üî• Database Error:', rolePermissions);
                            showToast('error', `Tablo hatasƒ±: ${rolePermissions.error}`);
                            
                            // Debug bilgilerini g√∂ster
                            if (rolePermissions.stackTrace) {
                                console.error('Stack Trace:', rolePermissions.stackTrace);
                            }
                            
                            // Hata olursa bo≈ü permissions ile devam et
                            currentRolePermissions = {};
                            permissions = permissionData;
                            renderPermissions(permissionData, {});
                            $('#permissionsTree').removeClass('hidden');
                            return;
                        }
                        
                        debug(`üî• V2.0: Role permissions SUCCESS - ${Object.keys(rolePermissions || {}).length} assigned`);
                        
                        // Global variable'a kaydet
                        currentRolePermissions = rolePermissions || {};
                        permissions = permissionData;
                        renderPermissions(permissionData, currentRolePermissions);
                        $('#permissionsTree').removeClass('hidden');
                    })
                    .fail(function(xhr, status, error) {
                        console.error('üî• V2.0: GetRolePermissions AJAX FAIL:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        // Response text'i kontrol et ve daha detaylƒ± hata g√∂ster
                        let errorMessage = `HTTP ${xhr.status}: ${error}`;
                        let detailedError = '';
                        
                        if (xhr.responseText) {
                            try {
                                const errorData = JSON.parse(xhr.responseText);
                                errorMessage = errorData.error || errorData.message || errorMessage;
                                detailedError = errorData.stackTrace || '';
                            } catch (e) {
                                // HTML response ise sadece kƒ±sa bir par√ßa g√∂ster
                                if (xhr.responseText.includes('<html')) {
                                    errorMessage = `HTTP ${xhr.status} - Server Error (HTML Response)`;
                                    detailedError = 'Server d√∂nd√ºrd√ºƒü√º HTML response - database baƒülantƒ± sorunu olabilir';
                                } else {
                                    errorMessage = xhr.responseText.substring(0, 200);
                                    if (xhr.responseText.length > 200) errorMessage += '...';
                                }
                            }
                        }
                        
                        showToast('error', `Rol yetkileri y√ºklenemedi: ${errorMessage}`);
                        
                        if (detailedError) {
                            console.error('Detailed Error:', detailedError);
                        }
                        
                        debug(`üî• V2.0: GetRolePermissions ERROR - ${errorMessage} - Using empty permissions`);
                        
                        // Hata olursa bo≈ü permissions ile devam et
                        currentRolePermissions = {};
                        permissions = permissionData;
                        renderPermissions(permissionData, {});
                        $('#permissionsTree').removeClass('hidden');
                    });
            })
            .fail(function(xhr, status, error) {
                showToast('error', 'Yetkiler y√ºklenirken hata: ' + error);
            });
    }

    // ===== Improved Recursive Renderer (unlimited depth) =====
    function renderPermissions(permissionData, rolePermissions) {
        debug(`üî• Recursive render: ${permissionData.length} nodes, ${Object.keys(rolePermissions).length} role items`);

        const container = $('#permissionsTree');
        container.empty();

        // üõ†Ô∏è Prevent duplicate event bindings (unbind previous handlers)
        container.off('click', '.permission-header');
        container.off('click', '.edit-permission-btn');

        if (!permissionData || !permissionData.length) {
            container.html('<div class="text-center py-8"><p class="text-slate-600">Yetki bulunamadƒ±</p></div>');
            return;
        }

        // √áocuk listesi haritasƒ± olu≈ütur
        const childrenMap = {};
        permissionData.forEach(p => {
            const pid = p.parentId === null ? 'root' : p.parentId;
            if (!childrenMap[pid]) childrenMap[pid] = [];
            childrenMap[pid].push(p);
        });

        // Tek bir izin i√ßin HTML √ºret (rek√ºrsif)
        function nodeHtml(permission, level) {
            const pad = 20 * level; // px
            const permState = rolePermissions[permission.id] || {};
            const isActive = permState.canView || permState.canCreate || permState.canEdit || permState.canDelete || permState.canManage || permState.canApprove || permState.canExport || permState.canImport;

            const kids = childrenMap[permission.id] || [];
            const assignedKids = kids.filter(k => {
                const rs = rolePermissions[k.id] || {};
                return rs.canView || rs.canCreate || rs.canEdit || rs.canDelete || rs.canManage || rs.canApprove || rs.canExport || rs.canImport;
            }).length;

            return `
            <div class="permission-item">
                <div class="permission-header flex items-center justify-between bg-slate-50 border-b border-slate-200 ${kids.length ? 'cursor-pointer hover:bg-slate-100' : ''}" data-permission-id="${permission.id}" style="padding:12px 12px 12px ${pad + 16}px;">
                    <div class="flex items-center space-x-3">
                        ${kids.length ? '<i class="bx bx-chevron-right toggle-icon text-slate-400"></i>' : ''}
                        <i class="${permission.icon || 'bx bx-key'} text-base text-slate-600"></i>
                        <div>
                            <span class="font-medium text-slate-800">${permission.name}</span>
                            <p class="text-xs text-slate-500">${permission.description || permission.path}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        ${isActive ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class='bx bx-check mr-1'></i>Aktif</span>` : `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600"><i class='bx bx-x mr-1'></i>Pasif</span>`}
                        ${kids.length ? `<span class="text-xs text-slate-500">${assignedKids}/${kids.length}</span>` : ''}
                        <button class="edit-permission-btn p-1 text-slate-400 hover:text-blue-600" data-permission-id="${permission.id}"><i class='bx bx-edit text-sm'></i></button>
                    </div>
                </div>
                ${kids.length ? `<div class="permission-children hidden">${kids.map(k => nodeHtml(k, level + 1)).join('')}</div>` : ''}
            </div>`;
        }

        // K√∂k d√ºƒü√ºmleri ekle
        (childrenMap['root'] || []).forEach(root => {
            container.append(nodeHtml(root, 0));
        });

        // Delegated toggle (expand/collapse)
        container.on('click', '.permission-header', function (e) {
            if ($(e.target).closest('.edit-permission-btn').length) return; // edit butonu tƒ±klandƒ±ysa ge√ß
            const childBox = $(this).next('.permission-children');
            if (!childBox.length) return;
            childBox.toggleClass('hidden');
            $(this).find('.toggle-icon').toggleClass('bx-chevron-right bx-chevron-down');
        });

        // Delegated edit
        container.on('click', '.edit-permission-btn', function (e) {
            e.stopPropagation();
            editPermission($(this).data('permission-id'));
        });

        
    }

    function openRoleModal(roleData = null) {
        if (roleData) {
            $('#roleModalTitle').text('Rol D√ºzenle');
            $('#roleId').val(roleData.id);
            $('#roleName').val(roleData.name);
            $('#roleDescription').val(roleData.description);
        } else {
            $('#roleModalTitle').text('Yeni Rol Ekle');
            $('#roleForm')[0].reset();
            $('#roleId').val('');
        }
        $('#roleModal').removeClass('hidden');
    }

    function closeRoleModal() {
        $('#roleModal').addClass('hidden');
    }

    function closePermissionModal() {
        $('#permissionModal').addClass('hidden');
    }

    function editRole(roleId) {
        const role = roles.find(r => r.id === roleId);
        if (role) {
            openRoleModal(role);
        }
    }

    function editPermission(permissionId) {
        const permission = permissions.find(p => p.id === permissionId);
        if (permission && selectedRoleId) {
            openPermissionModal(permission, 'edit');
        }
    }

    function addPermission(permissionId) {
        const permission = permissions.find(p => p.id === permissionId);
        if (permission && selectedRoleId) {
            openPermissionModal(permission, 'add');
        }
    }

    function openPermissionModal(permission, mode) {
        $('#editRoleId').val(selectedRoleId);
        $('#editPermissionNodeId').val(permission.id);
        
        // Rol bilgisini al
        const role = roles.find(r => r.id === selectedRoleId);
        const roleName = role ? role.name : 'Bilinmeyen Rol';
        
        $('#permissionInfo').html(`
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg border-l-4 border-blue-500">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-bold text-slate-800">Yetki D√ºzenleniyor</h4>
                    <span class="text-xs text-slate-500">${mode === 'edit' ? 'D√ºzenleme Modu' : 'Ekleme Modu'}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center gap-3">
                        <i class='bx bx-user-circle text-xl text-blue-600'></i>
                        <div>
                            <p class="text-sm text-slate-600">Rol</p>
                            <p class="font-semibold text-slate-800">${roleName}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class='${permission.icon || 'bx bx-key'} text-xl text-purple-600'></i>
                        <div>
                            <p class="text-sm text-slate-600">Yetki</p>
                            <p class="font-semibold text-slate-800">${permission.name}</p>
                            <p class="text-xs text-slate-500">${permission.description || permission.path}</p>
                        </div>
                    </div>
                </div>
            </div>
        `);

        // üî• V2.0: Edit mode i√ßin mevcut veriyi kullan
        if (mode === 'edit') {
            debug('üî• V2.0: Edit mode - using current loaded permission data');
            
            // Mevcut y√ºkl√º verileri kullan
            const permissionData = currentRolePermissions[permission.id];
            console.log('Modal: Looking for permission', permission.id, 'in', currentRolePermissions);
            
            if (permissionData) {
                console.log('Modal: Permission data found', permissionData);
                $('#editCanView').prop('checked', permissionData.canView || false);
                $('#editCanCreate').prop('checked', permissionData.canCreate || false);
                $('#editCanEdit').prop('checked', permissionData.canEdit || false);
                $('#editCanDelete').prop('checked', permissionData.canDelete || false);
                $('#editCanManage').prop('checked', permissionData.canManage || false);
                $('#editCanApprove').prop('checked', permissionData.canApprove || false);
                $('#editCanExport').prop('checked', permissionData.canExport || false);
            } else {
                console.log('Modal: No permission data found for permission', permission.id);
                $('#permissionForm input[type="checkbox"]').prop('checked', false);
            }
        } else {
            $('#permissionForm input[type="checkbox"]').prop('checked', false);
        }

        $('#permissionModal').removeClass('hidden');
    }

    function saveRole() {
        const formData = {
            id: $('#roleId').val() || 0,
            name: $('#roleName').val(),
            description: $('#roleDescription').val()
        };

        $.post('/RolePermission/SaveRole', formData)
            .done(function(result) {
                if (result.success) {
                    showToast('success', 'Rol ba≈üarƒ±yla kaydedildi');
                    closeRoleModal();
                    loadRoles();
                } else {
                    showToast('error', result.message || 'Rol kaydedilirken hata olu≈ütu');
                }
            })
            .fail(function() {
                showToast('error', 'Rol kaydedilirken hata olu≈ütu');
            });
    }

    function savePermission() {
        const formData = {
            RoleId: parseInt($('#editRoleId').val()),
            PermissionNodeId: parseInt($('#editPermissionNodeId').val()),
            CanView: $('#editCanView').is(':checked'),
            CanCreate: $('#editCanCreate').is(':checked'),
            CanEdit: $('#editCanEdit').is(':checked'),
            CanDelete: $('#editCanDelete').is(':checked'),
            CanManage: $('#editCanManage').is(':checked'),
            CanApprove: $('#editCanApprove').is(':checked'),
            CanReject: false,
            CanExport: $('#editCanExport').is(':checked'),
            CanImport: false,
            Notes: ''
        };

        // Eƒüer alt yetkilere de uygula se√ßiliyse toplu atama yap
        if ($('#applyToChildren').is(':checked')) {
            const childIds = permissions.filter(p => p.parentId === formData.PermissionNodeId).map(c => c.id);
            const assignments = [formData].concat(childIds.map(id => ({ ...formData, PermissionNodeId: id })));

            $.ajax({
                url: '/RolePermission/BulkAssignPermissions',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ Assignments: assignments }),
                success: function(result) {
                    if (result.success) {
                        showToast('success', result.message || 'Yetkiler ba≈üarƒ±yla kaydedildi');
                        closePermissionModal();
                        selectRole(selectedRoleId);
                    } else {
                        showToast('error', result.message || 'Yetkiler kaydedilirken hata olu≈ütu');
                    }
                },
                error: function() {
                    showToast('error', 'Yetkiler kaydedilirken hata olu≈ütu');
                }
            });
        } else {
            $.post('/RolePermission/AssignPermission', formData)
                .done(function(result) {
                    if (result.success) {
                        showToast('success', 'Yetki ba≈üarƒ±yla kaydedildi');
                        closePermissionModal();
                        selectRole(selectedRoleId); // Sayfayƒ± yenile
                    } else {
                        showToast('error', result.message || 'Yetki kaydedilirken hata olu≈ütu');
                    }
                })
                .fail(function() {
                    showToast('error', 'Yetki kaydedilirken hata olu≈ütu');
                });
        }
    }

    function removePermission() {
        if (!confirm('Bu yetkiyi kaldƒ±rmak istediƒüinizden emin misiniz?')) {
            return;
        }

        const roleId = parseInt($('#editRoleId').val());
        const permissionNodeId = parseInt($('#editPermissionNodeId').val());

        $.post('/RolePermission/RemovePermission', { roleId, permissionNodeId })
            .done(function(result) {
                if (result.success) {
                    showToast('success', 'Yetki ba≈üarƒ±yla kaldƒ±rƒ±ldƒ±');
                    closePermissionModal();
                    selectRole(selectedRoleId); // Sayfayƒ± yenile
                } else {
                    showToast('error', result.message || 'Yetki kaldƒ±rƒ±lƒ±rken hata olu≈ütu');
                }
            })
            .fail(function() {
                showToast('error', 'Yetki kaldƒ±rƒ±lƒ±rken hata olu≈ütu');
            });
    }

    function deleteRole(roleId) {
        const role = roles.find(r => r.id === roleId);
        if (!role) return;

        if (!confirm(`"${role.name}" rol√ºn√º silmek istediƒüinizden emin misiniz?`)) {
            return;
        }

        $.post('/RolePermission/DeleteRole', { id: roleId })
            .done(function(result) {
                if (result.success) {
                    showToast('success', 'Rol ba≈üarƒ±yla silindi');
                    if (selectedRoleId === roleId) {
                        selectedRoleId = null;
                        $('#selectedRoleInfo').html(`
                            <div class="text-center">
                                <i class='bx bx-info-circle text-3xl text-slate-400 mb-2'></i>
                                <p class="text-slate-600">Yetkileri g√∂rmek i√ßin sol taraftan bir rol se√ßin</p>
                            </div>
                        `).removeClass('border-solid border-blue-200').addClass('border-dashed border-slate-300');
                        $('#permissionsTree').addClass('hidden');
                    }
                    loadRoles();
                } else {
                    showToast('error', result.message || 'Rol silinirken hata olu≈ütu');
                }
            })
            .fail(function() {
                showToast('error', 'Rol silinirken hata olu≈ütu');
            });
    }

    function showToast(type, message) {
        const bgColor = type === 'success' ? 'border-emerald-200 bg-emerald-50' : 'border-red-200 bg-red-50';
        const iconColor = type === 'success' ? 'text-emerald-600' : 'text-red-600';
        const icon = type === 'success' ? 'bx-check-circle' : 'bx-error-circle';
        
        $('#toastContent').html(`
            <div class="flex items-center ${bgColor}">
                <i class='bx ${icon} ${iconColor} text-xl mr-3'></i>
                <span class="text-slate-800">${message}</span>
            </div>
        `);
        
        $('#toast').removeClass('translate-x-full');
        
        setTimeout(() => {
            $('#toast').addClass('translate-x-full');
        }, 3000);
    }

    $('#collapseAllBtn').click(function() {
        $('.permission-children').addClass('hidden');
    });
    $('#expandAllBtn').click(function() {
        $('.permission-children').removeClass('hidden');
    });
});
</script>

<div class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 mb-8">
            <div class="p-8">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl">
                            <i class='bx bx-shield-check text-2xl text-white'></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-slate-800">Rol & Yetki Y√∂netimi</h1>
                            <p class="text-slate-600 mt-1">Kullanƒ±cƒ± rollerini ve yetkilerini kolayca y√∂netin</p>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button id="addRoleBtn" style="background-color: #10b981; color: white;" class="inline-flex items-center px-4 py-2.5 font-medium rounded-lg hover:bg-emerald-600 transition-all duration-200 shadow-lg hover:shadow-xl">
                            <i class='bx bx-plus text-lg mr-2'></i>
                            Yeni Rol
                        </button>
                        <button id="refreshBtn" style="background-color: #3b82f6; color: white;" class="inline-flex items-center px-4 py-2.5 font-medium rounded-lg hover:bg-blue-600 transition-all duration-200 shadow-lg hover:shadow-xl">
                            <i class='bx bx-refresh text-lg mr-2'></i>
                            Yenile
                        </button>
                        <button id="testTableBtn" style="background-color: #f59e0b; color: white;" class="inline-flex items-center px-4 py-2.5 font-medium rounded-lg hover:bg-amber-600 transition-all duration-200 shadow-lg hover:shadow-xl">
                            <i class='bx bx-test-tube text-lg mr-2'></i>
                            Test Tables
                        </button>
                        <button id="createTableBtn" style="background-color: #ef4444; color: white;" class="inline-flex items-center px-4 py-2.5 font-medium rounded-lg hover:bg-red-600 transition-all duration-200 shadow-lg hover:shadow-xl">
                            <i class='bx bx-wrench text-lg mr-2'></i>
                            Create Table
                        </button>
                        <button id="expandAllBtn" style="background-color: #6b7280; color: white;" class="inline-flex items-center px-4 py-2.5 font-medium rounded-lg hover:bg-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                            <i class='bx bx-spreadsheet text-lg mr-2'></i>
                            T√ºm√ºn√º A√ß
                        </button>
                        <button id="collapseAllBtn" style="background-color: #9ca3af; color: white;" class="inline-flex items-center px-4 py-2.5 font-medium rounded-lg hover:bg-gray-500 transition-all duration-200 shadow-lg hover:shadow-xl">
                            <i class='bx bx-collapse-horizontal text-lg mr-2'></i>
                            T√ºm√ºn√º Kapat
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-600 text-sm font-medium">Toplam Rol</p>
                        <p id="totalRoles" class="text-2xl font-bold text-slate-800 mt-1">-</p>
                    </div>
                    <div class="p-3 bg-blue-100 rounded-xl">
                        <i class='bx bx-user-circle text-2xl text-blue-600'></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-600 text-sm font-medium">Toplam Yetki</p>
                        <p id="totalPermissions" class="text-2xl font-bold text-slate-800 mt-1">-</p>
                    </div>
                    <div class="p-3 bg-emerald-100 rounded-xl">
                        <i class='bx bx-key text-2xl text-emerald-600'></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-600 text-sm font-medium">Aktif Kullanƒ±cƒ±</p>
                        <p id="activeUsers" class="text-2xl font-bold text-slate-800 mt-1">-</p>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-xl">
                        <i class='bx bx-group text-2xl text-purple-600'></i>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-600 text-sm font-medium">Rol Atamasƒ±</p>
                        <p id="roleAssignments" class="text-2xl font-bold text-slate-800 mt-1">-</p>
                    </div>
                    <div class="p-3 bg-amber-100 rounded-xl">
                        <i class='bx bx-link text-2xl text-amber-600'></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Roles Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-6 border-b border-slate-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Roller (<span id="rolesCount">0</span>)</h2>
                        <input type="text" id="roleSearch" placeholder="Rol ara..." class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="p-4">
                        <div id="rolesList" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center py-8">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                                <p class="text-slate-600 mt-2">Roller y√ºkleniyor...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Permissions Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200">
                    <div class="p-6 border-b border-slate-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Yetkiler</h2>
                        <input type="text" id="permissionSearch" placeholder="Yetki ara..." class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="p-4">
                        <div id="selectedRoleInfo" class="mb-6 p-4 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300 text-center">
                            <i class='bx bx-info-circle text-3xl text-slate-400 mb-2'></i>
                            <p class="text-slate-600">Yetkileri g√∂rmek i√ßin sol taraftan bir rol se√ßin</p>
                        </div>
                        <div id="permissionsTree" class="space-y-3 max-h-96 overflow-y-auto hidden">
                            <!-- Permissions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role Modal -->
<div id="roleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <h3 id="roleModalTitle" class="text-xl font-bold text-slate-800">Yeni Rol Ekle</h3>
                <button id="closeRoleModal" class="text-slate-400 hover:text-slate-600">
                    <i class='bx bx-x text-2xl'></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form id="roleForm" class="space-y-4">
                <input type="hidden" id="roleId">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Rol Adƒ±</label>
                    <input type="text" id="roleName" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">A√ßƒ±klama</label>
                    <textarea id="roleDescription" rows="3" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" id="cancelRoleBtn" class="flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">ƒ∞ptal</button>
                    <button type="submit" style="background-color: #3b82f6; color: white;" class="flex-1 px-4 py-3 rounded-lg hover:bg-blue-600">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Permission Modal -->
<div id="permissionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-slate-800">Yetki D√ºzenle</h3>
                <button id="closePermissionModal" class="text-slate-400 hover:text-slate-600">
                    <i class='bx bx-x text-2xl'></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <div id="permissionInfo" class="mb-6 p-4 bg-slate-50 rounded-lg"></div>
            <form id="permissionForm" class="space-y-6">
                <input type="hidden" id="editRoleId">
                <input type="hidden" id="editPermissionNodeId">
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <label class="flex items-center space-x-3 p-4 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" id="editCanView" class="h-5 w-5">
                        <span class="font-medium text-slate-700">G√∂r√ºnt√ºle</span>
                    </label>
                    <label class="flex items-center space-x-3 p-4 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" id="editCanCreate" class="h-5 w-5">
                        <span class="font-medium text-slate-700">Olu≈ütur</span>
                    </label>
                    <label class="flex items-center space-x-3 p-4 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" id="editCanEdit" class="h-5 w-5">
                        <span class="font-medium text-slate-700">D√ºzenle</span>
                    </label>
                    <label class="flex items-center space-x-3 p-4 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" id="editCanDelete" class="h-5 w-5">
                        <span class="font-medium text-slate-700">Sil</span>
                    </label>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <label class="flex items-center space-x-3 p-4 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" id="editCanManage" class="h-5 w-5">
                        <span class="font-medium text-slate-700">Y√∂net</span>
                    </label>
                    <label class="flex items-center space-x-3 p-4 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" id="editCanApprove" class="h-5 w-5">
                        <span class="font-medium text-slate-700">Onayla</span>
                    </label>
                    <label class="flex items-center space-x-3 p-4 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
                        <input type="checkbox" id="editCanExport" class="h-5 w-5">
                        <span class="font-medium text-slate-700">Dƒ±≈üa Aktar</span>
                    </label>
                </div>

                <div class="flex items-center space-x-3 mb-4">
                    <input type="checkbox" id="applyToChildren" class="h-5 w-5">
                    <label for="applyToChildren" class="font-medium text-slate-700">Alt yetkilere de uygula</label>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" id="removePermissionBtn" style="background-color: #ef4444; color: white;" class="px-4 py-3 rounded-lg hover:bg-red-600">Kaldƒ±r</button>
                    <button type="button" id="cancelPermissionBtn" class="flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">ƒ∞ptal</button>
                    <button type="submit" style="background-color: #3b82f6; color: white;" class="flex-1 px-4 py-3 rounded-lg hover:bg-blue-600">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300">
    <div id="toastContent" class="bg-white rounded-lg shadow-lg border p-4 min-w-[300px]"></div>
</div>

<!-- Debug Info -->
<div id="debugInfo" class="fixed bottom-4 right-4 bg-black text-white p-2 rounded text-xs" style="display: none;">
    Debug: <span id="debugText">Ready</span>
</div> 