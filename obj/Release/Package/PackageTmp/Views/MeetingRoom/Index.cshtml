@using Microsoft.AspNet.Identity
@{
    var isAdmin = ViewBag.IsAdmin as bool? ?? false;
    var currentUserId = ViewBag.CurrentUserId;
    var currentUserName = ViewBag.CurrentUserName;
}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toplantı Salonu Rezervasyon Sistemi</title>
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
    <!-- Select2 CSS -->
    <link href="~/Content/select2.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .calendar-day {
            transition: all 0.2s ease;
        }

            .calendar-day:hover:not(.bg-gray-200):not(.selected) {
                background-color: #e0e7ff;
                transform: scale(1.05);
            }

        .selected {
            background-color: #4f46e5;
            color: white;
            transform: scale(1.05);
        }

        .room-card {
            transition: all 0.3s ease;
        }

            .room-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);
            }

        .tab-active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
        }

        /* Select2 Customization */
        .select2-container--default .select2-selection--multiple {
            border-color: #d1d5db !important;
            border-radius: 0.375rem !important;
            padding: 0.25rem !important;
            min-height: 42px !important;
        }

        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #4f46e5 !important;
            border-color: #4338ca !important;
            color: white !important;
            border-radius: 0.25rem !important;
            padding: 0.25rem 0.5rem !important;
            margin-top: 0.25rem !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white !important;
            margin-right: 0.25rem !important;
        }

            .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
                color: #fecaca !important;
            }

        .select2-dropdown {
            border-color: #d1d5db !important;
            border-radius: 0.375rem !important;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #4f46e5 !important;
        }
    </style>
</head>
<body>
    @Html.AntiForgeryToken()
    <div class="min-h-screen">
        <!-- Üst Menü -->
        <nav class="bg-indigo-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold">Toplantı Salonu Rezervasyon</h1>
                <div class="flex space-x-2">
                    <a href="@Url.Action("MyMeetings", "MeetingRoom")" class="px-3 py-1 bg-indigo-700 hover:bg-indigo-800 rounded-md text-sm transition">Benim Toplantılarım</a>
                    <button id="historyBtn" class="px-3 py-1 bg-indigo-700 hover:bg-indigo-800 rounded-md text-sm transition">Geçmiş</button>
                    @if (isAdmin)
                    {
                        <button id="switchRoleBtn" class="px-3 py-1 bg-indigo-700 hover:bg-indigo-800 rounded-md text-sm transition">Rol Değiştir</button>
                    }
                </div>
            </div>
        </nav>

        <!-- Rol Bilgisi -->
        <div class="container mx-auto px-4 py-2">
            <div class="flex items-center justify-between bg-white rounded-lg shadow-sm p-3 mb-4">
                <div class="flex items-center">
                    <div id="roleIndicator" class="w-3 h-3 rounded-full @(isAdmin ? "bg-red-500" : "bg-blue-500") mr-2"></div>
                    <span id="currentRole" class="font-medium">
                        @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("Operasyon.ToplantiOdasi", "Manage") ? "Yetkili" : "Kullanıcı")
                    </span>
                </div>
                @if (isAdmin)
                {
                    <div id="pendingCount" class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">0 Onay Bekleyen</div>
                }
            </div>
        </div>

        <!-- Ana İçerik -->
        <div class="container mx-auto px-4 pb-8">
            <!-- Kullanıcı Arayüzü -->
            <div id="userInterface">
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Toplantı Salonları -->
                    <div class="w-full md:w-1/3">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Toplantı Salonları</h2>
                        <div id="roomsContainer" class="space-y-4">
                            <!-- Odalar buraya dinamik yüklenecek -->
                        </div>
                    </div>

                    <!-- Takvim ve Rezervasyon -->
                    <div class="w-full md:w-2/3">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h2 class="text-xl font-semibold mb-4 text-gray-800">Rezervasyon Talebi Oluştur</h2>
                            <div id="roomSelection" class="mb-6">
                                <p class="text-gray-700 mb-2">Seçilen Salon: <span id="selectedRoom" class="font-medium">Seçilmedi</span></p>
                                <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div id="progressBar" class="h-full bg-indigo-600 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <button id="prevMonthBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-md transition">
                                        ◀ Önceki Ay
                                    </button>
                                    <h3 id="currentMonthYear" class="font-medium text-gray-800"></h3>
                                    <button id="nextMonthBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-md transition">
                                        Sonraki Ay ▶
                                    </button>
                                </div>
                                <div id="calendar" class="grid grid-cols-7 gap-1 text-center">
                                    <div class="text-sm font-medium text-gray-500 py-1">Pzt</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Sal</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Çar</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Per</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Cum</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Cmt</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Paz</div>
                                    <!-- Calendar days will be inserted here by JS -->
                                </div>
                            </div>

                            <div id="timeSelection" class="mb-6 hidden">
                                <h3 class="font-medium text-gray-800 mb-3">Saat Seçin</h3>
                                <div class="flex gap-4 items-center">
                                    <div class="flex-1">
                                        <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Başlangıç</label>
                                        <input type="time" id="startTime" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" value="09:00" step="900">
                                    </div>
                                    <span class="self-end pb-2 text-gray-500">-</span>
                                    <div class="flex-1">
                                        <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">Bitiş</label>
                                        <input type="time" id="endTime" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" value="10:00" step="900">
                                    </div>
                                </div>
                            </div>

                            <div id="detailsForm" class="hidden">
                                <h3 class="font-medium text-gray-800 mb-3">Toplantı Detayları</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="meetingTitle" class="block text-sm font-medium text-gray-700 mb-1">Toplantı Başlığı</label>
                                        <input type="text" id="meetingTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label for="meetingDesc" class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                                        <textarea id="meetingDesc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                    </div>
                                    <div>
                                        <label for="attendees" class="block text-sm font-medium text-gray-700 mb-1">
                                            Katılımcılar
                                            <span class="text-xs text-gray-500 ml-1">(Aramaya başlayın)</span>
                                        </label>
                                        <select id="attendees" class="w-full" multiple="multiple"></select>
                                        <p class="text-xs text-gray-500 mt-1">Kullanıcı ara ve seç. Birden fazla katılımcı ekleyebilirsiniz.</p>
                                    </div>
                                    <div class="flex justify-end">
                                        <button id="confirmBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Rezervasyon Talebi Oluştur</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dayReservations" class="mb-6 hidden">
                    <h3 class="font-medium text-gray-800 mb-3">Seçilen Gündeki Toplantılar</h3>
                    <div id="dayReservationList" class="space-y-2"></div>
                </div>

            </div>



            <!-- Yönetici Arayüzü -->
            <div id="adminInterface" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex border-b mb-4">
                        <button id="pendingTab" class="tab-active px-4 py-2 font-medium">Onay Bekleyenler</button>
                        <button id="approvedTab" class="px-4 py-2 font-medium">Onaylananlar</button>
                        <button id="rejectedTab" class="px-4 py-2 font-medium">Reddedilenler</button>
                        <button id="allTab" class="px-4 py-2 font-medium">Tüm Rezervasyonlar</button>
                    </div>

                    <div id="adminContent">
                        <!-- Onay Bekleyen Rezervasyonlar -->
                        <div id="pendingReservations" class="space-y-4">
                            <!-- Rezervasyonlar JS ile eklenecek -->
                        </div>

                        <!-- Onaylanan Rezervasyonlar -->
                        <div id="approvedReservations" class="space-y-4 hidden">
                            <!-- Rezervasyonlar JS ile eklenecek -->
                        </div>

                        <!-- Reddedilen Rezervasyonlar -->
                        <div id="rejectedReservations" class="space-y-4 hidden">
                            <!-- Rezervasyonlar JS ile eklenecek -->
                        </div>

                        <!-- Tüm Rezervasyonlar -->
                        <div id="allReservations" class="space-y-4 hidden">
                            <!-- Rezervasyonlar JS ile eklenecek -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geçmiş Rezervasyonlar Modal -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Rezervasyon Geçmişim</h2>
                        <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saat</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salon</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Başlık</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">İşlem</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detaylar</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="historyTableBody">
                                <!-- Rezervasyon geçmişi buraya eklenecek -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Başarılı Rezervasyon Modal -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                        <svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Rezervasyon Talebi Oluşturuldu!</h3>
                    <p class="text-sm text-gray-600 mb-4">Talebiniz yönetici onayına gönderildi. Onaylandığında bilgilendirileceksiniz.</p>
                    <div id="reservationDetails" class="text-left bg-gray-50 p-3 rounded-md mb-4">
                        <!-- Rezervasyon detayları buraya eklenecek -->
                    </div>
                    <button id="closeSuccessBtn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Tamam</button>
                </div>
            </div>
        </div>

        <!-- Rezervasyon Detay Modal -->
        <div id="reservationDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Rezervasyon Detayları</h3>
                    <button id="closeDetailBtn" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalReservationDetails" class="space-y-3 mb-4">
                    <!-- Rezervasyon detayları buraya eklenecek -->
                </div>
                <div id="adminActions" class="flex justify-between mt-6">
                    <div class="flex gap-2">
                        <button id="rejectBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Reddet</button>
                        <button id="deleteReservationBtn" class="px-4 py-2 bg-red-800 text-white rounded-md hover:bg-red-900 transition hidden">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Rezervasyonu Sil
                        </button>
                    </div>
                    <button id="approveBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">Onayla</button>
                </div>
            </div>
        </div>
    </div>

@section scripts {
    <script>
    $(document).ready(function () {
        // Değişkenler
        let isAdmin = @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("Operasyon.ToplantiOdasi", "Manage") ? "true" : "false") === "true";
        var isDayViewRole = @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasAnyPermission("Operasyon.ToplantiOdasi.Manage", "Operasyon.ToplantiOdasi.View") ? "true" : "false");

        console.log("isAdmin:", isAdmin);
        console.log("isDayViewRole:", isDayViewRole);

        let selectedRoom = null;
        let selectedDate = null;
        let selectedTime = null;
        let selectedStartTime = null;
        let selectedEndTime = null;
        let selectedReservationId = null;
        let reservations = [];
        let allUsers = []; // Tüm kullanıcılar
        let meetingRooms = []; // Toplantı odaları

        var currentUser = {
            id: '@User.Identity.GetUserId()',
            name: '@User.Identity.Name'
        };

        // Toplantı odalarını yükle
        function loadRooms() {
            fetch('/MeetingRoom/GetMeetingRooms')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Oda yükleme hatası:', data.error);
                        return;
                    }
                    meetingRooms = data;
                    renderRooms();
                })
                .catch(err => {
                    console.error('Oda yükleme hatası:', err);
                });
        }

        // Odaları render et
        function renderRooms() {
            const container = document.getElementById('roomsContainer');
            if (!container) return;
            
            container.innerHTML = '';

            meetingRooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = `room-card bg-white p-4 rounded-lg shadow-md border-l-4 cursor-pointer hover:shadow-lg transition-shadow`;
                roomCard.style.borderLeftColor = room.colorCode || '#3B82F6';
                roomCard.dataset.roomId = room.id;
                roomCard.dataset.roomName = room.name;
                
                console.log('Salon render:', room); // Debug için
                
                const descriptionHtml = room.description 
                    ? `<p class="text-gray-500 text-sm mb-1"><strong>Açıklama:</strong> ${room.description}</p>` 
                    : '';
                
                const featuresHtml = room.features 
                    ? `<p class="text-gray-500 text-sm mt-1"><strong>Özellikler:</strong> ${room.features}</p>` 
                    : '';
                
                roomCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${room.colorCode || '#3B82F6'}"></div>
                            <h3 class="font-semibold text-lg text-gray-800">${room.name}</h3>
                        </div>
                        <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">Aktif</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-1">Kapasite: ${room.capacity} kişi</p>
                    ${room.location ? `<p class="text-gray-500 text-sm mb-1">Konum: ${room.location}</p>` : ''}
                    ${descriptionHtml}
                    ${featuresHtml}
                `;
                
                roomCard.addEventListener('click', function () {
                    selectedRoom = room.name;
                    selectedRoomEl.textContent = room.name;
                    document.querySelectorAll('.room-card').forEach(c => {
                        c.classList.remove('ring-2', 'ring-blue-500');
                    });
                    roomCard.classList.add('ring-2', 'ring-blue-500');
                    updateProgress();
                    if (selectedDate) {
                        timeSelectionEl.classList.remove('hidden');
                    }
                });
                
                container.appendChild(roomCard);
            });
        }

        // Kullanıcıları yükle
        function loadUsers() {
            fetch('/MeetingRoom/GetActiveUsers')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Kullanıcı yükleme hatası:', data.error);
                        return;
                    }
                    allUsers = data;
                    initializeAttendeeSelect();
                })
                .catch(err => {
                    console.error('Kullanıcı yükleme hatası:', err);
                });
        }

        // Select2 initialize et
        function initializeAttendeeSelect() {
            if (typeof $.fn.select2 === 'undefined') {
                console.error('Select2 kütüphanesi yüklenmemiş!');
                setTimeout(initializeAttendeeSelect, 100); // Tekrar dene
                return;
            }
            $('#attendees').select2({
                language: 'tr',
                data: allUsers.map(u => ({
                    id: u.id,
                    text: u.name + (u.department ? ` (${u.department})` : ''),
                    username: u.username,
                    email: u.email,
                    department: u.department,
                    position: u.position
                })),
                placeholder: 'Katılımcı seçin veya ara...',
                allowClear: true,
                width: '100%',
                templateResult: formatUserOption,
                templateSelection: formatUserSelection
            });
        }

        // Select2 option formatı
        function formatUserOption(user) {
            if (!user.id) return user.text;
            
            var $user = $(
                '<div class="flex items-center py-1">' +
                    '<div class="flex-1">' +
                        '<div class="font-medium text-sm">' + user.text + '</div>' +
                        (user.position ? '<div class="text-xs text-gray-500">' + user.position + '</div>' : '') +
                    '</div>' +
                '</div>'
            );
            return $user;
        }

        // Select2 seçili eleman formatı
        function formatUserSelection(user) {
            return user.text;
        }

        var currentUser = {
            id: '@User.Identity.GetUserId()',
            name: '@User.Identity.Name'
        };

        // Anti-forgery token
        function getToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]').value;
        }

        // DOM Elementleri
        const userInterface = document.getElementById('userInterface');
        const adminInterface = document.getElementById('adminInterface');
        const switchRoleBtn = document.getElementById('switchRoleBtn');
        const currentRoleEl = document.getElementById('currentRole');
        const roleIndicatorEl = document.getElementById('roleIndicator');
        const pendingCountEl = document.getElementById('pendingCount');
        const smallRoomEl = document.getElementById('smallRoom');
        const largeRoomEl = document.getElementById('largeRoom');
        const mediumRoomEl = document.getElementById('mediumRoom');
        const selectedRoomEl = document.getElementById('selectedRoom');
        const progressBarEl = document.getElementById('progressBar');
        const calendarEl = document.getElementById('calendar');
        const timeSelectionEl = document.getElementById('timeSelection');
        const detailsFormEl = document.getElementById('detailsForm');
        const historyBtn = document.getElementById('historyBtn');
        const historyModal = document.getElementById('historyModal');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const historyTableBody = document.getElementById('historyTableBody');
        const confirmBtn = document.getElementById('confirmBtn');
        const successModal = document.getElementById('successModal');
        const closeSuccessBtn = document.getElementById('closeSuccessBtn');
        const reservationDetailsEl = document.getElementById('reservationDetails');
        const pendingReservationsEl = document.getElementById('pendingReservations');
        const approvedReservationsEl = document.getElementById('approvedReservations');
        const rejectedReservationsEl = document.getElementById('rejectedReservations');
        const allReservationsEl = document.getElementById('allReservations');
        const pendingTab = document.getElementById('pendingTab');
        const approvedTab = document.getElementById('approvedTab');
        const rejectedTab = document.getElementById('rejectedTab');
        const allTab = document.getElementById('allTab');
        const adminActionsEl = document.getElementById('adminActions');
        const modalReservationDetailsEl = document.getElementById('modalReservationDetails');
        const reservationDetailModal = document.getElementById('reservationDetailModal');
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const closeDetailBtn = document.getElementById('closeDetailBtn');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const currentMonthYearEl = document.getElementById('currentMonthYear');

        // Takvim için ay ve yıl değişkenleri
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        const startTimeEl = document.getElementById('startTime');
        const endTimeEl = document.getElementById('endTime');
        
        if (startTimeEl) startTimeEl.addEventListener('change', function () {
            selectedStartTime = this.value;
            updateProgress();
        });
        if (endTimeEl) endTimeEl.addEventListener('change', function () {
            selectedEndTime = this.value;
            updateProgress();
        });

        // Takvim oluştur
        function generateCalendar() {
            const monthNames = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                               'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            
            currentMonthYearEl.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
            
            const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
            const today = new Date();
            
            while (calendarEl.children.length > 7) {
                calendarEl.removeChild(calendarEl.lastChild);
            }
            for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-10 w-10 mx-auto rounded-full';
                calendarEl.appendChild(emptyDay);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentCalendarYear, currentCalendarMonth, day);
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day h-10 w-10 mx-auto flex items-center justify-center rounded-full cursor-pointer';
                
                // Geçmiş tarihleri devre dışı bırak
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                if (date < todayStart) {
                    dayEl.className += ' bg-gray-200 text-gray-400 cursor-not-allowed';
                }
                
                dayEl.textContent = day;
                dayEl.dataset.date = `${currentCalendarYear}-${(currentCalendarMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                dayEl.addEventListener('click', function () {
                    console.log("Takvim günü tıklandı. isDayViewRole:", isDayViewRole, "Seçilen gün:", this.dataset.date);
                    if (!this.classList.contains('bg-gray-200')) {
                        document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedDate = this.dataset.date;
                        updateProgress();
                        if (selectedRoom) {
                            timeSelectionEl.classList.remove('hidden');
                        }
                        if (selectedDate) {
                            timeSelectionEl.classList.remove('hidden');
                            // varsayılan saatleri yakala
                            selectedStartTime = document.getElementById('startTime').value;
                            selectedEndTime = document.getElementById('endTime').value;
                            updateProgress();
                        }
                        if (isDayViewRole === true || isDayViewRole === "true") {
                            console.log("showDayReservations çağrılıyor");
                            showDayReservations(selectedDate);
                        } else {
                            console.log("Gün toplantıları gizleniyor");
                            document.getElementById('dayReservations').classList.add('hidden');
                        }
                    }
                });
                calendarEl.appendChild(dayEl);
            }
            colorCalendarDays();
        }

        // Önceki ay butonuna event listener
        if (prevMonthBtn) prevMonthBtn.addEventListener('click', function() {
            currentCalendarMonth--;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            generateCalendar();
        });

        // Sonraki ay butonuna event listener
        if (nextMonthBtn) nextMonthBtn.addEventListener('click', function() {
            currentCalendarMonth++;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            generateCalendar();
        });

        // Rezervasyon durumuna göre rozet döndüren yardımcı fonksiyon
        function getStatusBadge(status) {
            switch ((status || '').toLowerCase()) {
                case 'pending':
                    return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Onay Bekliyor</span>';
                case 'approved':
                    return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Onaylandı</span>';
                case 'rejected':
                    return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Reddedildi</span>';
                case 'cancelled':
                    return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-800">İptal</span>';
                default:
                    return status;
            }
        }


        // Takvimde toplantı olan günleri renklendir
        function colorCalendarDays() {
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                const dateStr = dayEl.dataset.date;
                if (!dateStr) return;
                const hasMeeting = reservations.some(r => r.date === dateStr);
                if (hasMeeting) {
                    dayEl.classList.add('bg-yellow-200');
                } else {
                    dayEl.classList.remove('bg-yellow-200');
                }
            });
        }

        // Seçilen günün toplantılarını göster
        function showDayReservations(dateStr) {
            console.log("showDayReservations çalıştı, dateStr:", dateStr);
            const dayReservations = reservations.filter(r => r.date === dateStr);
            const dayReservationsDiv = document.getElementById('dayReservations');
            const dayReservationList = document.getElementById('dayReservationList');
            if (dayReservations.length === 0) {
                dayReservationList.innerHTML = '<div class="text-gray-500">Bu gün için toplantı yok.</div>';
            } else {
                dayReservationList.innerHTML = dayReservations.map(r => `
            <div class="p-2 rounded border bg-gray-50 flex justify-between items-center">
                <div>
                    <span class="ml-2 text-sm text-gray-600">${r.startTime} - ${r.endTime}</span>
                    <span class="ml-2 text-sm text-gray-600">${r.room}</span>
                </div>
                ${getStatusBadge(r.status)}
            </div>
        `).join('');
            }
            dayReservationsDiv.classList.remove('hidden');
        }

        // Oda seçimi
        if (smallRoomEl) {
            smallRoomEl.addEventListener('click', function () {
                selectedRoom = 'Küçük Toplantı Salonu';
                selectedRoomEl.textContent = selectedRoom;
                smallRoomEl.classList.add('ring-2', 'ring-blue-500');
                largeRoomEl.classList.remove('ring-2', 'ring-purple-500');
                mediumRoomEl.classList.remove('ring-2', 'ring-green-500');
                updateProgress();
                if (selectedDate) {
                    timeSelectionEl.classList.remove('hidden');
                }
            });
        }

        if (largeRoomEl) {
            largeRoomEl.addEventListener('click', function () {
                selectedRoom = 'Büyük Toplantı Salonu';
                selectedRoomEl.textContent = selectedRoom;
                largeRoomEl.classList.add('ring-2', 'ring-purple-500');
                smallRoomEl.classList.remove('ring-2', 'ring-blue-500');
                mediumRoomEl.classList.remove('ring-2', 'ring-green-500');
                updateProgress();
                if (selectedDate) {
                    timeSelectionEl.classList.remove('hidden');
                }
            });
        }
        
        if (mediumRoomEl) {
            mediumRoomEl.addEventListener('click', function () {
                selectedRoom = 'Orta Toplantı Salonu';
                selectedRoomEl.textContent = selectedRoom;
                mediumRoomEl.classList.add('ring-2', 'ring-green-500');
                smallRoomEl.classList.remove('ring-2', 'ring-blue-500');
                largeRoomEl.classList.remove('ring-2', 'ring-purple-500');
                updateProgress();
                if (selectedDate) {
                    timeSelectionEl.classList.remove('hidden');
                }
            });
        }

        // Rezervasyonları sunucudan çeken fonksiyon
        function fetchReservations(callback) {
            fetch('/MeetingRoom/GetReservations')
                .then(res => res.json())
                .then(data => {
                    reservations = data;
                    if (typeof callback === 'function') callback();
                    updatePendingCount && updatePendingCount();
                    colorCalendarDays && colorCalendarDays();
                });
        }

        function updateInterface() {
            console.log("updateInterface çalıştı. isAdmin:", isAdmin);
            if (isAdmin) {
                userInterface.classList.add('hidden');
                adminInterface.classList.remove('hidden');
                // Admin arayüzüne geçildiğinde pending rezervasyonları yükle
                setActiveTab(pendingTab);
                loadAdminReservations('pending');
            } else {
                userInterface.classList.remove('hidden');
                adminInterface.classList.add('hidden');
            }
        }

        // İlerleme çubuğunu güncelle
        function updateProgress() {
            let progress = 0;
            if (selectedRoom) progress += 33;
            if (selectedDate) progress += 33;
            if (selectedStartTime && selectedEndTime) progress += 34;
            if (progressBarEl) progressBarEl.style.width = `${progress}%`;
            if (selectedRoom && selectedDate && selectedStartTime && selectedEndTime) {
                if (detailsFormEl) detailsFormEl.classList.remove('hidden');
            } else {
                if (detailsFormEl) detailsFormEl.classList.add('hidden');
            }
        }

        // Rezervasyon oluştur (CSRF korumalı)
        if (confirmBtn) confirmBtn.addEventListener('click', function () {
            const title = document.getElementById('meetingTitle').value;
            const desc = document.getElementById('meetingDesc').value;
            
            // Select2'den seçili kullanıcıları al
            const selectedAttendees = $('#attendees').select2('data');
            const attendeeNames = selectedAttendees.map(u => u.text).join(', ');
            const attendeeIds = selectedAttendees.map(u => u.id).join(',');

            // Saat kontrolü
            if (!selectedStartTime || !selectedEndTime) {
                alert('Lütfen başlangıç ve bitiş saatini seçin.');
                return;
            }
            if (selectedStartTime >= selectedEndTime) {
                alert('Başlangıç saati, bitiş saatinden önce olmalıdır.');
                return;
            }

            if (!title) {
                alert('Lütfen toplantı başlığı girin.');
                return;
            }

            const params = new URLSearchParams({
                userId: currentUser.id,
                userName: currentUser.name,
                room: selectedRoom,
                date: selectedDate,
                startTime: selectedStartTime,
                endTime: selectedEndTime,
                title: title,
                description: desc,
                attendees: attendeeNames, // İsimler (backward compatibility)
                attendeeIds: attendeeIds, // ID'ler (yeni sistem)
                __RequestVerificationToken: getToken()
            });

            fetch('/MeetingRoom/CreateReservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            })
                .then(response => response.json())
                .then(res => {
                    if (!res.success && res.message) {
                        alert(res.message);
                        return;
                    }
                    if (reservationDetailsEl) {
                        reservationDetailsEl.innerHTML = `
<p><strong>Salon:</strong> ${res.reservation.Room}</p>
<p><strong>Tarih:</strong> ${res.reservation.Date}</p>
<p><strong>Saat:</strong> ${res.reservation.StartTime} - ${res.reservation.EndTime}</p>
<p><strong>Başlık:</strong> ${res.reservation.Title}</p>
<p><strong>Durum:</strong> ${getStatusBadge(res.reservation.Status)}</p>
`;
                    }

                    if (successModal) successModal.classList.remove('hidden');
                    fetchReservations();
                    resetForm();
                })
                .catch(err => alert(err.message));
        });

        // Formu sıfırla
        function resetForm() {
            selectedRoom = null;
            selectedDate = null;
            selectedTime = null;
            selectedStartTime = null;
            selectedEndTime = null;
            if (selectedRoomEl) selectedRoomEl.textContent = 'Seçilmedi';
            if (progressBarEl) progressBarEl.style.width = '0%';
            document.querySelectorAll('.room-card').forEach(c => c.classList.remove('ring-2', 'ring-blue-500'));
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            const titleEl = document.getElementById('meetingTitle');
            const descEl = document.getElementById('meetingDesc');
            if (titleEl) titleEl.value = '';
            if (descEl) descEl.value = '';
            if (window.$ && $('#attendees').length) $('#attendees').val(null).trigger('change'); // Select2 temizle
            if (startTimeEl) startTimeEl.value = '09:00';
            if (endTimeEl) endTimeEl.value = '10:00';
            if (timeSelectionEl) timeSelectionEl.classList.add('hidden');
            if (detailsFormEl) detailsFormEl.classList.add('hidden');
        }

        // Rol değiştirme
        if (switchRoleBtn) {
            switchRoleBtn.addEventListener('click', function () {
                isAdmin = !isAdmin;
                updateInterface();
            });
        }

        // Bekleyen rezervasyon sayısını güncelle
        function updatePendingCount() {
            if (!pendingCountEl) return;
            const pendingCount = reservations.filter(r => (r.status || '').toLowerCase() === 'pending').length;
            pendingCountEl.textContent = `${pendingCount} Onay Bekleyen`;
        }

        // Yönetici sekmelerini yönet
        if (pendingTab) pendingTab.addEventListener('click', function () { setActiveTab(pendingTab); loadAdminReservations('pending'); });
        if (approvedTab) approvedTab.addEventListener('click', function () { setActiveTab(approvedTab); loadAdminReservations('approved'); });
        if (rejectedTab) rejectedTab.addEventListener('click', function () { setActiveTab(rejectedTab); loadAdminReservations('rejected'); });
        if (allTab) allTab.addEventListener('click', function () { setActiveTab(allTab); loadAdminReservations('all'); });

        function setActiveTab(activeTab) {
            [pendingTab, approvedTab, rejectedTab, allTab].forEach(tab => tab.classList.remove('tab-active'));
            activeTab.classList.add('tab-active');
            [pendingReservationsEl, approvedReservationsEl, rejectedReservationsEl, allReservationsEl].forEach(el => el.classList.add('hidden'));
            if (activeTab === pendingTab) pendingReservationsEl.classList.remove('hidden');
            else if (activeTab === approvedTab) approvedReservationsEl.classList.remove('hidden');
            else if (activeTab === rejectedTab) rejectedReservationsEl.classList.remove('hidden');
            else if (activeTab === allTab) allReservationsEl.classList.remove('hidden');
        }

        // Yönetici rezervasyonlarını yükle
        function loadAdminReservations(type) {
            fetchReservations(function () {
                let filteredReservations;
                if (type === 'all') filteredReservations = [...reservations];
                else filteredReservations = reservations.filter(r => (r.status || '').toLowerCase() === type);
                let containerEl;
                if (type === 'pending') containerEl = pendingReservationsEl;
                else if (type === 'approved') containerEl = approvedReservationsEl;
                else if (type === 'rejected') containerEl = rejectedReservationsEl;
                else if (type === 'all') containerEl = allReservationsEl;
                containerEl.innerHTML = '';
                if (filteredReservations.length === 0) {
                    containerEl.innerHTML = `<p class="text-center text-gray-500 py-4">Rezervasyon bulunamadı.</p>`;
                    return;
                }
                filteredReservations.forEach(res => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow border-l-4 border-indigo-500';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-lg">${res.title}</h3>
                                <p class="text-gray-600 text-sm">${res.userName} tarafından</p>
                            </div>
                            <div class="flex flex-col items-end">
                                ${getStatusBadge(res.status)}
<span class="text-sm text-gray-500 mt-1">${res.date} ${res.startTime} - ${res.endTime}</span>
                            </div>
                        </div>
                        <p class="text-gray-700 mt-2">${res.room}</p>
                        <div class="flex justify-end mt-2">
                            <button class="view-details px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 text-sm" data-id="${res.id}">Detayları Gör</button>
                        </div>
                    `;
                    containerEl.appendChild(card);
                });
                document.querySelectorAll('.view-details').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const resId = parseInt(this.dataset.id);
                        showReservationDetails(resId);
                    });
                });
            });
        }

        // Rezervasyon detaylarını göster
        function showReservationDetails(id) {
            const reservation = reservations.find(r => r.id === id);
            if (!reservation) return;
            selectedReservationId = id;
            
            const deleteBtn = document.getElementById('deleteReservationBtn');
            
            let statusInfo = '';
            if ((reservation.status || '').toLowerCase() === 'pending') {
                statusInfo = getStatusBadge(reservation.status);
                if (adminActionsEl) adminActionsEl.classList.remove('hidden');
                if (deleteBtn) deleteBtn.classList.add('hidden');
            } else if ((reservation.status || '').toLowerCase() === 'approved') {
                statusInfo = `
                    ${getStatusBadge(reservation.status)}
                    <p class="text-sm text-gray-500 mt-1">Onay Tarihi: ${reservation.approvedAt || ''}</p>
                `;
                if (adminActionsEl) adminActionsEl.classList.add('hidden');
                if (deleteBtn) deleteBtn.classList.remove('hidden');
            } else if ((reservation.status || '').toLowerCase() === 'rejected') {
                statusInfo = `
                    ${getStatusBadge(reservation.status)}
                    <p class="text-sm text-gray-500 mt-1">Red Tarihi: ${reservation.rejectedAt || ''}</p>
                    <p class="text-sm text-gray-700 mt-1">Red Nedeni: ${reservation.rejectionReason || 'Belirtilmedi'}</p>
                `;
                if (adminActionsEl) adminActionsEl.classList.add('hidden');
                if (deleteBtn) deleteBtn.classList.add('hidden');
            }

            // Katılımcı listesi oluştur
            let attendeeListHtml = '';
            if (reservation.attendeeList && reservation.attendeeList.length > 0) {
                attendeeListHtml = `
                    <div class="mt-3">
                        <strong class="text-gray-700">Katılımcılar (${reservation.attendeeCount}):</strong>
                        <div class="mt-2 space-y-2 max-h-40 overflow-y-auto">
                            ${reservation.attendeeList.map(att => `
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
                                    <div class="flex-1">
                                        <div class="font-medium text-sm text-gray-900">${att.name}</div>
                                        ${att.department ? `<div class="text-xs text-gray-500">${att.department}</div>` : ''}
                                    </div>
                                    ${att.responseDate ? `
                                        <div class="text-xs text-gray-500">
                                            ${att.hasAccepted ? '<span class="text-green-600">Kabul</span>' : ''}
                                            ${att.hasDeclined ? '<span class="text-red-600">Red</span>' : ''}
                                            ${!att.hasAccepted && !att.hasDeclined ? '<span class="text-yellow-600">Bekliyor</span>' : ''}
                                        </div>
                                    ` : '<span class="text-xs text-yellow-600">Bekliyor</span>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (reservation.attendees) {
                // Eski sistem - sadece isimler varsa
                attendeeListHtml = `<p class="text-gray-600"><strong>Katılımcılar:</strong> ${reservation.attendees}</p>`;
            }

            if (modalReservationDetailsEl) {
                modalReservationDetailsEl.innerHTML = `
                    <div class="flex justify-between">
                        <h4 class="font-medium">${reservation.title}</h4>
                        <div>${statusInfo}</div>
                    </div>
                    <p class="text-gray-600"><strong>Talep Eden:</strong> ${reservation.userName}</p>
                    <p class="text-gray-600"><strong>Salon:</strong> ${reservation.room}</p>
                    <p class="text-gray-600"><strong>Tarih/Saat:</strong> ${reservation.date} ${reservation.startTime} - ${reservation.endTime}</p>
                    <p class="text-gray-600"><strong>Açıklama:</strong> ${reservation.description || 'Belirtilmedi'}</p>
                    ${attendeeListHtml}
                    <p class="text-gray-600 mt-2"><strong>Oluşturulma Tarihi:</strong> ${reservation.createdAt || ''}</p>
                `;
            }
            if (reservationDetailModal) reservationDetailModal.classList.remove('hidden');
        }

        // Rezervasyon onayla (CSRF korumalı)
        if (approveBtn) approveBtn.addEventListener('click', function () {
            const params = new URLSearchParams({
                id: selectedReservationId,
                __RequestVerificationToken: getToken()
            });
            fetch('/MeetingRoom/ApproveReservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) { alert(data.message); return; }
                    if (reservationDetailModal) reservationDetailModal.classList.add('hidden');
                    fetchReservations();
                    loadAdminReservations('pending');
                })
                .catch(err => alert(err.message));
        });

        if (historyBtn) {
            if (historyBtn) historyBtn.addEventListener('click', function () {
                fetchReservations(function () {
                    // Sadece giriş yapan kullanıcının geçmişi gösterilsin
                    const userId = currentUser.id;
                    const userReservations = reservations.filter(r => r.userId == userId);
                    historyTableBody.innerHTML = userReservations.length === 0
                        ? '<tr><td colspan="7" class="text-center text-gray-500 py-4">Geçmiş rezervasyon bulunamadı.</td></tr>'
                        : userReservations.map(r => `
                    <tr>
                        <td class="px-6 py-2 whitespace-nowrap">${r.date}</td>
                        <td class="px-6 py-2 whitespace-nowrap">${r.startTime} - ${r.endTime}</td>
                        <td class="px-6 py-2 whitespace-nowrap">${r.room}</td>
                        <td class="px-6 py-2 whitespace-nowrap">${r.title}</td>
                        <td class="px-6 py-2 whitespace-nowrap">${getStatusBadge(r.status)}</td>
                        <td class="px-6 py-2 whitespace-nowrap">
                            ${r.status.toLowerCase() === 'pending' ? 
                                `<button class="cancel-reservation px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" data-id="${r.id}">İptal</button>` : 
                                ''}
                        </td>
                        <td class="px-6 py-2 whitespace-nowrap">
                            <a href="/MeetingRoom/Details/${r.id}" class="px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700">
                                Detaylar
                            </a>
                        </td>
                    </tr>
                `).join('');
                    historyModal.classList.remove('hidden');
                    // Modal açıldığında tabloyu başa kaydır
                    setTimeout(function () {
                        historyModal.querySelector('.overflow-x-auto').scrollTop = 0;
                    }, 100);

                    // İptal butonlarına event listener ekle
                    document.querySelectorAll('.cancel-reservation').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const resId = parseInt(this.dataset.id);
                            if (confirm('Bu rezervasyonu iptal etmek istediğinizden emin misiniz?')) {
                                cancelReservation(resId);
                            }
                        });
                    });
                });
            });
        }
        if (closeHistoryBtn) {
            if (closeHistoryBtn) closeHistoryBtn.addEventListener('click', function () {
                historyModal.classList.add('hidden');
            });
        }

        // Rezervasyon reddet (CSRF korumalı)
        if (rejectBtn) rejectBtn.addEventListener('click', function () {
            const reason = prompt('Red nedenini girin:');
            if (reason !== null) {
                const params = new URLSearchParams({
                    id: selectedReservationId,
                    reason: reason,
                    __RequestVerificationToken: getToken()
                });
                fetch('/MeetingRoom/RejectReservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) { alert(data.message); return; }
                        if (reservationDetailModal) reservationDetailModal.classList.add('hidden');
                        fetchReservations();
                        loadAdminReservations('pending');
                    })
                    .catch(err => alert(err.message));
            }
        });

        // Rezervasyon iptal (kullanıcı tarafından)
        function cancelReservation(reservationId) {
            const params = new URLSearchParams({
                id: reservationId,
                __RequestVerificationToken: getToken()
            });
            fetch('/MeetingRoom/CancelReservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.message);
                        return;
                    }
                    alert('Rezervasyon başarıyla iptal edildi.');
                    historyModal.classList.add('hidden');
                    fetchReservations();
                })
                .catch(err => alert('Bir hata oluştu: ' + err.message));
        }

        if (closeDetailBtn) closeDetailBtn.addEventListener('click', function () {
            if (reservationDetailModal) reservationDetailModal.classList.add('hidden');
        });

        // Rezervasyon sil butonu
        const deleteReservationBtn = document.getElementById('deleteReservationBtn');
        if (deleteReservationBtn) deleteReservationBtn.addEventListener('click', function () {
            if (!selectedReservationId) return;
            
            const reservation = reservations.find(r => r.id === selectedReservationId);
            if (!reservation) return;
            
            if (!confirm(`"${reservation.title}" toplantısını kalıcı olarak silmek istediğinize emin misiniz?\n\nKatılımcılara bildirim gönderilecektir.`)) return;
            
            const params = new URLSearchParams();
            params.append('id', selectedReservationId);
            params.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            fetch('/MeetingRoom/DeleteReservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.message);
                        return;
                    }
                    alert(data.message);
                    if (reservationDetailModal) reservationDetailModal.classList.add('hidden');
                    fetchReservations(() => {
                        generateCalendar();
                        loadAdminReservations('approved');
                    });
                })
                .catch(err => alert('Bir hata oluştu: ' + err.message));
        });

        // Takvimi oluştur
        generateCalendar();

        // Modal dışına tıklayınca kapat
        window.addEventListener('click', function (event) {
            if (historyModal && event.target === historyModal) historyModal.classList.add('hidden');
            if (successModal && event.target === successModal) successModal.classList.add('hidden');
            if (reservationDetailModal && event.target === reservationDetailModal) reservationDetailModal.classList.add('hidden');
        });

        // Başarılı modalı kapat
        if (closeSuccessBtn) closeSuccessBtn.addEventListener('click', function () {
            if (successModal) successModal.classList.add('hidden');
        });

        // SignalR bildirimleri dinle
        function setupSignalRNotifications() {
            console.log('[Index] SignalR kurulumu başlatılıyor...');
            
            if (typeof $ !== 'undefined' && $.connection && $.connection.notificationHub) {
                // Bildirim metodunu tanımla
                $.connection.notificationHub.client.refreshMeetings = function() {
                    console.log('[Index] SignalR: Toplantılar güncelleniyor...');
                    fetchReservations();
                    updatePendingCount();
                };
                
                console.log('[Index] SignalR bildirim dinleyicisi kuruldu');
                
                // Hub'ın durumunu kontrol et
                if ($.connection.hub.state === $.signalR.connectionState.connected) {
                    console.log('[Index] SignalR zaten bağlı. Connection ID: ' + $.connection.hub.id);
                } else {
                    console.log('[Index] SignalR henüz bağlı değil, _Layout başlatacak. State:', $.connection.hub.state);
                }
            } else {
                console.warn('[Index] SignalR mevcut değil');
            }
        }

        // SignalR'ı başlat
        setupSignalRNotifications();

        // Sayfa ilk açıldığında rezervasyonları ve kullanıcıları çek
        generateCalendar();
        fetchReservations();
        updatePendingCount();
        loadRooms(); // Toplantı odalarını yükle
        loadUsers(); // Kullanıcıları yükle
    });
    </script>
}
