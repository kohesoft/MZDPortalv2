@using MZDNETWORK.Models
@model IEnumerable<User>

<head>
    <link rel="stylesheet" href="~/Content/all.min.css" />
    <link rel="stylesheet" href="~/Content/boxicons.min.css" />
    <link rel="stylesheet" href="~/Content/contact.css" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<section class="rehber-container" style="max-width:100%; max-height:100%;">
    <div class="rehber-wrapper">
        <div class="rehber-card">
            <div class="rehber-card-header">
                <h3 class="rehber-card-title">
                    <i class="bx bx-book rehber-icon-book" style="font-size:24px;"></i>
                    Rehber
                </h3>
                <div class="rehber-card-toolbar">
                    <div class="rehber-search-container">
                        <i class="bx bx-search rehber-search-icon" style="font-size:16px;"></i>
                        <input type="text" id="searchInput" onkeyup="searchTable()" placeholder="Kullanıcıları ara..." class="rehber-search-input">
                    </div>
                    @if (MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("Contact", "Export"))
                    {
                        <button onclick="exportToExcel()" class="rehber-btn-export no-loading">
                            <i class="bx bx-file rehber-icon-excel"></i>
                            Excel'e Aktar
                        </button>
                    }
                </div>
            </div>
            <div class="rehber-card-body">
                <div class="rehber-table-container">
                    <table class="rehber-data-table" id="userTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)" class="rehber-th-sortable">
                                    <div class="rehber-th-content">
                                        Sicil
                                        <span class="rehber-sort-icon">↕</span>
                                    </div>
                                </th>
                                <th onclick="sortTable(1)" class="rehber-th-sortable">
                                    <div class="rehber-th-content">
                                        Adı
                                        <span class="rehber-sort-icon">↕</span>
                                    </div>
                                </th>
                                <th onclick="sortTable(2)" class="rehber-th-sortable">
                                    <div class="rehber-th-content">
                                        Soyadı
                                        <span class="rehber-sort-icon">↕</span>
                                    </div>
                                </th>
                                <th onclick="sortTable(3)" class="rehber-th-sortable">
                                    <div class="rehber-th-content">
                                        Departman ve Pozisyon
                                        <span class="rehber-sort-icon">↕</span>
                                    </div>
                                </th>
                                <th onclick="sortTable(4)" class="rehber-th-sortable">
                                    <div class="rehber-th-content">
                                        Dahili
                                        <span class="rehber-sort-icon">↕</span>
                                    </div>
                                </th>
                                <th onclick="sortTable(5)" class="rehber-th-sortable">
                                    <div class="rehber-th-content">
                                        Cep Tel
                                        <span class="rehber-sort-icon">↕</span>
                                    </div>
                                </th>
                                <th onclick="sortTable(6)" class="rehber-th-sortable">
                                    <div class="rehber-th-content">
                                        İç mail
                                        <span class="rehber-sort-icon">↕</span>
                                    </div>
                                </th>
                                <th onclick="sortTable(7)" class="rehber-th-sortable">
                                    <div class="rehber-th-content">
                                        Dış mail
                                        <span class="rehber-sort-icon">↕</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model)
                            {
                                <tr class="rehber-data-row">
                                    <td>@user.Sicil</td>
                                    <td>@user.Name</td>
                                    <td>@user.Surname</td>
                                    <td>
                                        <div class="rehber-department">@user.Department</div>
                                        <div class="rehber-position">@user.Position</div>
                                    </td>
                                    <td>
                                        <a href="tel:@user.Intercom" class="rehber-phone-link no-loading">
                                            <i class="bx bx-phone rehber-icon-phone"></i>
                                            @user.Intercom
                                        </a>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(user.PhoneNumber))
                                        {
                                            <a href="tel:@user.PhoneNumber" class="rehber-phone-link no-loading">
                                                <i class="bx bx-mobile rehber-icon-mobile"></i>
                                                @user.PhoneNumber
                                            </a>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(user.InternalEmail))
                                        {
                                            <a href="mailto:@user.InternalEmail" class="rehber-email-link no-loading">
                                                <i class="bx bx-envelope rehber-icon-email"></i>
                                                @user.InternalEmail
                                            </a>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(user.ExternalEmail))
                                        {
                                            <a href="mailto:@user.ExternalEmail" class="rehber-email-link no-loading">
                                                <i class="bx bx-envelope-open rehber-icon-email-ext"></i>
                                                @user.ExternalEmail
                                            </a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div id="recordCount" class="rehber-record-count">
                    <i class="bx bx-group rehber-icon-people"></i>
                    Toplam Kayıt: <span class="rehber-record-number">@Model.Count()</span>
                </div>
            </div>
        </div>
    </div>
</section>




<script>
    // Tablo sıralama fonksiyonu
    function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("userTable");
        switching = true;
        // Sıralama yönünü başlangıçta "asc" olarak ayarla
        dir = "asc";

        // Sıralama işaretlerini sıfırla ve aktif sütunu işaretle
        var headers = table.getElementsByTagName("th");
        for (i = 0; i < headers.length; i++) {
            var sortIcon = headers[i].querySelector(".rehber-sort-icon");
            if (i === n) {
                sortIcon.style.opacity = "1";
                sortIcon.style.color = "#4361ee";
            } else {
                sortIcon.style.opacity = "0.5";
                sortIcon.style.color = "#6c757d";
                sortIcon.textContent = "↕";
            }
        }

        while (switching) {
            switching = false;
            rows = table.rows;

            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];

                // Departman ve Pozisyon sütunu için özel işlem
                if (n === 3) {
                    x = x.getElementsByClassName("rehber-department")[0] || x;
                    y = y.getElementsByClassName("rehber-department")[0] || y;
                }

                // Yönü kontrol et
                if (dir == "asc") {
                    if ((x.textContent || x.innerText).toLowerCase() > (y.textContent || y.innerText).toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == "desc") {
                    if ((x.textContent || x.innerText).toLowerCase() < (y.textContent || y.innerText).toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }

            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }

        // Sıralama yönünü göster
        var activeHeader = headers[n].querySelector(".rehber-sort-icon");
        activeHeader.textContent = dir === "asc" ? "↑" : "↓";
    }

    // Tablo arama fonksiyonu
    function searchTable() {
        var input, filter, table, tr, td, i, j, txtValue, found;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("userTable");
        tr = table.getElementsByTagName("tr");
        var count = 0;

        for (i = 1; i < tr.length; i++) {
            found = false;
            for (j = 0; j < 8; j++) {
                td = tr[i].getElementsByTagName("td")[j];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
            }

            if (found) {
                tr[i].style.display = "";
                count++;
            } else {
                tr[i].style.display = "none";
            }
        }

        // Kayıt sayısını güncelle
        document.querySelector(".rehber-record-number").textContent = count;
    }

    // Excel'e aktarma fonksiyonu
    function exportToExcel() {
        var table = document.getElementById("userTable");
        var rows = table.getElementsByTagName("tr");
        var data = [];

        for (var i = 1; i < rows.length; i++) { // Başlık satırını atlamak için i = 1'den başlatın
            var cells = rows[i].getElementsByTagName("td");
            var rowData = [];
            for (var j = 0; j < cells.length; j++) {
                rowData.push(cells[j].innerText);
            }
            data.push(rowData);
        }

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/Contact/ExportToExcel", true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.responseType = "blob";
        xhr.onload = function () {
            if (xhr.status === 200) {
                var blob = new Blob([xhr.response], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
                var link = document.createElement("a");
                link.href = window.URL.createObjectURL(blob);
                link.download = "KullaniciListesi.xlsx";
                link.click();
            } else {
                alert("Excel dosyası indirilirken bir hata oluştu.");
            }
        };
        xhr.onerror = function () {
            alert("Excel dosyası indirilirken bir hata oluştu.");
        };
        xhr.send(JSON.stringify(data));
    }
</script>
