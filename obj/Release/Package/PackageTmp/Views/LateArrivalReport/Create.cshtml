@model MZDNETWORK.Models.LateArrivalReport
@{
    ViewBag.Title = "İşe Geç Gelme Tutanak Formu";
}
<head>
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
</head>
<section class="min-h-screen flex justify-center bg-gray-50">
    <div class="w-full max-w-2xl">
        @using (Html.BeginForm("Create", "LateArrivalReport", FormMethod.Post, new { @class = "bg-white shadow-2xl rounded-2xl p-8 mt-10 space-y-4" }))
        {
            @Html.AntiForgeryToken()
            <h2 class="text-2xl font-bold mb-4">İşe Geç Gelme Tutanak Formu</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Birimi</label>
                    @Html.DropDownListFor(m=>m.Department, (SelectList)ViewBag.Departments, "Seçiniz", new { @class="form-select w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none", id="Department" })
                    @Html.ValidationMessageFor(m=>m.Department)
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Adı Soyadı</label>
                    <select id="FullName" name="FullName" class="form-select w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none">
                        <option value="">Önce birim seçiniz</option>
                    </select>
                    @Html.ValidationMessageFor(m=>m.FullName)
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Pozisyon</label>
                    @Html.TextBoxFor(m=>m.Title, new { @class="form-input w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none", id="Title", @readonly="readonly" })
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Mesai Başlangıç Saati</label>
                    @Html.TextBoxFor(m=>m.ShiftStartTime, "{0:hh\\:mm}", new { type="time", @class="form-input w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" })
                    @Html.ValidationMessageFor(m=>m.ShiftStartTime)
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">İşe Geldiği Saat</label>
                    @Html.TextBoxFor(m=>m.ArrivalTime, "{0:hh\\:mm}", new { type="time", @class="form-input w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" })
                    @Html.ValidationMessageFor(m=>m.ArrivalTime)
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">İşe Geç Gelme Tarihi</label>
                    @Html.TextBoxFor(m=>m.LateDate, "{0:yyyy-MM-dd}", new { type="date", @class="form-input w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" })
                    @Html.ValidationMessageFor(m=>m.LateDate)
                </div>
            </div>

            <hr class="my-4" />

            <h3 class="text-xl font-semibold">Tutanak Metni</h3>
            <p id="reportPreview" class="whitespace-pre-line border border-gray-300 rounded-lg p-4 bg-gray-50"></p>

            <hr class="my-4" />
            <div>
                <label class="block text-sm font-medium mb-1">Personelin Savunması</label>
                @Html.TextAreaFor(m=>m.DefenseText, 5, 80, new { @class="form-textarea w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" })
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">İmza</label>
                <div id="signaturePreviewContainer" class="mb-2 hidden">
                    <img id="signaturePreview" class="border-2 border-gray-300 rounded-lg h-24" />
                </div>
                <button type="button" id="openSignatureModal" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg shadow flex items-center gap-2">
                    <i class='bx bx-pencil'></i> İmza Çiz
                </button>
                <input type="hidden" id="SignaturePath" name="SignaturePath" />
            </div>

            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg shadow">Kaydet</button>
            <a href="@Url.Action("Index")" class="text-gray-600 ml-2">İptal</a>
        }
    </div>
</section>

<!-- Signature Modal (same as other forms) -->
<div id="signatureModal" class="fixed inset-0 bg-gray-900/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-[460px]">
        <h3 class="text-lg font-semibold mb-2">İmzanızı Çizin</h3>
        <canvas id="signatureCanvas" width="400" height="200" class="border-2 border-gray-300 rounded-lg"></canvas>
        <div class="flex justify-between mt-3">
            <button id="clearSig" type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">Temizle</button>
            <div class="space-x-2">
                <button id="saveSig" type="button" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Kaydet</button>
                <button id="closeSig" type="button" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script src="~/Scripts/signature_pad.umd.min.js"></script>
<script>
    // Signature pad logic (copied from VisitorEntry)
    const openBtn = document.getElementById('openSignatureModal');
    const modal = document.getElementById('signatureModal');
    const canvas = document.getElementById('signatureCanvas');
    const sigPad = new SignaturePad(canvas);
    const clearBtn = document.getElementById('clearSig');
    const saveBtn = document.getElementById('saveSig');
    const closeBtn = document.getElementById('closeSig');
    const hiddenInput = document.getElementById('SignaturePath');
    const previewContainer = document.getElementById('signaturePreviewContainer');
    const previewImg = document.getElementById('signaturePreview');

    openBtn.addEventListener('click', () => { modal.classList.remove('hidden'); sigPad.clear(); });
    clearBtn.addEventListener('click', () => sigPad.clear());
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
    saveBtn.addEventListener('click', () => {
        if(sigPad.isEmpty()){ alert('İmza boş!'); return; }
        const dataURL = sigPad.toDataURL('image/png');
        hiddenInput.value = dataURL;
        previewImg.src = dataURL;
        previewContainer.classList.remove('hidden');
        modal.classList.add('hidden');
    });

    // Dynamic preview logic
    function buildPreview(){
        const fullName = $('#FullName').val() || '____________';
        const date = $('#LateDate').val() || '____.__.__';
        const shiftStart = $('#ShiftStartTime').val() || '07:30';
        const arrival = $('#ArrivalTime').val() || '__:__';

        const text = `TUTANAKTIR\n\nİş yeri çalışanımız olan ${fullName} isimli personelin ${date} günü mesaiye saat ${shiftStart}’de başlaması gerekirken izinsiz ve geçerli bir mazereti olmaksızın saat ${arrival}’ta başlamış olup, mesaiye geç gelen personelin konuyla ilişkin savunması alındıktan sonra işbu tutanak isimli yazılı olanlar huzurunda düzenlenip okunarak ${date} tarihinde imza edilmiştir.`;

        $('#reportPreview').text(text);
    }

    $(document).on('input change', '#FullName, #LateDate, #ShiftStartTime, #ArrivalTime', buildPreview);
    // Initial call
    $(document).ready(buildPreview);

    // Department change => load users
    $('#Department').on('change', function(){
        const dept = $(this).val();
        $('#FullName').empty();
        if(!dept){
            $('#FullName').append('<option value="">Önce birim seçiniz</option>');
            $('#Title').val('');
            return;
        }
        $.getJSON('@Url.Action("GetUsersByDepartment")', { department: dept }, function(data){
            $('#FullName').append('<option value="">Seçiniz</option>');
            data.forEach(function(u){
                $('#FullName').append(`<option value="${u.fullName}" data-position="${u.position}">${u.fullName}</option>`);
            });
        });
    });

    // FullName change => set position
    $('#FullName').on('change', function(){
        const pos = $(this).find('option:selected').data('position') || '';
        $('#Title').val(pos);
    });
</script> 