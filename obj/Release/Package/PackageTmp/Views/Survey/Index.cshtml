@model List<MZDNETWORK.Models.Survey>


<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Anketler</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
    <link rel="stylesheet" href="~/Content/boxicons.min.css" />

</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-full mx-auto bg-white rounded-lg shadow p-8">
        <h2 class="text-2xl font-bold mb-6">Anketler</h2>
        @if (MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("Operasyon.Anket", "Create"))
        {
            <a href="@Url.Action("Create", "Survey")" class="inline-block mb-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">Yeni Anket Oluştur</a>
        }
        <div class="overflow-x-auto">
            <table class="min-w-full table-auto border-collapse">
                <thead>
                    <tr class="bg-blue-600 text-white">
                        <th class="px-3 py-2 w-1/6">Anket Adı</th>
                        <th class="px-3 py-2 w-2/6">Açıklama</th>
                        <th class="px-3 py-2 w-1/12">Başlangıç Tarihi</th>
                        <th class="px-3 py-2 w-1/12">Bitiş Tarihi</th>
                        <th class="px-3 py-2 w-1/12">Kalan Süre</th>
                        <th class="px-3 py-2 w-1/6">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var survey in Model)
                    {
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-3 py-2">@survey.Title</td>
                            <td class="px-3 py-2">
                                @if (survey.Description.Length > 100)
                                {
                                    <span>@survey.Description.Substring(0, 100)...</span>
                                    <a href="javascript:void(0);" class="text-blue-600 hover:underline ml-2" onclick="showFullDescription('@Html.Raw(HttpUtility.JavaScriptStringEncode(survey.Description))')">devamını oku</a>
                                }
                                else
                                {
                                    <span>@survey.Description</span>
                                }
                            </td>
                            <td class="px-3 py-2">@survey.CreatedDate.ToString("dd/MM/yyyy HH:mm")</td>
                            <td class="px-3 py-2">@survey.EndDate.ToString("dd/MM/yyyy HH:mm")</td>
                            <td class="px-3 py-2">
                                <span class="timer font-semibold" data-end-time="@survey.EndDate.ToString("o")"></span>
                            </td>
                            <td class="px-3 py-2">
                                <div class="flex flex-col gap-2">
                                    @if (survey.EndDate > DateTime.Now)
                                    {
                                        <a href="javascript:void(0);" onclick="checkSurvey(@survey.ID)" class="flex items-center px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition">
                                            <i class="bx bx-edit-alt mr-2"></i> Cevapla
                                        </a>
                                    }
                                    @if (MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("Operasyon.Anket", "View"))
                                    {
                                        <a href="@Url.Action("SurveyResults", "Survey", new { surveyId = survey.ID })" class="flex items-center px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition">
                                            <i class="bx bx-bar-chart-alt-2 mr-2"></i> Sonuçları Gör
                                        </a>

                                        <a href="javascript:void(0);" onclick="deleteSurvey(@survey.ID)" class="flex items-center px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition">
                                            <i class="bx bx-trash mr-2"></i> Sil
                                        </a>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Açıklama Modalı -->
    <div id="descriptionModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg max-w-lg w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Anket Açıklaması</h3>
                <button onclick="closeDescriptionModal()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <div id="fullDescriptionText" class="text-gray-800"></div>
        </div>
    </div>

    <!-- Uyarı Modalı -->
    <div id="surveyModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-6">
            <div class="flex items-center mb-4">
                <h3 class="text-lg font-semibold">Uyarı</h3>
            </div>
            <div class="text-gray-800">
                Bu anketi daha önce yanıtladınız.
            </div>
        </div>
    </div>

    <script>
        function showFullDescription(description) {
            document.getElementById('fullDescriptionText').textContent = description;
            document.getElementById('descriptionModal').classList.remove('hidden');
            document.getElementById('descriptionModal').classList.add('flex');
        }
        function closeDescriptionModal() {
            document.getElementById('descriptionModal').classList.remove('flex');
            document.getElementById('descriptionModal').classList.add('hidden');
        }

        function checkSurvey(surveyId) {
            $.getJSON('@Url.Action("HasAnsweredSurvey", "Answer")', { surveyId: surveyId }, function (hasAnswered) {
                if (hasAnswered) {
                    document.getElementById('surveyModal').classList.remove('hidden');
                    document.getElementById('surveyModal').classList.add('flex');
                    setTimeout(function () {
                        location.reload();
                    }, 3000);
                } else {
                    window.location.href = '@Url.Action("TakeSurvey", "Answer")' + '?surveyId=' + surveyId;
                }
            });
        }

        function deleteSurvey(surveyId) {
            if (confirm('Bu anketi silmek istediğinizden emin misiniz?')) {
                $.ajax({
                    url: '@Url.Action("Delete", "Survey")',
                    type: 'POST',
                    data: { id: surveyId },
                    success: function () {
                        location.reload();
                    },
                    error: function () {
                        alert('Anket silinirken bir hata oluştu.');
                    }
                });
            }
        }

        function updateTimers() {
            document.querySelectorAll('.timer').forEach(function (el) {
                var endTime = new Date(el.getAttribute('data-end-time'));
                var now = new Date();
                var diff = endTime - now;
                if (diff <= 0) {
                    el.textContent = "Süresi Doldu";
                    el.classList.add("text-red-600");
                    return;
                }
                var days = Math.floor(diff / (1000 * 60 * 60 * 24));
                var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((diff % (1000 * 60)) / 1000);
                var timeText = "";
                if (days > 0) timeText += days + " gün ";
                if (hours > 0 || days > 0) timeText += hours + " saat ";
                timeText += minutes + " dk " + seconds + " sn";
                el.textContent = timeText;
                if (diff < 24 * 60 * 60 * 1000) el.classList.add("text-yellow-600");
            });
        }
        setInterval(updateTimers, 1000);
        updateTimers();

        // Modal kapatma için ESC tuşu
        document.addEventListener('keydown', function (e) {
            if (e.key === "Escape") {
                closeDescriptionModal();
                document.getElementById('surveyModal').classList.remove('flex');
                document.getElementById('surveyModal').classList.add('hidden');
            }
        });
    </script>
    <script src="~/Scripts/jquery-2.2.4.min.js"></script>
</body>
</html>

