@using Newtonsoft.Json
@using Newtonsoft.Json.Serialization

@{
    // Model.Questions'ın tipini belirtiyoruz (örnek: List<Question>)
    var questions = ((IEnumerable<dynamic>)Model.Questions).Cast<object>().ToList();

    // Survey chart verisi
    var surveyData = new List<object>();
    foreach (var q in questions)
    {
        var qObj = q as dynamic;
        var answerCounts = new List<object>();
        foreach (var o in (IEnumerable<dynamic>)qObj.AnswerOptions)
        {
            int count = 0;
            foreach (var a in (IEnumerable<dynamic>)qObj.Answers)
            {
                if (((string)a.AnswerText).Split(',').Contains((string)o.OptionText))
                {
                    count++;
                }
            }
            answerCounts.Add(new
            {
                OptionText = (string)o.OptionText,
                Count = count
            });
        }
        surveyData.Add(new
        {
            QuestionText = (string)qObj.QuestionText,
            AnswerCounts = answerCounts
        });
    }

    // Kullanıcı cevapları (modal için)
    var allAnswers = new List<dynamic>();
    foreach (var q in questions)
    {
        var qObj = q as dynamic;
        foreach (var a in (IEnumerable<dynamic>)qObj.Answers)
        {
            allAnswers.Add(a);
        }
    }

    var userAnswersDict = new Dictionary<string, List<object>>();
    foreach (var a in allAnswers)
    {
        string userId = a.UserID.ToString();
        if (!userAnswersDict.ContainsKey(userId))
        {
            userAnswersDict[userId] = new List<object>();
        }
        userAnswersDict[userId].Add(new
        {
            QuestionText = (string)a.Question.QuestionText,
            AnswerText = (string)a.AnswerText
        });
    }
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anket Sonuçları</title>
    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
    <link href="~/Content/boxicons.min.css" rel="stylesheet" />
    <script src="~/Scripts/chart.js"></script>
    <link rel="stylesheet" href="~/Content/surveyresults.css" />
</head>
<body>
    <div class="survey-container">
        <h2 id="surveyTitle" class="survey-h2">@Model.Title - Sonuçlar</h2>

        <!-- Chart Containers -->
        @for (int i = 0; i < questions.Count; i++)
        {
            <div class="survey-chart-container">
                <canvas id="surveyChart@(i)"></canvas>
            </div>
        }

        <!-- Question Containers -->
        @for (int i = 0; i < questions.Count; i++)
        {
            var question = questions[i] as dynamic;
            <div class="survey-question-container">
                <h3 class="survey-h3">@question.QuestionText</h3>
                <div class="survey-table-responsive">
                    <table class="survey-answer-options-table">
                        <thead>
                            <tr>
                                <th>Cevap Seçeneği</th>
                                <th>Cevap Sayısı</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var option in (IEnumerable<dynamic>)question.AnswerOptions)
                            {
                                int count = 0;
                                foreach (var a in (IEnumerable<dynamic>)question.Answers)
                                {
                                    if (((string)a.AnswerText).Split(',').Contains((string)option.OptionText))
                                    {
                                        count++;
                                    }
                                }
                                <tr>
                                    <td>@option.OptionText</td>
                                    <td>@count</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <!-- User Answers Section -->
        <h3 class="survey-h3">Kullanıcı Cevapları</h3>
        <div class="survey-question-container">
            <div class="survey-table-responsive">
                <table class="survey-user-answers-table">
                    <thead>
                        <tr>
                            <th>Kullanıcı Adı</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="survey-user-answers-body">
                        @foreach (var group in allAnswers.GroupBy(a => a.UserID.ToString()))
                        {
                            <tr>
                                <td data-userid="@group.Key">@group.Key</td>
                                <td>
                                    <button class="survey-btn survey-btn-primary" onclick="showUserAnswers('@group.Key')">
                                        <i class="bx bx-show" style="font-size:1.2em;vertical-align:middle"></i> Cevapları Göster
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Answers Modal -->
        <div id="survey-user-answers-modal" class="survey-modal" style="display:none;">
            <div class="survey-modal-content">
                <span class="survey-close" onclick="closeModal()">
                    <i class="bx bx-x" style="font-size:1.5em"></i>
                </span>
                <h4>Kullanıcı Cevapları</h4>
                <div id="survey-user-answers-content"></div>
                <button class="survey-btn survey-btn-secondary" onclick="closeModal()">
                    <i class="bx bx-x" style="font-size:1.2em;vertical-align:middle"></i> Kapat
                </button>
            </div>
        </div>
    </div>

    <script>
        // globalUserAnswersDict'i global bir değişkene atayalım
        var globalUserAnswersDict = @Html.Raw(JsonConvert.SerializeObject(userAnswersDict));

        // Chart.js ve tablo için veri hazırlama
        $(function () {
            var surveyData = @Html.Raw(JsonConvert.SerializeObject(surveyData));
            const colorPalette = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(199, 199, 199, 0.7)',
                'rgba(83, 102, 255, 0.7)',
                'rgba(40, 159, 64, 0.7)',
                'rgba(210, 199, 199, 0.7)'
            ];

            surveyData.forEach(function (question, index) {
                var ctx = document.getElementById('surveyChart' + index).getContext('2d');
                var labels = question.AnswerCounts.map(function (a) { return a.OptionText; });
                var data = question.AnswerCounts.map(function (a) { return a.Count; });

                var backgroundColors = labels.map(function (_, i) { return colorPalette[i % colorPalette.length]; });
                var borderColors = backgroundColors.map(function (color) { return color.replace('0.7', '1'); });

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cevap Sayısı',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: question.QuestionText,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                padding: {
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                titleColor: '#1e293b',
                                bodyColor: '#334155',
                                borderColor: '#e2e8f0',
                                borderWidth: 1,
                                padding: 12,
                                boxPadding: 6,
                                usePointStyle: true,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.raw + ' kişi';
                                    }
                                }
                            }
                        }
                    }
                });
            });

            // Kullanıcı adlarını almak ve tabloyu güncellemek için AJAX çağrısı
            $.ajax({
                url: '@Url.Action("GetUsernames", "Survey")',
                type: 'GET',
                success: function(data) {
                    var userAnswersBody = document.getElementById('survey-user-answers-body');
                    var rows = userAnswersBody.getElementsByTagName('tr');

                    for (var i = 0; i < rows.length; i++) {
                        var userIdCell = rows[i].getElementsByTagName('td')[0];
                        var userId = userIdCell.getAttribute('data-userid');
                        var user = data.find(function(u) { return u.Id == userId; });

                        if (user) {
                            userIdCell.innerText = user.Username;
                        } else {
                            userIdCell.innerText = 'Bilinmeyen Kullanıcı';
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Kullanıcı adları alınırken bir hata oluştu:', error);
                }
            });
        });

        // Kullanıcı cevaplarını gösteren modal fonksiyonu
        function showUserAnswers(userId) {
            userId = userId.toString();
            var answers = globalUserAnswersDict[userId];
            var content = '';

            if (answers && answers.length > 0) {
                for (var i = 0; i < answers.length; i++) {
                    content += '<p><strong>Soru:</strong> ' + answers[i].QuestionText + '<br><strong>Cevap:</strong> ' + answers[i].AnswerText + '</p>';
                }
            } else {
                content = '<p>Cevap bulunamadı.</p>';
            }

            document.getElementById('survey-user-answers-content').innerHTML = content;
            var modal = document.getElementById('survey-user-answers-modal');
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('survey-user-answers-modal').style.display = 'none';
        }

        window.onclick = function(event) {
            var modal = document.getElementById('survey-user-answers-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
