@{
    ViewBag.Title = "Mesai Servisi Yönetimi - Kolay Arayüz";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/Content/overtimeservicepersonel.css" />

<div class="overtime-container">
    <!-- Header -->
    <div class="header-section">
        <h1><i class="fas fa-clock"></i> Mesai Servisi Yönetimi</h1>
        <p>Personelleri kolayca yönetin ve mesai servisine ekleyin</p>
        <small>Bugün: <span id="todayDate"></span></small>
    </div>

    <!-- Selection Info -->
    <div class="selection-info" id="selectionInfo" style="display: none;">
        <strong id="selectedCount">0</strong> personel seçildi. 
        <span id="serviceInfo"></span>
    </div>

    <!-- Main Content Grid -->
    <div class="overtime-main-content">
        <!-- Sol Taraf - Tüm Personeller -->
        <div class="personnel-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-users"></i> Tüm Servis Kullanan Personeller
                </h3>
                <small>Mesai servisine eklenebilir personeller</small>
            </div>
            <div class="loading-spinner" id="availableLoading">
                <div class="spinner"></div>
                <p>Personeller yükleniyor...</p>
            </div>
            <div class="personnel-grid" id="availablePersonnel">
                <!-- Available personnel will be loaded here -->
            </div>
        </div>

        <!-- Sağ Taraf - Filtre ve Seçilen Servis -->
        <div class="right-panel">
            <!-- Servis Filtresi -->
            <div class="filter-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-filter"></i> Servis Filtresi
                    </h3>
                </div>
                <div class="filter-content">
                    <label for="serviceFilterSelect" class="service-label">
                        <i class="fas fa-bus"></i> Servise Göre Filtrele:
                    </label>
                    <select id="serviceFilterSelect" class="service-select">
                        <option value="">Tümü</option>
                    </select>
                </div>
            </div>

            <!-- Seçilen Servis İçeriği -->
            <div class="selected-service-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-clock"></i> Mesai Servisi
                    </h3>
                    <small>Bugün mesai servisindeki personeller</small>
                </div>
                
                <!-- Mesai Servisi Seçimi -->
                <div class="overtime-service-selection">
                    <label for="overtimeServiceSelect" class="service-label">
                        <i class="fas fa-route"></i> Mesai Servisi Seçin:
                    </label>
                    <select id="overtimeServiceSelect" class="service-select">
                        <option value="">Lütfen mesai servisi seçin...</option>
                    </select>
                </div>
                
                <!-- Action Controls -->
                <div class="action-controls">
                    <button class="btn-action btn-add" id="btnAddToOvertime" disabled>
                        <i class="fas fa-plus"></i> Mesai Servisine Ekle
                    </button>
                    <button class="btn-action btn-remove" id="btnRemoveFromOvertime" disabled>
                        <i class="fas fa-minus"></i> Mesai Servisinden Çıkar
                    </button>
                </div>

                <div class="loading-spinner" id="overtimeLoading">
                    <div class="spinner"></div>
                    <p>Mesai personelleri yükleniyor...</p>
                </div>
                <div class="personnel-grid" id="overtimePersonnel">
                    <!-- Overtime personnel will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-number" id="totalAvailableCount">0</span>
            <span class="stat-label">Uygun Personel</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="totalOvertimeCount">0</span>
            <span class="stat-label">Mesai Servisinde</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="selectedPersonnelCount">0</span>
            <span class="stat-label">Seçili</span>
        </div>
    </div>
</div>

<script>
let availablePersonnel = [];
let overtimePersonnel = [];
let selectedPersonnel = [];
let services = [];
let selectedServiceId = null;
let selectedOvertimeServiceId = null;

$(document).ready(function() {
    initializePage();
});

function initializePage() {
    updateTodayDate();
    loadServices();
    loadAvailablePersonnel();
    loadOvertimePersonnel();
    setupEventListeners();
}

function updateTodayDate() {
    const today = new Date();
    const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        weekday: 'long'
    };
    $('#todayDate').text(today.toLocaleDateString('tr-TR', options));
}

function loadServices() {
    $.ajax({
        url: '@Url.Action("GetServices", "OvertimeServiceManager")',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                services = response.data;
                populateServiceFilter();
            } else {
                showError('Servisler yüklenirken hata oluştu: ' + response.message);
            }
        },
        error: function() {
            showError('Servisler yüklenirken bağlantı hatası oluştu.');
        }
    });
}

function populateServiceFilter() {
    const filterSelect = $('#serviceFilterSelect');
    const overtimeSelect = $('#overtimeServiceSelect');
    
    // Filtre dropdown'ını doldur
    filterSelect.empty();
    filterSelect.append('<option value="">Tümü</option>');
    
    // Mesai servisi dropdown'ını doldur
    overtimeSelect.empty();
    overtimeSelect.append('<option value="">Lütfen mesai servisi seçin...</option>');
    
    services.forEach(service => {
        filterSelect.append(`<option value="${service.Id}">${service.ServiceName}</option>`);
        overtimeSelect.append(`<option value="${service.Id}">${service.ServiceName}</option>`);
    });
}

function loadAvailablePersonnel() {
    $('#availableLoading').show();
    $('#availablePersonnel').hide();
    
    $.ajax({
        url: '@Url.Action("GetAvailablePersonnel", "OvertimeServiceManager")',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                availablePersonnel = response.data;
                displayAvailablePersonnel();
                updateStats();
            } else {
                showError('Personeller yüklenirken hata oluştu: ' + response.message);
            }
            $('#availableLoading').hide();
            $('#availablePersonnel').show();
        },
        error: function() {
            showError('Personeller yüklenirken bağlantı hatası oluştu.');
            $('#availableLoading').hide();
        }
    });
}

function loadOvertimePersonnel() {
    $('#overtimeLoading').show();
    $('#overtimePersonnel').hide();
    
    $.ajax({
        url: '@Url.Action("GetOvertimePersonnel", "OvertimeServiceManager")',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                overtimePersonnel = response.data;
                displayOvertimePersonnel();
                updateStats();
            } else {
                showError('Mesai personelleri yüklenirken hata oluştu: ' + response.message);
            }
            $('#overtimeLoading').hide();
            $('#overtimePersonnel').show();
        },
        error: function() {
            showError('Mesai personelleri yüklenirken bağlantı hatası oluştu.');
            $('#overtimeLoading').hide();
        }
    });
}

function displayAvailablePersonnel() {
    const container = $('#availablePersonnel');
    container.empty();
    
    if (availablePersonnel.length === 0) {
        container.html('<div class="no-data"><i class="fas fa-info-circle"></i><p>Henüz eklenebilir personel bulunmuyor.</p></div>');
        return;
    }
    
    availablePersonnel.forEach(person => {
        const card = createPersonCard(person, 'available');
        container.append(card);
    });
}

function displayOvertimePersonnel() {
    const container = $('#overtimePersonnel');
    container.empty();
    
    if (overtimePersonnel.length === 0) {
        container.html('<div class="no-data"><i class="fas fa-info-circle"></i><p>Henüz mesai servisinde personel bulunmuyor.</p></div>');
        return;
    }
    
    // Eğer mesai servisi seçilmişse, sadece o servisteki personelleri göster
    let filteredPersonnel = overtimePersonnel;
    if (selectedOvertimeServiceId) {
        filteredPersonnel = overtimePersonnel.filter(person => person.ServiceId == selectedOvertimeServiceId);
        
        if (filteredPersonnel.length === 0) {
            const selectedService = services.find(s => s.Id == selectedOvertimeServiceId);
            const serviceName = selectedService ? selectedService.ServiceName : 'Seçilen Servis';
            container.html(`<div class="no-data"><i class="fas fa-info-circle"></i><p>${serviceName} mesai servisinde henüz personel bulunmuyor.</p></div>`);
            return;
        }
    }
    
    // Servislere göre grupla
    const groupedByService = {};
    filteredPersonnel.forEach(person => {
        const serviceKey = person.ServiceName || 'Bilinmeyen Servis';
        if (!groupedByService[serviceKey]) {
            groupedByService[serviceKey] = [];
        }
        groupedByService[serviceKey].push(person);
    });
    
    // Her servis grubu için başlık ve personelleri göster
    Object.keys(groupedByService).forEach(serviceName => {
        const servicePersonnel = groupedByService[serviceName];
        
        // Servis başlığı
        const serviceHeader = `
            <div class="service-group-header">
                <h4><i class="fas fa-bus"></i> ${serviceName} (${servicePersonnel.length} kişi)</h4>
            </div>
        `;
        container.append(serviceHeader);
        
        // Bu servisteki personeller
        servicePersonnel.forEach(person => {
            const card = createPersonCard(person, 'overtime');
            container.append(card);
        });
    });
}

function createPersonCard(person, type) {
    const isSelected = selectedPersonnel.includes(person.UserId);
    const selectedClass = isSelected ? 'selected' : '';
    
    return `
        <div class="person-card ${selectedClass}" 
             data-user-id="${person.UserId}" 
             data-service-id="${person.ServiceId}"
             data-type="${type}">
            <div class="person-info">
                <div class="person-name">${person.FirstName} ${person.LastName}</div>
                <div class="person-details">
                    <div class="detail-item">
                        <i class="fas fa-id-card"></i>
                        <span>${person.PersonelNo}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-building"></i>
                        <span>${person.DepartmentName || 'Bilinmiyor'}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-phone"></i>
                        <span>${person.PhoneNumber || 'Belirtilmemiş'}</span>
                    </div>
                </div>
                <div class="service-badge">
                    <i class="fas fa-bus"></i>
                    ${person.ServiceName}
                </div>
            </div>
        </div>
    `;
}

function setupEventListeners() {
    // Personnel card selection
    $(document).on('click', '.person-card', function() {
        const card = $(this);
        const userId = card.data('user-id');
        const cardType = card.data('type');
        
        // Eğer mesai personeliyse ve seçilen serviste değilse seçime izin verme
        if (cardType === 'overtime' && selectedOvertimeServiceId) {
            const person = overtimePersonnel.find(p => p.UserId == userId);
            if (person && person.ServiceId != selectedOvertimeServiceId) {
                return; // Filtrelenmiş serviste değilse seçim yapma
            }
        }
        
        if (card.hasClass('selected')) {
            card.removeClass('selected');
            selectedPersonnel = selectedPersonnel.filter(id => id !== userId);
        } else {
            card.addClass('selected');
            selectedPersonnel.push(userId);
        }
        
        updateStats();
        updateSelectionInfo();
        updateButtonStates();
    });

    // Service filter change
    $('#serviceFilterSelect').on('change', function() {
        const serviceId = $(this).val();
        filterPersonnelByService(serviceId);
    });

    // Overtime service selection change
    $('#overtimeServiceSelect').on('change', function() {
        selectedOvertimeServiceId = $(this).val();
        updateButtonStates();
        displayOvertimePersonnel(); // Mesai personellerini yeniden göster
        
        if (selectedOvertimeServiceId) {
            const selectedService = services.find(s => s.Id == selectedOvertimeServiceId);
            if (selectedService) {
                console.log('Mesai servisi seçildi:', selectedService.ServiceName);
            }
        }
    });

    // Add to overtime
    $('#btnAddToOvertime').on('click', function() {
        if (selectedPersonnel.length === 0) {
            showError('Lütfen eklemek istediğiniz personelleri seçin.');
            return;
        }
        
        addSelectedToOvertime();
    });

    // Remove from overtime
    $('#btnRemoveFromOvertime').on('click', function() {
        if (selectedPersonnel.length === 0) {
            showError('Lütfen çıkarmak istediğiniz personelleri seçin.');
            return;
        }
        
        removeSelectedFromOvertime();
    });
}

function filterPersonnelByService(serviceId) {
    const container = $('#availablePersonnel');
    const allCards = container.find('.person-card');
    
    if (!serviceId) {
        allCards.show();
        updateStats();
        return;
    }

    // Find the selected service
    const selectedService = services.find(s => s.Id == serviceId);
    if (!selectedService) return;

    console.log('Filtering by service:', selectedService.ServiceName);

    // Show only personnel from the selected service
    allCards.each(function() {
        const card = $(this);
        const personServiceName = card.find('.service-badge').text().trim();
        const isFromSelectedService = personServiceName.includes(selectedService.ServiceName) || 
                                    personServiceName.includes(selectedService.RouteName);
        
        if (isFromSelectedService) {
            card.show();
        } else {
            card.hide();
            // Remove selection if card is hidden
            if (card.hasClass('selected')) {
                const userId = card.data('user-id');
                card.removeClass('selected');
                selectedPersonnel = selectedPersonnel.filter(id => id !== userId);
            }
        }
    });

    updateStats();
    updateSelectionInfo();
}

function addSelectedToOvertime() {
    if (selectedPersonnel.length === 0) return;
    
    if (!selectedOvertimeServiceId) {
        showError('Lütfen önce mesai servisi seçin.');
        return;
    }
    
    showLoading('Personeller mesai servisine ekleniyor...');
    
    $.ajax({
        url: '@Url.Action("AddToOvertime", "OvertimeServiceManager")',
        type: 'POST',
        data: { 
            userIds: selectedPersonnel,
            serviceId: selectedOvertimeServiceId 
        },
        success: function(response) {
            hideLoading();
            if (response.success) {
                const selectedService = services.find(s => s.Id == selectedOvertimeServiceId);
                showSuccess(`${selectedPersonnel.length} personel başarıyla ${selectedService.ServiceName} mesai servisine eklendi.`);
                selectedPersonnel = [];
                loadAvailablePersonnel();
                loadOvertimePersonnel();
                updateSelectionInfo();
                updateButtonStates();
            } else {
                showError('Personeller eklenirken hata oluştu: ' + response.message);
            }
        },
        error: function() {
            hideLoading();
            showError('Personeller eklenirken bağlantı hatası oluştu.');
        }
    });
}

function removeSelectedFromOvertime() {
    if (selectedPersonnel.length === 0) return;
    
    showLoading('Personeller mesai servisinden çıkarılıyor...');
    
    $.ajax({
        url: '@Url.Action("RemoveFromOvertime", "OvertimeServiceManager")',
        type: 'POST',
        data: { userIds: selectedPersonnel },
        success: function(response) {
            hideLoading();
            if (response.success) {
                showSuccess(`${selectedPersonnel.length} personel başarıyla mesai servisinden çıkarıldı.`);
                selectedPersonnel = [];
                loadAvailablePersonnel();
                loadOvertimePersonnel();
                updateSelectionInfo();
                updateButtonStates();
            } else {
                showError('Personeller çıkarılırken hata oluştu: ' + response.message);
            }
        },
        error: function() {
            hideLoading();
            showError('Personeller çıkarılırken bağlantı hatası oluştu.');
        }
    });
}

function updateStats() {
    const visibleAvailableCards = $('#availablePersonnel .person-card:visible').length;
    
    // Mesai servisindeki toplam sayı - eğer filtre varsa filtrelenmiş sayı
    let totalOvertimeCount = overtimePersonnel.length;
    if (selectedOvertimeServiceId) {
        totalOvertimeCount = overtimePersonnel.filter(person => person.ServiceId == selectedOvertimeServiceId).length;
    }
    
    const selectedCount = selectedPersonnel.length;
    
    $('#totalAvailableCount').text(visibleAvailableCards);
    $('#totalOvertimeCount').text(totalOvertimeCount);
    $('#selectedPersonnelCount').text(selectedCount);
}

function updateSelectionInfo() {
    const count = selectedPersonnel.length;
    
    if (count === 0) {
        $('#selectionInfo').hide();
        return;
    }
    
    $('#selectedCount').text(count);
    $('#selectionInfo').show();
}

function updateButtonStates() {
    const hasSelection = selectedPersonnel.length > 0;
    const hasOvertimeService = selectedOvertimeServiceId && selectedOvertimeServiceId !== '';
    
    $('#btnAddToOvertime').prop('disabled', !hasSelection || !hasOvertimeService);
    $('#btnRemoveFromOvertime').prop('disabled', !hasSelection);
}

// Utility functions
function showLoading(message) {
    // Implementation for loading indicator
}

function hideLoading() {
    // Implementation for hiding loading indicator
}

function showSuccess(message) {
    // Implementation for success message
    console.log('Success:', message);
}

function showError(message) {
    // Implementation for error message
    console.error('Error:', message);
}
</script>
