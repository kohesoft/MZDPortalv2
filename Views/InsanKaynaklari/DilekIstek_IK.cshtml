@using MZDNETWORK.Models
@model IEnumerable<DilekOneri>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dilek ve Öneri Kutusu</title>
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
    <link rel="stylesheet" href="~/Content/boxicons.min.css" />
    <link rel="stylesheet" href="~/Content/dilekistekik.css" />
    <script src="~/Scripts/xlsx.full.min.js"></script>
    <style>
        /* This style block ensures the modal is correctly displayed when 'active' */
        .modal.active {
            display: flex !important; /* Changed to flex for proper centering */
            opacity: 1; /* Ensure full visibility */
            visibility: visible; /* Ensure it's not hidden by visibility property */
        }

        .export-button {
            background-color: #1d4ed8;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            transition: background-color 0.2s;
        }

        .export-button:hover {
            background-color: #1e40af;
        }

        .export-button i {
            font-size: 1.2em;
        }
    </style>
    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-6">
    <div class="max-w-7xl mx-auto suggestion-container">
        <div class="suggestion-header">
            <h1 class="suggestion-title"><i class="bx bx-bulb"></i> Dilek ve Öneri Kutusu</h1>
            <p class="mt-2 opacity-90">Çalışanlardan gelen dilek ve önerileri görüntüleyin ve yanıtlayın</p>
            <div class="search-container">
                <i class="bx bx-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Ara..." />
            </div>
            <button id="exportExcel" class="export-button">
                <i class="bx bx-export"></i> Excel'e Aktar
            </button>
        </div>
        <div class="suggestion-body">
            <div class="table-container overflow-auto max-h-[550px]">
                <table class="suggestion-table" id="suggestionTable">
                    <thead>
                        <tr>
                            <th>Kullanıcı Adı</th>
                            <th>Mesaj</th>
                            <th>Yanıt</th>
                            <th>Tarih</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="suggestionTableBody">
                        @foreach (var item in Model)
                        {
                            <tr class="suggestion-item">
                                <td>
                                    @if (item.IsAnonymous)
                                    {
                                        <span class="badge badge-anonymous" style="cursor:pointer;" onclick="showUserModal('@Html.Raw(HttpUtility.JavaScriptStringEncode(item.Username))')">
                                            <i class="bx bx-user-voice"></i> Gizli
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-user"><i class="bx bx-user"></i> @item.Username</span>
                                    }
                                </td>

                                <td class="message-cell">
                                    <span class="text-truncate">@item.Mesaj</span>
                                    @if (!string.IsNullOrEmpty(item.Mesaj) && item.Mesaj.Length > 25)
                                    {
                                        <button class="expand-button" onclick="showLongText('@Html.Raw(HttpUtility.JavaScriptStringEncode(item.Mesaj))')">Daha Fazla</button>
                                    }
                                </td>
                                <td class="message-cell">
                                    <span class="text-truncate">@(string.IsNullOrEmpty(item.Bilidirim) ? "-" : item.Bilidirim)</span>
                                    @if (!string.IsNullOrEmpty(item.Bilidirim) && item.Bilidirim.Length > 25)
                                    {
                                        <button class="expand-button" onclick="showLongText('@Html.Raw(HttpUtility.JavaScriptStringEncode(item.Bilidirim))')">Daha Fazla</button>
                                    }
                                </td>
                                <td>
                                    <span class="date-badge"><i class="bx bx-calendar"></i> @item.GonderimTarihi.ToString("dd.MM.yyyy")</span>
                                </td>
                                <td>
                                    <button class="reply-button" onclick="showReplyModal('@(item.IsAnonymous ? "Gizli Kullanıcı" : HttpUtility.JavaScriptStringEncode(item.Username))', @item.Id, '@Html.Raw(HttpUtility.JavaScriptStringEncode(item.Bilidirim ?? ""))')">Yanıtla</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="longTextModal">
        <div class="modal-content">
            <div class="modal-header"><h5>Metni Oku</h5><button class="modal-close" onclick="closeModal('longTextModal')">&times;</button></div>
            <div class="modal-body"><pre id="longTextContent"></pre></div>
        </div>
    </div>

    <div class="modal" id="replyModal">
        <div class="modal-content">
            <div class="modal-header"><h5 id="replyTitle"></h5><button class="modal-close" onclick="closeModal('replyModal')">&times;</button></div>
            <div class="modal-body">
                <textarea id="replyMessage" class="form-control" rows="4" placeholder="Yanıtınızı yazın..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('replyModal')">Kapat</button>
                <button class="btn btn-primary" id="sendReply">Gönder</button>
            </div>
        </div>
    </div>
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Kullanıcı Bilgisi</h5>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <strong>Gerçek Kullanıcı Adı:</strong>
                <span id="realUsername" style="font-weight:500; color:#2563eb;"></span>
            </div>
        </div>
    </div>
    <script>
        // Function to show the long text modal
        function showLongText(text) {
            document.getElementById('longTextContent').textContent = text;
            document.getElementById('longTextModal').classList.add('active');
        }

        // Function to close any modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Function to show the reply modal
        function showReplyModal(username, id, currentReply) {
            document.getElementById('replyTitle').textContent = username + ' kullanıcısına yanıt';
            // Set the textarea value. If currentReply is '-', make it an empty string.
            document.getElementById('replyMessage').value = (currentReply && currentReply !== '-') ? currentReply : '';
            // Store the ID of the suggestion in the modal's dataset
            document.getElementById('replyModal').dataset.id = id;
            document.getElementById('replyModal').classList.add('active');
        }
        function showUserModal(username) {
            document.getElementById('realUsername').textContent = username;
            document.getElementById('userModal').classList.add('active');
        }
        $(function () {
            // Event listener for the 'Gönder' (Send) button in the reply modal
            $('#sendReply').on('click', function () {
                var modal = document.getElementById('replyModal');
                var id = modal.dataset.id; // Get the ID from the modal's dataset
                var message = $('#replyMessage').val(); // Get the message from the textarea

                if (!message) {
                    alert('Yanıt alanı boş olamaz.');
                    return;
                }

                // AJAX call to send the reply to the server
                $.ajax({
                    url: '@Url.Action("UpdateMessage", "DilekOneri")', // Correct URL using Url.Action
                    type: 'POST',
                    data: { id: id, message: message }, // Data to send
                    success: function (response) {
                        if (response.success) {
                            alert('Yanıt başarıyla kaydedildi.');
                            location.reload(); // Reload the page to show updated reply
                        } else {
                            alert('Hata: ' + response.error); // Display error message from server
                        }
                    },
                    error: function (xhr, status, error) {
                        // More detailed error handling for debugging
                        alert('Sunucu hatası oluştu: ' + xhr.responseText);
                        console.error('AJAX Error:', status, error, xhr.responseText);
                    }
                });
            });

            // Close modal when clicking outside of modal content
            $('.modal').on('click', function (e) {
                if (e.target === this) { // Check if the click was directly on the modal backdrop
                    $(this).removeClass('active');
                }
            });

            // Search functionality
            $('#searchInput').on('input', function () {
                var searchText = $(this).val().toLowerCase();
                $('#suggestionTableBody tr').each(function () {
                    var row = $(this);
                    var match = false;
                    row.find('td').each(function () {
                        // Check if any cell's text contains the search text
                        if ($(this).text().toLowerCase().includes(searchText)) { // Using .includes() for better string matching
                            match = true;
                        }
                    });
                    row.toggle(match); // Show/hide row based on match
                });
            });

            // Function to export table to Excel
            function exportTableToExcel() {
                // Create a workbook
                var wb = XLSX.utils.book_new();
                
                // Get the table data
                var data = [];
                var headers = [];
                
                // Get headers
                $('#suggestionTable thead th').each(function() {
                    headers.push($(this).text());
                });
                data.push(headers);
                
                // Get table data
                $('#suggestionTableBody tr').each(function() {
                    var row = [];
                    $(this).find('td').each(function(index) {
                        // For username column (index 0)
                        if (index === 0) {
                            // If it's anonymous, get the real username from the onclick attribute
                            var isAnonymous = $(this).find('.badge-anonymous').length > 0;
                            if (isAnonymous) {
                                var username = $(this).find('.badge-anonymous').attr('onclick');
                                username = username.split("'")[1]; // Extract username from onclick attribute
                                row.push(username + " (Gizli)");
                            } else {
                                row.push($(this).text().trim());
                            }
                        }
                        // For message and reply columns (index 1 and 2)
                        else if (index === 1 || index === 2) {
                            row.push($(this).find('.text-truncate').text().trim());
                        }
                        // For other columns
                        else if (index !== 4) { // Skip the "İşlem" column
                            row.push($(this).text().trim());
                        }
                    });
                    data.push(row);
                });
                
                // Create worksheet
                var ws = XLSX.utils.aoa_to_sheet(data);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, "Dilek ve Öneriler");
                
                // Generate Excel file and trigger download
                XLSX.writeFile(wb, "Dilek_ve_Oneriler.xlsx");
            }

            // Add click handler for export button
            $('#exportExcel').on('click', exportTableToExcel);
        });
    </script>
</body>
</html>