@model IEnumerable<MZDNETWORK.Models.ServiceRoute>
@using System.Linq;
@{
    ViewBag.Title = "Servis Güzergâhları";
    var routeList = Model.ToList();
}
<head>
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
    <link rel="stylesheet" href="~/Content/leaflet.css" />
    <link rel="stylesheet" href="~/Content/serviceperson.css" />
    <link rel="stylesheet" href="~/Content/serviceroute.css" />
</head>

<section class="min-h-screen bg-gray-50 p-8">
    <!-- Service Routes Section -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Servis Güzergâhları</h1>
            <p class="text-gray-600 mt-3 text-l</div>g">Servis rotalarını haritada görüntüleyin ve detaylarını inceleyin</p>
        </div>

        <!-- Route Selection Buttons -->
        <div class="flex flex-wrap gap-4 mb-8 justify-center">
            @for(int i=0;i<routeList.Count;i++){
                var r = routeList[i];
                <button class="route-btn px-6 py-4 rounded-xl bg-blue-600 text-white hover:bg-blue-700 focus:outline-none transition-all duration-300 font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                        data-kml="@Url.Content(r.KmlPath)" data-title="@r.Title">
                    <i class="fas fa-route mr-3"></i>@r.Title
                </button>
            }
        </div>

        <!-- Selected Route Info -->
        <div id="selectedRouteInfo" class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 mb-8 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-full mr-4">
                        <i class="fas fa-map-marked-alt text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-blue-800" id="selectedRouteTitle">Seçilen Güzergah</h3>
                        <p class="text-blue-600" id="selectedRouteDescription">Haritada görüntüleniyor</p>
                    </div>
                </div>
                <div class="text-blue-600">
                    <i class="fas fa-eye text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="bg-gray-100 rounded-xl p-4 shadow-inner">
            <div id="mainMap" class="rounded-lg shadow-md" style="height: 650px; border: 2px solid #e5e7eb;"></div>
        </div>

        <!-- Map Legend -->
        <div class="mt-6 bg-gray-50 rounded-lg p-4">
            <div class="flex items-center justify-center space-x-8 text-sm text-gray-600">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-blue-600 rounded mr-2"></div>
                    <span>Servis Güzergahı</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-green-600 rounded mr-2"></div>
                    <span>Durak Noktaları</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-600 rounded mr-2"></div>
                    <span>Önemli Noktalar</span>
                </div>
            </div>
        </div>
    </div>
</section>

@section scripts{
    <script src="~/Scripts/leaflet.js"></script>
    <script src="~/Scripts/togeojson.min.js"></script>
    <script src="~/Scripts/jquery-3.7.1.min.js"></script>
    <script>
        // Service Route Map functionality
        document.addEventListener('DOMContentLoaded', () => {
            const dataBounds = L.latLngBounds([[39.728, 32.481], [40.095, 33.008]]);
            const map = L.map('mainMap', {
                maxBounds: dataBounds,
                maxBoundsViscosity: 1.0,
                zoomControl: true
            }).fitBounds(dataBounds);

            L.tileLayer('/tile/{z}/{x}/{y}.png', {
                bounds: dataBounds,
                noWrap: true,
                minZoom: 13,
                maxZoom: 16,
                reuseTiles: true,
                attribution: ''
            }).addTo(map);

            let currentLayer = null;

            function loadRoute(kmlUrl, title){
                if(!kmlUrl) return;
                
                // Show loading state
                const routeInfo = document.getElementById('selectedRouteInfo');
                const routeTitle = document.getElementById('selectedRouteTitle');
                const routeDescription = document.getElementById('selectedRouteDescription');
                
                routeTitle.textContent = title || 'Güzergah Yükleniyor...';
                routeDescription.textContent = 'Harita verileri yükleniyor...';
                routeInfo.classList.remove('hidden');

                fetch(kmlUrl)
                    .then(r=>r.text())
                    .then(txt=>{
                        const kmlDom = new DOMParser().parseFromString(txt,'text/xml');
                        const geojson = toGeoJSON.kml(kmlDom);
                        
                        if(currentLayer){
                            map.removeLayer(currentLayer);
                        }
                        
                        currentLayer = L.geoJSON(geojson, {
                            style: function (feature) {
                                return {
                                    color: '#2563eb',
                                    weight: 8,
                                    opacity: 1,
                                    dashArray: '5, 5'
                                };
                            },
                            pointToLayer: function (feature, latlng) {
                                return L.circleMarker(latlng, {
                                    radius: 8,
                                    fillColor: '#10b981',
                                    color: '#065f46',
                                    weight: 2,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                });
                            },
                            onEachFeature: function (feature, layer) {
                                if (feature.properties && feature.properties.name) {
                                    layer.bindPopup(`
                                        <div class="p-3">
                                            <h4 class="font-bold text-gray-800">${feature.properties.name}</h4>
                                        </div>
                                    `);
                                }
                            }
                        }).addTo(map);
                        
                        map.fitBounds(currentLayer.getBounds(), {padding: [20, 20]});
                        
                        // Update route info
                        routeTitle.textContent = title;
                        routeDescription.textContent = 'Haritada görüntüleniyor • Duraklar için işaretlere tıklayın';
                    })
                    .catch(error => {
                        console.error('KML yükleme hatası:', error);
                        routeTitle.textContent = 'Yükleme Hatası';
                        routeDescription.textContent = 'Güzergah verileri yüklenirken bir hata oluştu';
                    });
            }

            // Button click handlers
            document.querySelectorAll('.route-btn').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    // Remove active class from all buttons
                    document.querySelectorAll('.route-btn').forEach(b => {
                        b.classList.remove('bg-blue-800', 'shadow-xl', 'scale-105');
                        b.classList.add('bg-blue-600');
                    });
                    
                    // Add active class to clicked button
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-blue-800', 'shadow-xl', 'scale-105');
                    
                    loadRoute(btn.dataset.kml, btn.dataset.title);
                });
            });

            // Load first route by default
            const firstBtn = document.querySelector('.route-btn');
            if(firstBtn){
                firstBtn.classList.remove('bg-blue-600');
                firstBtn.classList.add('bg-blue-800', 'shadow-xl', 'scale-105');
                loadRoute(firstBtn.dataset.kml, firstBtn.dataset.title);
            }

            // Add map controls
            map.on('zoomend', function() {
                console.log('Zoom level:', map.getZoom());
            });
        });
    </script>
}