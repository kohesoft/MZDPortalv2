@using Microsoft.AspNet.Identity
@{
    var isAdmin = ViewBag.IsAdmin as bool? ?? false;
    var currentUserId = ViewBag.CurrentUserId;
    var currentUserName = ViewBag.CurrentUserName;
}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toplantı Salonu Rezervasyon Sistemi</title>
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .calendar-day {
            transition: all 0.2s ease;
        }

            .calendar-day:hover:not(.bg-gray-200):not(.selected) {
                background-color: #e0e7ff;
                transform: scale(1.05);
            }

        .selected {
            background-color: #4f46e5;
            color: white;
            transform: scale(1.05);
        }

        .room-card {
            transition: all 0.3s ease;
        }

            .room-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);
            }

        .tab-active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
        }
    </style>
</head>
<body>
    @Html.AntiForgeryToken()
    <div class="min-h-screen">
        <!-- Üst Menü -->
        <nav class="bg-indigo-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold">Toplantı Salonu Rezervasyon</h1>
                <div class="flex space-x-2">
                    <button id="historyBtn" class="px-3 py-1 bg-indigo-700 hover:bg-indigo-800 rounded-md text-sm transition">Geçmiş</button>
                    @if (isAdmin)
                    {
                        <button id="switchRoleBtn" class="px-3 py-1 bg-indigo-700 hover:bg-indigo-800 rounded-md text-sm transition">Rol Değiştir</button>
                    }
                </div>
            </div>
        </nav>

        <!-- Rol Bilgisi -->
        <div class="container mx-auto px-4 py-2">
            <div class="flex items-center justify-between bg-white rounded-lg shadow-sm p-3 mb-4">
                <div class="flex items-center">
                    <div id="roleIndicator" class="w-3 h-3 rounded-full @(isAdmin ? "bg-red-500" : "bg-blue-500") mr-2"></div>
                    <span id="currentRole" class="font-medium">
                        @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("Operational.MeetingRoom", "Manage") ? "Yetkili" : "Kullanıcı")
                    </span>
                </div>
                @if (isAdmin)
                {
                    <div id="pendingCount" class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">0 Onay Bekleyen</div>
                }
            </div>
        </div>

        <!-- Ana İçerik -->
        <div class="container mx-auto px-4 pb-8">
            <!-- Kullanıcı Arayüzü -->
            <div id="userInterface">
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Toplantı Salonları -->
                    <div class="w-full md:w-1/3">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Toplantı Salonları</h2>
                        <div class="space-y-4">

                            <div id="largeRoom" class="room-card bg-white p-4 rounded-lg shadow-md border-l-4 border-purple-500 cursor-pointer">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-medium text-lg">Yerleşke Büyük Toplantı Salonu</h3>
                                    <span class="text-sm px-2 py-1 bg-green-100 text-green-800 rounded-full">Müsait</span>
                                </div>
                                <p class="text-gray-600 mt-2">Kapasite: 15 kişi</p>
                                <p class="text-gray-600">Özellikler: Projeksiyon, Beyaz Tahta, Video Konferans</p>
                            </div>

                            <div id="smallRoom" class="room-card bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-500 cursor-pointer">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-medium text-lg">Yerleşke Küçük Toplantı Salonu</h3>
                                    <span class="text-sm px-2 py-1 bg-green-100 text-green-800 rounded-full">Müsait</span>
                                </div>
                                <p class="text-gray-600 mt-2">Kapasite: 6 kişi</p>
                                <p class="text-gray-600">Özellikler: Projeksiyon</p>
                            </div>

                            <div id="mediumRoom" class="room-card bg-white p-4 rounded-lg shadow-md border-l-4 border-green-500 cursor-pointer">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-medium text-lg">Merkez Toplantı Salonu</h3>
                                    <span class="text-sm px-2 py-1 bg-green-100 text-green-800 rounded-full">Müsait</span>
                                </div>
                                <p class="text-gray-600 mt-2">Kapasite: 10 kişi</p>
                                <p class="text-gray-600">Özellikler: Projeksiyon, Beyaz Tahta</p>
                            </div>

                        </div>
                    </div>

                    <!-- Takvim ve Rezervasyon -->
                    <div class="w-full md:w-2/3">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h2 class="text-xl font-semibold mb-4 text-gray-800">Rezervasyon Talebi Oluştur</h2>
                            <div id="roomSelection" class="mb-6">
                                <p class="text-gray-700 mb-2">Seçilen Salon: <span id="selectedRoom" class="font-medium">Seçilmedi</span></p>
                                <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div id="progressBar" class="h-full bg-indigo-600 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="font-medium text-gray-800 mb-3">Tarih Seçin</h3>
                                <div id="calendar" class="grid grid-cols-7 gap-1 text-center">
                                    <div class="text-sm font-medium text-gray-500 py-1">Pzt</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Sal</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Çar</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Per</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Cum</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Cmt</div>
                                    <div class="text-sm font-medium text-gray-500 py-1">Paz</div>
                                    <!-- Calendar days will be inserted here by JS -->
                                </div>
                            </div>

                            <div id="timeSelection" class="mb-6 hidden">
                                <h3 class="font-medium text-gray-800 mb-3">Saat Seçin</h3>
                                <div class="flex gap-2">
                                    <select id="startTime" class="border rounded-md px-2 py-1">
                                        <option>09:00</option>
                                        <option>10:00</option>
                                        <option>11:00</option>
                                        <option>12:00</option>
                                        <option>13:00</option>
                                        <option>14:00</option>
                                        <option>15:00</option>
                                        <option>16:00</option>
                                    </select>
                                    <span class="self-center">-</span>
                                    <select id="endTime" class="border rounded-md px-2 py-1">
                                        <option>10:00</option>
                                        <option>11:00</option>
                                        <option>12:00</option>
                                        <option>13:00</option>
                                        <option>14:00</option>
                                        <option>15:00</option>
                                        <option>16:00</option>
                                        <option>17:00</option>
                                    </select>
                                </div>
                            </div>

                            <div id="detailsForm" class="hidden">
                                <h3 class="font-medium text-gray-800 mb-3">Toplantı Detayları</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="meetingTitle" class="block text-sm font-medium text-gray-700 mb-1">Toplantı Başlığı</label>
                                        <input type="text" id="meetingTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label for="meetingDesc" class="block text-sm font-medium text-gray-700 mb-1">Açıklama</label>
                                        <textarea id="meetingDesc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                                    </div>
                                    <div>
                                        <label for="attendees" class="block text-sm font-medium text-gray-700 mb-1">Katılımcılar (virgülle ayırın)</label>
                                        <input type="text" id="attendees" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div class="flex justify-end">
                                        <button id="confirmBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Rezervasyon Talebi Oluştur</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dayReservations" class="mb-6 hidden">
                    <h3 class="font-medium text-gray-800 mb-3">Seçilen Gündeki Toplantılar</h3>
                    <div id="dayReservationList" class="space-y-2"></div>
                </div>

            </div>



            <!-- Yönetici Arayüzü -->
            <div id="adminInterface" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex border-b mb-4">
                        <button id="pendingTab" class="tab-active px-4 py-2 font-medium">Onay Bekleyenler</button>
                        <button id="approvedTab" class="px-4 py-2 font-medium">Onaylananlar</button>
                        <button id="rejectedTab" class="px-4 py-2 font-medium">Reddedilenler</button>
                        <button id="allTab" class="px-4 py-2 font-medium">Tüm Rezervasyonlar</button>
                    </div>

                    <div id="adminContent">
                        <!-- Onay Bekleyen Rezervasyonlar -->
                        <div id="pendingReservations" class="space-y-4">
                            <!-- Rezervasyonlar JS ile eklenecek -->
                        </div>

                        <!-- Onaylanan Rezervasyonlar -->
                        <div id="approvedReservations" class="space-y-4 hidden">
                            <!-- Rezervasyonlar JS ile eklenecek -->
                        </div>

                        <!-- Reddedilen Rezervasyonlar -->
                        <div id="rejectedReservations" class="space-y-4 hidden">
                            <!-- Rezervasyonlar JS ile eklenecek -->
                        </div>

                        <!-- Tüm Rezervasyonlar -->
                        <div id="allReservations" class="space-y-4 hidden">
                            <!-- Rezervasyonlar JS ile eklenecek -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geçmiş Rezervasyonlar Modal -->
        <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Rezervasyon Geçmişim</h2>
                        <button id="closeHistoryBtn" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarih</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saat</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salon</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Başlık</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Durum</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="historyTableBody">
                                <!-- Rezervasyon geçmişi buraya eklenecek -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Başarılı Rezervasyon Modal -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                        <svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Rezervasyon Talebi Oluşturuldu!</h3>
                    <p class="text-sm text-gray-600 mb-4">Talebiniz yönetici onayına gönderildi. Onaylandığında bilgilendirileceksiniz.</p>
                    <div id="reservationDetails" class="text-left bg-gray-50 p-3 rounded-md mb-4">
                        <!-- Rezervasyon detayları buraya eklenecek -->
                    </div>
                    <button id="closeSuccessBtn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Tamam</button>
                </div>
            </div>
        </div>

        <!-- Rezervasyon Detay Modal -->
        <div id="reservationDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Rezervasyon Detayları</h3>
                    <button id="closeDetailBtn" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modalReservationDetails" class="space-y-3 mb-4">
                    <!-- Rezervasyon detayları buraya eklenecek -->
                </div>
                <div id="adminActions" class="flex justify-between mt-6">
                    <button id="rejectBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Reddet</button>
                    <button id="approveBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">Onayla</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Değişkenler
        let isAdmin = @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasPermission("Operational.MeetingRoom", "Manage") ? "true" : "false") === "true";
        var isDayViewRole = @(MZDNETWORK.Attributes.DynamicAuthorizeAttribute.CurrentUserHasAnyPermission("Operational.MeetingRoom.Manage", "Operational.MeetingRoom.View") ? "true" : "false");

console.log("isAdmin:", isAdmin);
console.log("isDayViewRole:", isDayViewRole);
      let selectedRoom = null;
        let selectedDate = null;
        let selectedTime = null;
        let selectedStartTime = null;
        let selectedEndTime = null;
        let selectedReservationId = null;
        let reservations = [];

        var currentUser = {
            id: '@User.Identity.GetUserId()',
            name: '@User.Identity.Name'
        };

        // Anti-forgery token
        function getToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]').value;
        }

        // DOM Elementleri
        const userInterface = document.getElementById('userInterface');
        const adminInterface = document.getElementById('adminInterface');
        const switchRoleBtn = document.getElementById('switchRoleBtn');
        const currentRoleEl = document.getElementById('currentRole');
        const roleIndicatorEl = document.getElementById('roleIndicator');
        const pendingCountEl = document.getElementById('pendingCount');
        const smallRoomEl = document.getElementById('smallRoom');
        const largeRoomEl = document.getElementById('largeRoom');
        const mediumRoomEl = document.getElementById('mediumRoom');
        const selectedRoomEl = document.getElementById('selectedRoom');
        const progressBarEl = document.getElementById('progressBar');
        const calendarEl = document.getElementById('calendar');
        const timeSelectionEl = document.getElementById('timeSelection');
        const detailsFormEl = document.getElementById('detailsForm');
        const historyBtn = document.getElementById('historyBtn');
        const historyModal = document.getElementById('historyModal');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const historyTableBody = document.getElementById('historyTableBody');
        const confirmBtn = document.getElementById('confirmBtn');
        const successModal = document.getElementById('successModal');
        const closeSuccessBtn = document.getElementById('closeSuccessBtn');
        const reservationDetailsEl = document.getElementById('reservationDetails');
        const pendingReservationsEl = document.getElementById('pendingReservations');
        const approvedReservationsEl = document.getElementById('approvedReservations');
        const rejectedReservationsEl = document.getElementById('rejectedReservations');
        const allReservationsEl = document.getElementById('allReservations');
        const pendingTab = document.getElementById('pendingTab');
        const approvedTab = document.getElementById('approvedTab');
        const rejectedTab = document.getElementById('rejectedTab');
        const allTab = document.getElementById('allTab');
        const adminActionsEl = document.getElementById('adminActions');
        const modalReservationDetailsEl = document.getElementById('modalReservationDetails');
        const reservationDetailModal = document.getElementById('reservationDetailModal');
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const closeDetailBtn = document.getElementById('closeDetailBtn');

        document.getElementById('startTime').addEventListener('change', function () {
            selectedStartTime = this.value;
            updateProgress();
        });
        document.getElementById('endTime').addEventListener('change', function () {
            selectedEndTime = this.value;
            updateProgress();
        });

        // Takvim oluştur
        function generateCalendar() {
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
            while (calendarEl.children.length > 7) {
                calendarEl.removeChild(calendarEl.lastChild);
            }
            for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'h-10 w-10 mx-auto rounded-full';
                calendarEl.appendChild(emptyDay);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(today.getFullYear(), today.getMonth(), day);
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day h-10 w-10 mx-auto flex items-center justify-center rounded-full cursor-pointer';
                if (date < new Date(today.getFullYear(), today.getMonth(), today.getDate())) {
                    dayEl.className += ' bg-gray-200 text-gray-400 cursor-not-allowed';
                }
                dayEl.textContent = day;
                dayEl.dataset.date = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                dayEl.addEventListener('click', function () {
                    console.log("Takvim günü tıklandı. isDayViewRole:", isDayViewRole, "Seçilen gün:", this.dataset.date);
                    if (!this.classList.contains('bg-gray-200')) {
                        document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedDate = this.dataset.date;
                        updateProgress();
                        if (selectedRoom) {
                            timeSelectionEl.classList.remove('hidden');
                        }
                        if (isDayViewRole === true || isDayViewRole === "true") {
                            console.log("showDayReservations çağrılıyor");
                            showDayReservations(selectedDate);
                        } else {
                            console.log("Gün toplantıları gizleniyor");
                            document.getElementById('dayReservations').classList.add('hidden');
                        }
                    }
                });
                calendarEl.appendChild(dayEl);
            }
            colorCalendarDays();
        }

        // Rezervasyon durumuna göre rozet döndüren yardımcı fonksiyon
        function getStatusBadge(status) {
            switch ((status || '').toLowerCase()) {
                case 'pending':
                    return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Onay Bekliyor</span>';
                case 'approved':
                    return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Onaylandı</span>';
                case 'rejected':
                    return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Reddedildi</span>';
                default:
                    return status;
            }
        }


        // Takvimde toplantı olan günleri renklendir
        function colorCalendarDays() {
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                const dateStr = dayEl.dataset.date;
                if (!dateStr) return;
                const hasMeeting = reservations.some(r => r.date === dateStr);
                if (hasMeeting) {
                    dayEl.classList.add('bg-yellow-200');
                } else {
                    dayEl.classList.remove('bg-yellow-200');
                }
            });
        }

        // Seçilen günün toplantılarını göster
        function showDayReservations(dateStr) {
            console.log("showDayReservations çalıştı, dateStr:", dateStr);
            const dayReservations = reservations.filter(r => r.date === dateStr);
            const dayReservationsDiv = document.getElementById('dayReservations');
            const dayReservationList = document.getElementById('dayReservationList');
            if (dayReservations.length === 0) {
                dayReservationList.innerHTML = '<div class="text-gray-500">Bu gün için toplantı yok.</div>';
            } else {
                dayReservationList.innerHTML = dayReservations.map(r => `
            <div class="p-2 rounded border bg-gray-50 flex justify-between items-center">
                <div>
                    <span class="ml-2 text-sm text-gray-600">${r.startTime} - ${r.endTime}</span>
                    <span class="ml-2 text-sm text-gray-600">${r.room}</span>
                </div>
                ${getStatusBadge(r.status)}
            </div>
        `).join('');
            }
            dayReservationsDiv.classList.remove('hidden');
        }

        // Oda seçimi
        smallRoomEl.addEventListener('click', function () {
            selectedRoom = 'Küçük Toplantı Salonu';
            selectedRoomEl.textContent = selectedRoom;
            smallRoomEl.classList.add('ring-2', 'ring-blue-500');
            largeRoomEl.classList.remove('ring-2', 'ring-purple-500');
            mediumRoomEl.classList.remove('ring-2', 'ring-green-500');
            updateProgress();
            if (selectedDate) {
                timeSelectionEl.classList.remove('hidden');
            }
        });

        largeRoomEl.addEventListener('click', function () {
            selectedRoom = 'Büyük Toplantı Salonu';
            selectedRoomEl.textContent = selectedRoom;
            largeRoomEl.classList.add('ring-2', 'ring-purple-500');
            smallRoomEl.classList.remove('ring-2', 'ring-blue-500');
            mediumRoomEl.classList.remove('ring-2', 'ring-green-500');
            updateProgress();
            if (selectedDate) {
                timeSelectionEl.classList.remove('hidden');
            }
        });
        mediumRoomEl.addEventListener('click', function () {
            selectedRoom = 'Orta Toplantı Salonu';
            selectedRoomEl.textContent = selectedRoom;
            mediumRoomEl.classList.add('ring-2', 'ring-green-500');
            smallRoomEl.classList.remove('ring-2', 'ring-blue-500');
            largeRoomEl.classList.remove('ring-2', 'ring-purple-500');
            updateProgress();
            if (selectedDate) {
                timeSelectionEl.classList.remove('hidden');
            }
        });

        // Rezervasyonları sunucudan çeken fonksiyon
        function fetchReservations(callback) {
            fetch('/MeetingRoom/GetReservations')
                .then(res => res.json())
                .then(data => {
                    reservations = data;
                    if (typeof callback === 'function') callback();
                    updatePendingCount && updatePendingCount();
                    colorCalendarDays && colorCalendarDays();
                });
        }

        function updateInterface() {
            console.log("updateInterface çalıştı. isAdmin:", isAdmin);
            if (isAdmin) {
                userInterface.classList.add('hidden');
                adminInterface.classList.remove('hidden');
            } else {
                userInterface.classList.remove('hidden');
                adminInterface.classList.add('hidden');
            }
        }

        // İlerleme çubuğunu güncelle
        function updateProgress() {
            let progress = 0;
            if (selectedRoom) progress += 33;
            if (selectedDate) progress += 33;
            if (selectedStartTime && selectedEndTime) progress += 34;
            progressBarEl.style.width = `${progress}%`;
            if (selectedRoom && selectedDate && selectedStartTime && selectedEndTime) {
                detailsFormEl.classList.remove('hidden');
            } else {
                detailsFormEl.classList.add('hidden');
            }
        }

        // Rezervasyon oluştur (CSRF korumalı)
        confirmBtn.addEventListener('click', function () {
            const title = document.getElementById('meetingTitle').value;
            const desc = document.getElementById('meetingDesc').value;
            const attendees = document.getElementById('attendees').value;

            // Saat kontrolü
            if (!selectedStartTime || !selectedEndTime) {
                alert('Lütfen başlangıç ve bitiş saatini seçin.');
                return;
            }
            if (selectedStartTime >= selectedEndTime) {
                alert('Başlangıç saati, bitiş saatinden önce olmalıdır.');
                return;
            }

            if (!title) {
                alert('Lütfen toplantı başlığı girin.');
                return;
            }
            const params = new URLSearchParams({
                userId: currentUser.id,
                userName: currentUser.name,
                room: selectedRoom,
                date: selectedDate,
                startTime: selectedStartTime,
                endTime: selectedEndTime,
                title: title,
                description: desc,
                attendees: attendees,
                __RequestVerificationToken: getToken()
            });

            fetch('/MeetingRoom/CreateReservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            })
                .then(response => response.json())
                .then(res => {
                    if (!res.success && res.message) {
                        alert(res.message);
                        return;
                    }
                    reservationDetailsEl.innerHTML = `
<p><strong>Salon:</strong> ${res.reservation.Room}</p>
<p><strong>Tarih:</strong> ${res.reservation.Date}</p>
<p><strong>Saat:</strong> ${res.reservation.StartTime} - ${res.reservation.EndTime}</p>
<p><strong>Başlık:</strong> ${res.reservation.Title}</p>
<p><strong>Durum:</strong> ${getStatusBadge(res.reservation.Status)}</p>
`;

                    successModal.classList.remove('hidden');
                    fetchReservations();
                    resetForm();
                })
                .catch(err => alert(err.message));
        });

        // Formu sıfırla
        function resetForm() {
            selectedRoom = null;
            selectedDate = null;
            selectedTime = null;
            selectedStartTime = null;
            selectedEndTime = null;
            selectedRoomEl.textContent = 'Seçilmedi';
            progressBarEl.style.width = '0%';
            smallRoomEl.classList.remove('ring-2', 'ring-blue-500');
            largeRoomEl.classList.remove('ring-2', 'ring-purple-500');
            mediumRoomEl.classList.remove('ring-2', 'ring-green-500');
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            document.getElementById('meetingTitle').value = '';
            document.getElementById('meetingDesc').value = '';
            document.getElementById('attendees').value = '';
            document.getElementById('startTime').selectedIndex = 0;
            document.getElementById('endTime').selectedIndex = 0;
            timeSelectionEl.classList.add('hidden');
            detailsFormEl.classList.add('hidden');
        }

        // Rol değiştirme
        if (switchRoleBtn) {
            switchRoleBtn.addEventListener('click', function () {
                isAdmin = !isAdmin;
                updateInterface();
            });
        }

        // Bekleyen rezervasyon sayısını güncelle
        function updatePendingCount() {
            if (!pendingCountEl) return;
            const pendingCount = reservations.filter(r => (r.status || '').toLowerCase() === 'pending').length;
            pendingCountEl.textContent = `${pendingCount} Onay Bekleyen`;
        }

        // Yönetici sekmelerini yönet
        pendingTab.addEventListener('click', function () { setActiveTab(pendingTab); loadAdminReservations('pending'); });
        approvedTab.addEventListener('click', function () { setActiveTab(approvedTab); loadAdminReservations('approved'); });
        rejectedTab.addEventListener('click', function () { setActiveTab(rejectedTab); loadAdminReservations('rejected'); });
        allTab.addEventListener('click', function () { setActiveTab(allTab); loadAdminReservations('all'); });

        function setActiveTab(activeTab) {
            [pendingTab, approvedTab, rejectedTab, allTab].forEach(tab => tab.classList.remove('tab-active'));
            activeTab.classList.add('tab-active');
            [pendingReservationsEl, approvedReservationsEl, rejectedReservationsEl, allReservationsEl].forEach(el => el.classList.add('hidden'));
            if (activeTab === pendingTab) pendingReservationsEl.classList.remove('hidden');
            else if (activeTab === approvedTab) approvedReservationsEl.classList.remove('hidden');
            else if (activeTab === rejectedTab) rejectedReservationsEl.classList.remove('hidden');
            else if (activeTab === allTab) allReservationsEl.classList.remove('hidden');
        }

        // Yönetici rezervasyonlarını yükle
        function loadAdminReservations(type) {
            fetchReservations(function () {
                let filteredReservations;
                if (type === 'all') filteredReservations = [...reservations];
                else filteredReservations = reservations.filter(r => (r.status || '').toLowerCase() === type);
                let containerEl;
                if (type === 'pending') containerEl = pendingReservationsEl;
                else if (type === 'approved') containerEl = approvedReservationsEl;
                else if (type === 'rejected') containerEl = rejectedReservationsEl;
                else if (type === 'all') containerEl = allReservationsEl;
                containerEl.innerHTML = '';
                if (filteredReservations.length === 0) {
                    containerEl.innerHTML = `<p class="text-center text-gray-500 py-4">Rezervasyon bulunamadı.</p>`;
                    return;
                }
                filteredReservations.forEach(res => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow border-l-4 border-indigo-500';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-lg">${res.title}</h3>
                                <p class="text-gray-600 text-sm">${res.userName} tarafından</p>
                            </div>
                            <div class="flex flex-col items-end">
                                ${getStatusBadge(res.status)}
<span class="text-sm text-gray-500 mt-1">${res.date} ${res.startTime} - ${res.endTime}</span>
                            </div>
                        </div>
                        <p class="text-gray-700 mt-2">${res.room}</p>
                        <div class="flex justify-end mt-2">
                            <button class="view-details px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 text-sm" data-id="${res.id}">Detayları Gör</button>
                        </div>
                    `;
                    containerEl.appendChild(card);
                });
                document.querySelectorAll('.view-details').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const resId = parseInt(this.dataset.id);
                        showReservationDetails(resId);
                    });
                });
            });
        }

        // Rezervasyon detaylarını göster
        function showReservationDetails(id) {
            const reservation = reservations.find(r => r.id === id);
            if (!reservation) return;
            selectedReservationId = id;
            let statusInfo = '';
            if ((reservation.status || '').toLowerCase() === 'pending') {
                statusInfo = getStatusBadge(reservation.status);
                adminActionsEl.classList.remove('hidden');
            } else if ((reservation.status || '').toLowerCase() === 'approved') {
                statusInfo = `
                    ${getStatusBadge(reservation.status)}
                    <p class="text-sm text-gray-500 mt-1">Onay Tarihi: ${reservation.approvedAt || ''}</p>
                `;
                adminActionsEl.classList.add('hidden');
            } else if ((reservation.status || '').toLowerCase() === 'rejected') {
                statusInfo = `
                    ${getStatusBadge(reservation.status)}
                    <p class="text-sm text-gray-500 mt-1">Red Tarihi: ${reservation.rejectedAt || ''}</p>
                    <p class="text-sm text-gray-700 mt-1">Red Nedeni: ${reservation.rejectionReason || 'Belirtilmedi'}</p>
                `;
                adminActionsEl.classList.add('hidden');
            }
            modalReservationDetailsEl.innerHTML = `
                <div class="flex justify-between">
                    <h4 class="font-medium">${reservation.title}</h4>
                    <div>${statusInfo}</div>
                </div>
                <p class="text-gray-600"><strong>Talep Eden:</strong> ${reservation.userName}</p>
                <p class="text-gray-600"><strong>Salon:</strong> ${reservation.room}</p>
<p class="text-gray-600"><strong>Tarih/Saat:</strong> ${reservation.date} ${reservation.startTime} - ${reservation.endTime}</p>                <p class="text-gray-600"><strong>Açıklama:</strong> ${reservation.description || 'Belirtilmedi'}</p>
                <p class="text-gray-600"><strong>Katılımcılar:</strong> ${reservation.attendees || 'Belirtilmedi'}</p>
                <p class="text-gray-600"><strong>Oluşturulma Tarihi:</strong> ${reservation.createdAt || ''}</p>
            `;
            reservationDetailModal.classList.remove('hidden');
        }

        // Rezervasyon onayla (CSRF korumalı)
        approveBtn.addEventListener('click', function () {
            const params = new URLSearchParams({
                id: selectedReservationId,
                __RequestVerificationToken: getToken()
            });
            fetch('/MeetingRoom/ApproveReservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) { alert(data.message); return; }
                    reservationDetailModal.classList.add('hidden');
                    fetchReservations();
                    loadAdminReservations('pending');
                })
                .catch(err => alert(err.message));
        });

        if (historyBtn) {
            historyBtn.addEventListener('click', function () {
                fetchReservations(function () {
                    // Sadece giriş yapan kullanıcının geçmişi gösterilsin
                    const userId = currentUser.id;
                    const userReservations = reservations.filter(r => r.userId == userId);
                    historyTableBody.innerHTML = userReservations.length === 0
                        ? '<tr><td colspan="5" class="text-center text-gray-500 py-4">Geçmiş rezervasyon bulunamadı.</td></tr>'
                        : userReservations.map(r => `
                    <tr>
                        <td class="px-6 py-2 whitespace-nowrap">${r.date}</td>
                        <td class="px-6 py-2 whitespace-nowrap">${r.startTime} - ${r.endTime}</td>
                        <td class="px-6 py-2 whitespace-nowrap">${r.room}</td>
                        <td class="px-6 py-2 whitespace-nowrap">${r.title}</td>
                        <td class="px-6 py-2 whitespace-nowrap">${getStatusBadge(r.status)}</td>
                    </tr>
                `).join('');
                    historyModal.classList.remove('hidden');
                    // Modal açıldığında tabloyu başa kaydır
                    setTimeout(function () {
                        historyModal.querySelector('.overflow-x-auto').scrollTop = 0;
                    }, 100);
                });
            });
        }
        if (closeHistoryBtn) {
            closeHistoryBtn.addEventListener('click', function () {
                historyModal.classList.add('hidden');
            });
        }

        // Rezervasyon reddet (CSRF korumalı)
        rejectBtn.addEventListener('click', function () {
            const reason = prompt('Red nedenini girin:');
            if (reason !== null) {
                const params = new URLSearchParams({
                    id: selectedReservationId,
                    reason: reason,
                    __RequestVerificationToken: getToken()
                });
                fetch('/MeetingRoom/RejectReservation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                })
                    .then(res => res.json())
                    .then(data => {
                        if (!data.success) { alert(data.message); return; }
                        reservationDetailModal.classList.add('hidden');
                        fetchReservations();
                        loadAdminReservations('pending');
                    })
                    .catch(err => alert(err.message));
            }
        });

        closeDetailBtn.addEventListener('click', function () {
            reservationDetailModal.classList.add('hidden');
        });

        // Takvimi oluştur
        generateCalendar();

        // Modal dışına tıklayınca kapat
        window.addEventListener('click', function (event) {
            if (event.target === historyModal) historyModal.classList.add('hidden');
            if (event.target === successModal) successModal.classList.add('hidden');
            if (event.target === reservationDetailModal) reservationDetailModal.classList.add('hidden');
        });

        // Başarılı modalı kapat
        if (closeSuccessBtn) {
            closeSuccessBtn.addEventListener('click', function () {
                successModal.classList.add('hidden');
            });
        }

        // Sayfa ilk açıldığında rezervasyonları çek
        generateCalendar();
        fetchReservations();
        updatePendingCount();
    });
    </script>

</body>
</html>