@model List<Gonderi>
@using System.Linq

@{
    ViewBag.Title = "Ana Sayfa";
    var imageFiles = ViewBag.ImageFiles as List<string>;
}

<head>
    <link href="~/Content/boxicons.min.css" rel='stylesheet'>
    <link rel="stylesheet" href="~/Content/homeindex.css" />
</head>

<body class="anasayfa-body">
    <div class="anasayfa-container">
        <div class="anasayfa-header">
            <i class='bx bx-news anasayfa-header-icon'></i>
            <h2 class="anasayfa-title">DUYURULAR</h2>
        </div>

        <div class="anasayfa-timeline" id="timeline">
            @if (Model != null && Model.Any())
            {
                foreach (var post in Model)
                {
                    <div class="anasayfa-timeline-item">
                        <div class="anasayfa-timeline-dot">
                            <i class='bx bxs-bell-ring'></i>
                        </div>
                        <div class="anasayfa-timeline-content">
                            <div class="anasayfa-timeline-header">
                                <h3 class="anasayfa-timeline-title">@post.Title</h3>
                                <span class="anasayfa-timeline-date">
                                    <i class='bx bx-calendar'></i>
                                    @post.CreatedAt.ToString("g")
                                </span>
                            </div>
                            <div class="anasayfa-timeline-body">
                                @Html.Raw(post.Content)
                            </div>
                            
                            @* Show attachment count and download links *@
                            @if (post.Ekler != null && post.Ekler.Any(e => e.IsActive))
                            {
                                <div class="anasayfa-timeline-attachments">
                                    <div class="anasayfa-attachment-header">
                                        <i class='bx bx-paperclip anasayfa-attachment-icon'></i>
                                        <span class="anasayfa-attachment-count">@post.Ekler.Count(e => e.IsActive) Ek Dosya</span>
                                    </div>
                                    <div class="anasayfa-attachment-list">
                                        @foreach (var ek in post.Ekler.Where(e => e.IsActive).Take(3))
                                        {
                                            <div class="anasayfa-attachment-item">
                                                <span class="anasayfa-attachment-name">@ek.OriginalFileName</span>
                                                <a href="@Url.Action("DownloadFile", "Gonderi", new { id = ek.Id })" 
                                                   class="anasayfa-attachment-download no-loading">
                                                    <i class='bx bx-download'></i>
                                                </a>
                                            </div>
                                        }
                                        @if (post.Ekler.Count(e => e.IsActive) > 3)
                                        {
                                            <div class="anasayfa-attachment-more">
                                                ve @(post.Ekler.Count(e => e.IsActive) - 3) dosya daha...
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            
                            @* Detail link *@
                            <div class="anasayfa-timeline-actions">
                                <a href="@Url.Action("GonderiDetay", "Gonderi", new { id = post.Id })" 
                                   class="anasayfa-detail-link">
                                    <i class='bx bx-detail'></i>
                                    Detayları Görüntüle
                                </a>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="anasayfa-empty-state">
                    <i class='bx bx-info-circle anasayfa-empty-icon'></i>
                    <p class="anasayfa-empty-text">Henüz duyuru bulunmamaktadır.</p>
                </div>
            }
        </div>

        <div class="anasayfa-loading" id="loading">
            <i class='bx bx-loader-alt bx-spin'></i>
            <span>Yükleniyor...</span>
        </div>
    </div>

    <!-- Geri Bildirim Modal -->
    <div class="anasayfa-modal" id="feedbackModal">
        <div class="anasayfa-modal-overlay"></div>
        <div class="anasayfa-modal-container">
            <div class="anasayfa-modal-header">
                <h5 class="anasayfa-modal-title">
                    <i class='bx bx-message-square-detail'></i>
                    Geri Bildirim
                </h5>
                <button type="button" class="anasayfa-modal-close" id="closeModal">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="anasayfa-modal-body">
                <p class="anasayfa-modal-question">PortalÄ± beÄŸendiniz mi?</p>
                <div class="anasayfa-modal-buttons">
                    <button type="button" class="anasayfa-btn-like" id="likeButton">
                        <i class='bx bxs-like'></i>
                        Evet
                    </button>
                    <button type="button" class="anasayfa-btn-dislike" id="dislikeButton">
                        <i class='bx bxs-dislike'></i>
                        Hayır
                    </button>
                </div>
                <div class="anasayfa-suggestion" id="suggestionDiv">
                    <label for="suggestionInput" class="anasayfa-suggestion-label">
                        <i class='bx bx-bulb'></i>
                        Ne Önerirsiniz?
                    </label>
                    <input type="text" class="anasayfa-suggestion-input" id="suggestionInput" placeholder="Ã–nerinizi buraya yazÄ±n...">
                </div>
            </div>
            <div class="anasayfa-modal-footer">
                <button type="button" class="anasayfa-btn-submit" id="submitFeedbackButton">
                    <i class='bx bx-send'></i>
                    Gönder
                </button>
            </div>
        </div>
    </div>
</body>

@section scripts {
    <script src="~/Scripts/coursel.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Modal işlemleri
        const modal = document.getElementById('feedbackModal');
        const closeModal = document.getElementById('closeModal');
        const likeButton = document.getElementById('likeButton');
        const dislikeButton = document.getElementById('dislikeButton');
        const suggestionDiv = document.getElementById('suggestionDiv');
        const submitButton = document.getElementById('submitFeedbackButton');

        // Modal açma fonksiyonu (ihtiyaca göre kullanılabilir)
        function openFeedbackModal() {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Modal kapatma
        function closeFeedbackModal() {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Kapatma butonuna tıklama
        if (closeModal) {
            closeModal.addEventListener('click', closeFeedbackModal);
        }

        // Modal dışına tıklama
        window.addEventListener('click', function (event) {
            if (event.target === modal) {
                closeFeedbackModal();
            }
        });

        // Beğenme/beğenmeme butonları
        if (likeButton) {
            likeButton.addEventListener('click', function () {
                likeButton.classList.add('active');
                dislikeButton.classList.remove('active');
                suggestionDiv.style.display = 'none';
                submitButton.style.display = 'flex';
            });
        }

        if (dislikeButton) {
            dislikeButton.addEventListener('click', function () {
                dislikeButton.classList.add('active');
                likeButton.classList.remove('active');
                suggestionDiv.style.display = 'block';
                submitButton.style.display = 'flex';
            });
        }

        // Gönder butonu
        if (submitButton) {
            submitButton.addEventListener('click', function () {
                // Burada geri bildirim gönderme işlemi yapılabilir
                alert('Geri bildiriminiz için teşekkür ederiz!');
                closeFeedbackModal();
            });
        }

        // Sonsuz kaydırma için gerekirse kullanılabilir
        let page = 1;
        let loading = false;
        const loadingElement = document.getElementById('loading');

        function loadMorePosts() {
            if (loading) return;

            loading = true;
            loadingElement.style.display = 'flex';

            // Burada AJAX ile daha fazla gönderi yüklenebilir
            // Örnek:
            /*
            fetch(`/Home/LoadMorePosts?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    if (data.posts && data.posts.length > 0) {
                        // Gönderileri ekle
                        const timeline = document.getElementById('timeline');
                        data.posts.forEach(post => {
                            const postElement = createPostElement(post);
                            timeline.appendChild(postElement);
                        });
                        page++;
                    } else {
                        // Daha fazla gönderi yoksa
                        window.removeEventListener('scroll', scrollHandler);
                    }
                    loading = false;
                    loadingElement.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error loading posts:', error);
                    loading = false;
                    loadingElement.style.display = 'none';
                });
            */

            // Simülasyon için:
            setTimeout(() => {
                loading = false;
                loadingElement.style.display = 'none';
            }, 1000);
        }

        function scrollHandler() {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                loadMorePosts();
            }
        }

        // Sonsuz kaydırma için scroll event listener
        // window.addEventListener('scroll', scrollHandler);
    });
</script>
}

<style>
    /* Detail link styles */
    .anasayfa-detail-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
    }

    .anasayfa-detail-link:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }

    /* Attachment styles for home page */
    .anasayfa-timeline-attachments {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .anasayfa-attachment-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: #495057;
    }

    .anasayfa-attachment-icon {
        color: #007bff;
        font-size: 1.1rem;
    }

    .anasayfa-attachment-count {
        font-size: 0.9rem;
    }

    .anasayfa-attachment-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .anasayfa-attachment-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .anasayfa-attachment-item:hover {
        border-color: #007bff;
        background: #f8f9ff;
    }

    .anasayfa-attachment-name {
        font-size: 0.875rem;
        color: #495057;
        font-weight: 500;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-right: 0.5rem;
    }

    .anasayfa-attachment-download {
        color: #007bff;
        text-decoration: none;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .anasayfa-attachment-download:hover {
        background: #007bff;
        color: white;
        text-decoration: none;
    }

    .anasayfa-attachment-more {
        font-size: 0.8rem;
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 0.25rem;
    }

    .anasayfa-timeline-actions {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
</style>