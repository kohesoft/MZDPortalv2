@{
    ViewBag.Title = "Servis Ayarları";
}

<head>
    <link rel="stylesheet" href="~/Content/tailwind.min.css" />
</head>

<section class="min-h-screen bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Servis Ayarları</h1>
                    <p class="text-gray-600 mt-2">Araç ve servis rotası yönetimi</p>
                </div>
                <div class="flex gap-3">
                    <a href="@Url.Action("Admin", "ServicePersonnel")" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        Personel Yönetimi
                    </a>
                    <button onclick="openAddServiceModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Yeni Servis Ekle
                    </button>
                </div>
            </div>
        </div>

        <!-- Services Table -->
        <div class="bg-white rounded-xl shadow-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800">Servis Listesi</h2>
                    <div class="flex gap-4">
                        <input type="text" id="searchInput" placeholder="Servis ara..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <span class="text-sm text-gray-600 self-center">Toplam: <span id="serviceCount">0</span> servis</span>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servis Adı</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rota</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Araç</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Şoför</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saatler</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kapasite</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Personel</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div id="serviceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 id="modalTitle" class="text-lg font-medium text-gray-900">Yeni Servis Ekle</h3>
                </div>
                <div class="px-6 py-4">
                    <form id="serviceForm">
                        <input type="hidden" id="serviceId" value="">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Servis Adı *</label>
                                <input type="text" id="serviceName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="MZD-1 Eryaman" required>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rota Adı *</label>
                                <input type="text" id="routeName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Eryaman - Batıkent - MZD" required>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Açıklama</label>
                                <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Servis hakkında açıklama..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Araç Plakası</label>
                                <input type="text" id="vehiclePlate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="06 ABC 123">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kapasite</label>
                                <input type="number" id="capacity" min="1" max="100" value="50" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Şoför Adı</label>
                                <input type="text" id="driverName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Mehmet YILMAZ">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Şoför Telefonu</label>
                                <input type="tel" id="driverPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="05XX XXX XX XX">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kalkış Saati</label>
                                <input type="time" id="departureTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dönüş Saati</label>
                                <input type="time" id="returnTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="px-6 py-4 bg-gray-50 flex justify-end gap-3">
                    <button onclick="closeServiceModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                        İptal
                    </button>
                    <button onclick="saveService()" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700">
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    let services = [];
    let isEditing = false;

    $(document).ready(function() {
        loadServices();
        setupEventListeners();
    });

    function setupEventListeners() {
        $('#searchInput').on('input', filterServices);
    }

    function loadServices() {
        $.get('@Url.Action("GetServices", "ServiceConfiguration")')
            .done(function(response) {
                if (response.success) {
                    services = response.data;
                    renderServices();
                    $('#serviceCount').text(services.length);
                } else {
                    console.error('Servisler yüklenemedi:', response.message);
                }
            })
            .fail(function() {
                console.error('Servisler yüklenirken hata oluştu');
            });
    }

    function renderServices() {
        const tbody = $('#servicesTableBody');
        tbody.empty();

        const filteredServices = getFilteredServices();

        if (filteredServices.length === 0) {
            tbody.append(`
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Henüz servis yok</h3>
                        <p class="text-gray-500 mb-4">İlk servisinizi eklemek için "Yeni Servis Ekle" butonuna tıklayın.</p>
                        <button onclick="openAddServiceModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            Yeni Servis Ekle
                        </button>
                    </td>
                </tr>
            `);
            return;
        }

        filteredServices.forEach(service => {
            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${service.ServiceName}</div>
                        <div class="text-sm text-gray-500">${service.Description || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${service.RouteName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${service.VehiclePlate || 'Belirtilmemiş'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${service.DriverName || 'Belirtilmemiş'}</div>
                        <div class="text-sm text-gray-500">${service.DriverPhone || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            Kalkış: ${formatTime(service.DepartureTime)}<br>
                            Dönüş: ${formatTime(service.ReturnTime)}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${service.Capacity} kişi
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${service.PersonnelCount || 0} personel
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex gap-2">
                            <button onclick="editService(${service.Id})" class="text-blue-600 hover:text-blue-900">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteService(${service.Id})" class="text-red-600 hover:text-red-900">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    function getFilteredServices() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        
        if (!searchTerm) {
            return services;
        }

        return services.filter(service => 
            service.ServiceName.toLowerCase().includes(searchTerm) ||
            service.RouteName.toLowerCase().includes(searchTerm) ||
            (service.VehiclePlate && service.VehiclePlate.toLowerCase().includes(searchTerm)) ||
            (service.DriverName && service.DriverName.toLowerCase().includes(searchTerm))
        );
    }

    function filterServices() {
        renderServices();
        $('#serviceCount').text(getFilteredServices().length);
    }

    function openAddServiceModal() {
        isEditing = false;
        $('#modalTitle').text('Yeni Servis Ekle');
        $('#serviceForm')[0].reset();
        $('#serviceId').val('');
        $('#serviceModal').removeClass('hidden');
    }

    function editService(serviceId) {
        isEditing = true;
        $('#modalTitle').text('Servis Düzenle');
        
        // Load service data
        $.get('@Url.Action("GetService", "ServiceConfiguration")', { id: serviceId })
            .done(function(response) {
                if (response.success) {
                    const service = response.data;
                    $('#serviceId').val(service.Id);
                    $('#serviceName').val(service.ServiceName);
                    $('#routeName').val(service.RouteName);
                    $('#description').val(service.Description);
                    $('#vehiclePlate').val(service.VehiclePlate);
                    $('#driverName').val(service.DriverName);
                    $('#driverPhone').val(service.DriverPhone);
                    $('#departureTime').val(service.DepartureTime);
                    $('#returnTime').val(service.ReturnTime);
                    $('#capacity').val(service.Capacity);
                    
                    $('#serviceModal').removeClass('hidden');
                } else {
                    alert('Servis bilgileri yüklenemedi: ' + response.message);
                }
            })
            .fail(function() {
                alert('Servis bilgileri yüklenirken hata oluştu.');
            });
    }

    function closeServiceModal() {
        $('#serviceModal').addClass('hidden');
        $('#serviceForm')[0].reset();
    }

    function saveService() {
        const formData = {
            Id: $('#serviceId').val(),
            ServiceName: $('#serviceName').val(),
            RouteName: $('#routeName').val(),
            Description: $('#description').val(),
            VehiclePlate: $('#vehiclePlate').val(),
            DriverName: $('#driverName').val(),
            DriverPhone: $('#driverPhone').val(),
            DepartureTime: $('#departureTime').val(),
            ReturnTime: $('#returnTime').val(),
            Capacity: parseInt($('#capacity').val()) || 50
        };

        if (!formData.ServiceName || !formData.RouteName) {
            alert('Servis adı ve rota adı zorunludur.');
            return;
        }

        const endpoint = isEditing ? 
            '@Url.Action("UpdateService", "ServiceConfiguration")' : 
            '@Url.Action("AddService", "ServiceConfiguration")';

        $.post(endpoint, formData)
            .done(function(response) {
                if (response.success) {
                    alert(response.message);
                    closeServiceModal();
                    loadServices();
                } else {
                    alert(response.message);
                }
            })
            .fail(function() {
                alert('Servis kaydedilirken hata oluştu.');
            });
    }

    function deleteService(serviceId) {
        if (confirm('Bu servisi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
            $.post('@Url.Action("DeleteService", "ServiceConfiguration")', { id: serviceId })
                .done(function(response) {
                    if (response.success) {
                        alert(response.message);
                        loadServices();
                    } else {
                        alert(response.message);
                    }
                })
                .fail(function() {
                    alert('Servis silinirken hata oluştu.');
                });
        }
    }

    function formatTime(timeString) {
        if (!timeString) return 'Belirtilmemiş';
        const time = new Date('1970-01-01T' + timeString);
        return time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    }
</script>
